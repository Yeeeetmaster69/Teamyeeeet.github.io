<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#0b0f0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Handyman SU">
    
    <!-- Cordova/PhoneGap Script -->
    <script type="text/javascript" src="cordova.js"></script>
    
    <title>Handyman Southern Utah Job Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons for different platforms -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512x512.png">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- Geolocation and Maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0f0b;
            color: #e6ffee;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Prevent zoom on iOS */
        input[type="text"], input[type="email"], input[type="tel"], 
        input[type="password"], input[type="number"], textarea, select {
            font-size: 16px !important;
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Mobile-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
                padding-top: env(safe-area-inset-top);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #19a974;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #98bfa7;
            font-size: 1.1rem;
        }

        .panel {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #1f2a1f;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #98bfa7;
            font-weight: 600;
        }

        .input {
            background: #0f1a0f;
            color: #e6ffee;
            border: 1px solid #1f2a1f;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input:focus {
            border-color: #19a974;
        }

        .button {
            cursor: pointer;
            background: #19a974;
            color: #0b0f0b;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }

        .button:hover {
            background: #15a06a;
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button-secondary {
            background: #98bfa7;
            color: #0b0f0b;
        }

        .button-secondary:hover {
            background: #8bb09a;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .job-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #1f2a1f;
            transition: transform 0.3s, border-color 0.3s;
        }

        .job-card:hover {
            transform: translateY(-5px);
            border-color: #19a974;
        }

        .job-title {
            color: #19a974;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .job-info {
            margin-bottom: 15px;
        }

        .job-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #98bfa7;
        }

        .job-info-item strong {
            color: #e6ffee;
        }

        .job-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #ffc107;
            color: #000;
        }

        .status-in-progress {
            background: #17a2b8;
            color: white;
        }

        .status-completed {
            background: #28a745;
            color: white;
        }

        .job-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .job-actions .button {
            flex: 1;
            min-width: 120px;
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
            overflow-y: auto;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .modal-content {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid #1f2a1f;
            position: relative;
            margin: auto;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            cursor: move;
        }

        .modal-content.dragging {
            user-select: none;
        }

        .modal-header {
            cursor: move;
            user-select: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #19a974;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            color: #98bfa7;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .close-button:hover {
            color: #e6ffee;
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #28a745;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #98bfa7;
        }

        .spinner {
            border: 3px solid #1f2a1f;
            border-top: 3px solid #19a974;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #1f2a1f;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #19a974;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            color: #98bfa7;
        }

        .user-info strong {
            color: #19a974;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #1f2a1f;
            padding-bottom: 0;
        }

        .tab-button {
            background: none;
            border: none;
            color: #98bfa7;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button:hover {
            color: #e6ffee;
            background: #1f2a1f;
        }

        .tab-button.active {
            color: #19a974;
            background: #0f1a0f;
            border-bottom: 2px solid #19a974;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #19a974;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        /* Database Status Indicator */
        .db-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #19a974;
            color: #0b0f0b;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0.8;
        }

        .db-status.error {
            background: #dc3545;
            color: white;
        }

        .db-status.syncing {
            background: #ffc107;
            color: #000;
            animation: pulse 1s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .jobs-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .job-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .job-actions .button {
                min-width: auto;
                width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 2px;
            }
            
            .tab-button {
                flex: 1;
                min-width: 100px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .modal-content {
                margin: 10px;
                padding: 20px;
                max-width: calc(100vw - 20px);
            }
            
            .job-card {
                padding: 15px;
            }
            
            .job-title {
                font-size: 1.1rem;
            }
            
            .job-info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .modal-content {
                margin: 5px;
                padding: 15px;
            }
            
            .job-card {
                padding: 12px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .top-bar > div:first-child {
                text-align: center;
            }
        }

        /* Rating Stars */
        .rating-star {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .rating-star:hover {
            color: #ffc107 !important;
            transform: scale(1.1);
        }

        .rating-star.selected {
            color: #ffc107 !important;
        }

        /* In-App Notifications */
        .in-app-notification {
            animation: slideInRight 0.5s ease-out;
        }

        /* Weather Display */
        .weather-info {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #19a974;
        }

        .weather-warning {
            background: #dc3545;
            color: white;
            border-left-color: #dc3545;
        }

        /* Mileage Display */
        .mileage-info {
            background: #1f2a1f;
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-size: 12px;
        }

        /* Geofence and Location Styles */
        .location-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #19a974;
            color: #0b0f0b;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .location-status.outside {
            background: #dc3545;
            color: white;
        }

        .location-status.unknown {
            background: #ffc107;
            color: #000;
        }

        .geofence-info {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #19a974;
        }

        .geofence-warning {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .time-tracker {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #19a974;
        }

        .time-display {
            font-size: 2rem;
            font-weight: 700;
            color: #19a974;
            text-align: center;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .timer-button {
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .timer-start {
            background: #28a745;
            color: white;
        }

        .timer-pause {
            background: #ffc107;
            color: #000;
        }

        .timer-stop {
            background: #dc3545;
            color: white;
        }

        .timer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .earnings-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .earnings-card {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #19a974;
        }

        .earnings-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #19a974;
            margin-bottom: 5px;
        }

        .earnings-label {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        /* Worker Management Styles */
        .worker-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #1f2a1f;
            margin-bottom: 15px;
        }

        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .worker-name {
            color: #19a974;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .worker-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-inactive {
            background: #6c757d;
            color: white;
        }

        .status-working {
            background: #17a2b8;
            color: white;
        }

        .worker-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .worker-stat {
            text-align: center;
            padding: 8px;
            background: #1f2a1f;
            border-radius: 6px;
        }

        .worker-stat-value {
            font-weight: 700;
            color: #19a974;
            font-size: 1.1rem;
        }

        .worker-stat-label {
            color: #98bfa7;
            font-size: 0.8rem;
        }

        /* Goal Tracking */
        .goal-progress {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            color: #19a974;
            font-weight: 600;
        }

        .goal-percentage {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        .progress-bar {
            background: #0f1a0f;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #19a974, #28a745);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #98bfa7;
        }
    </style>
</head>
<body>
    <!-- Database Status Indicator -->
    <div id="dbStatus" class="db-status" style="display: none;">
        💾 Database Ready
    </div>

    <!-- Location Status Indicator -->
    <div id="locationStatus" class="location-status" style="display: none;">
        <span id="locationIcon">📍</span>
        <span id="locationText">Checking location...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>🔧 Handyman Southern Utah Job Tracker</h1>
            <p>Manage your jobs, track time, and get paid</p>
        </div>

        <!-- Loading Screen -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading your jobs...</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="panel login-form" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #19a974;">Welcome Back</h2>
            <div id="loginError" class="error" style="display: none;"></div>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="input" placeholder="Enter your username" autocomplete="username">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <div style="position: relative;">
                    <input type="password" id="password" class="input" placeholder="Enter your password" style="padding-right: 45px;" autocomplete="current-password">
                    <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #98bfa7; cursor: pointer; font-size: 18px; padding: 5px;">👁️</button>
                </div>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; margin-bottom: 0; font-weight: normal; cursor: pointer;">
                    <input type="checkbox" id="rememberDevice" style="margin-right: 8px;">
                    Remember this device
                </label>
            </div>
            
            <button id="loginBtn" class="button">Sign In</button>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #1f2a1f;">
                <p style="color: #98bfa7; margin-bottom: 15px;">Need help with your account?</p>
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button id="forgotPasswordBtn" class="button button-secondary">🔑 Forgot Password</button>
                    <button id="showRegisterBtn" class="button button-secondary">🆕 New Client - Create Account</button>
                    <button id="showNewClientLoginBtn" class="button button-secondary">🏠 Existing Client - First Time Login</button>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <div class="top-bar">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div id="currentDate" style="color: #19a974; font-weight: 600; font-size: 0.9rem;"></div>
                    <div class="user-info">
                        Welcome back, <strong id="userName">Admin</strong>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="requestNotificationBtn" class="button button-secondary" style="position: relative;">
                        🔔 Requests
                        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <button id="testLocationBtn" class="button button-secondary" style="background: #17a2b8;">📍 Test Location</button>
                    <button id="addJobBtn" class="button">+ Add New Job</button>
                    <button id="clientViewBtn" class="button button-secondary">👁️ Client View</button>
                    <button id="logoutBtn" class="button button-secondary">Logout</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalJobs">0</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeJobs">0</div>
                    <div class="stat-label">Active Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedJobs">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarnings">$0.00</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
            </div>

            <!-- Main Navigation Tabs -->
            <div class="tabs">
                <button class="tab-button active" data-section="jobs">📋 Jobs</button>
                <button class="tab-button" data-section="clients">👥 Clients</button>
                <button class="tab-button" data-section="workers">👷 Workers</button>
                <button class="tab-button" data-section="earnings">💰 Earnings</button>
                <button class="tab-button" data-section="time">⏱️ Time Tracker</button>
            </div>

            <!-- Job Section -->
            <div id="jobsSection">
                <!-- Job Tabs -->
                <div class="tabs" style="margin-top: 20px;">
                    <button class="tab-button active" data-tab="all">All Jobs</button>
                    <button class="tab-button" data-tab="active">Active</button>
                    <button class="tab-button" data-tab="upcoming">Upcoming</button>
                    <button class="tab-button" data-tab="completed">Completed</button>
                </div>

                <!-- Jobs Grid -->
                <div id="jobsGrid" class="jobs-grid"></div>
            </div>

            <!-- Clients Section -->
            <div id="clientsSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #19a974; font-size: 1.3rem;">Client Directory</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="addClientBtn" class="button">+ Add New Client</button>
                    </div>
                </div>
                <div id="clientsGrid" class="jobs-grid"></div>
            </div>

            <!-- Workers Section -->
            <div id="workersSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #19a974; font-size: 1.3rem;">👷 Worker Management</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="addWorkerBtn" class="button">+ Add New Worker</button>
                        <button id="manageGoalsBtn" class="button button-secondary">🎯 Manage Goals</button>
                    </div>
                </div>
                
                <!-- Worker Stats Overview -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkers">0</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeWorkers">0</div>
                        <div class="stat-label">Active Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="workingNow">0</div>
                        <div class="stat-label">Working Now</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkerEarnings">$0.00</div>
                        <div class="stat-label">Total Worker Earnings</div>
                    </div>
                </div>

                <div id="workersGrid" class="jobs-grid"></div>
            </div>

            <!-- Earnings Section -->
            <div id="earningsSection" style="display: none;">
                <div style="margin: 20px 0;">
                    <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">💰 Earnings Dashboard</h3>
                    
                    <!-- Completed Earnings -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">✅ Completed Earnings</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="todayEarnings">$0.00</div>
                                <div class="stat-label">Today</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="weekEarnings">$0.00</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="monthEarnings">$0.00</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="sixMonthEarnings">$0.00</div>
                                <div class="stat-label">Last 6 Months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Potential Earnings -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">🎯 Potential Earnings (Upcoming Jobs)</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="potentialTodayEarnings">$0.00</div>
                                <div class="stat-label">Today</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialWeekEarnings">$0.00</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialMonthEarnings">$0.00</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialSixMonthEarnings">$0.00</div>
                                <div class="stat-label">Next 6 Months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Projections -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">📈 Total Projections (Completed + Potential)</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalTodayProjection">$0.00</div>
                                <div class="stat-label">Today Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalWeekProjection">$0.00</div>
                                <div class="stat-label">Week Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalMonthProjection">$0.00</div>
                                <div class="stat-label">Month Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalSixMonthProjection">$0.00</div>
                                <div class="stat-label">6-Month Total</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Tracker Section -->
            <div id="timeSection" style="display: none;">
                <div style="margin: 20px 0;">
                    <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">⏱️ Time Tracker</h3>
                    
                    <!-- Location Status -->
                    <div id="geofenceInfo" class="geofence-info">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 20px;">📍</span>
                            <div>
                                <div style="color: #19a974; font-weight: 600;">Location Status</div>
                                <div id="locationDetails" style="color: #98bfa7; font-size: 14px;">Checking your location...</div>
                            </div>
                        </div>
                        <div id="geofenceWarning" style="display: none; color: #dc3545; font-size: 14px; margin-top: 8px;">
                            ⚠️ You are outside the work area. Time tracking may be restricted.
                        </div>
                    </div>

                    <!-- Current Job Selection -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 15px;">Current Job</h4>
                        <select id="currentJobSelect" class="input" style="margin-bottom: 15px;">
                            <option value="">Select a job to track time</option>
                        </select>
                        
                        <!-- Time Tracker -->
                        <div class="time-tracker">
                            <div class="time-display" id="timeDisplay">00:00:00</div>
                            <div class="timer-controls">
                                <button id="startTimer" class="timer-button timer-start">▶️ Start</button>
                                <button id="pauseTimer" class="timer-button timer-pause" style="display: none;">⏸️ Pause</button>
                                <button id="stopTimer" class="timer-button timer-stop" style="display: none;">⏹️ Stop</button>
                            </div>
                            
                            <div style="margin-top: 15px; text-align: center; color: #98bfa7; font-size: 14px;">
                                <div id="currentJobInfo">No job selected</div>
                                <div id="sessionEarnings" style="color: #19a974; font-weight: 600; margin-top: 5px;">Session Earnings: $0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Summary -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 15px;">Today's Summary</h4>
                        <div class="earnings-summary">
                            <div class="earnings-card">
                                <div class="earnings-amount" id="todayHours">0.0</div>
                                <div class="earnings-label">Hours Worked</div>
                            </div>
                            <div class="earnings-card">
                                <div class="earnings-amount" id="todayJobs">0</div>
                                <div class="earnings-label">Jobs Completed</div>
                            </div>
                            <div class="earnings-card">
                                <div class="earnings-amount" id="todayEarningsTracker">$0.00</div>
                                <div class="earnings-label">Earnings</div>
                            </div>
                            <div class="earnings-card">
                                <div class="earnings-amount" id="avgHourlyRate">$0.00</div>
                                <div class="earnings-label">Avg Rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Goals Progress -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 15px;">Goals Progress</h4>
                        <div id="goalsProgress">
                            <!-- Goals will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Portal -->
        <div id="clientPortal" style="display: none;">
            <div class="container">
                <div class="header">
                    <h1>🏠 My Home Services</h1>
                    <p>All your service needs in one place</p>
                </div>

                <div class="top-bar">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div id="clientCurrentDate" style="color: #19a974; font-weight: 600; font-size: 0.9rem;"></div>
                        <div class="user-info">
                            Welcome, <strong id="clientUserName">Client</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="callHandyman()" class="button" style="background: #28a745;">📞 Call Now</button>
                        <button onclick="textHandyman()" class="button" style="background: #17a2b8;">💬 Text Now</button>
                        <button id="requestEstimateBtn" class="button">📋 Request Estimate</button>
                        <button id="scheduleServiceBtn" class="button">🔧 Schedule Service</button>
                        <button id="testNotificationBtn" class="button" style="background: #ffc107; color: #000;">🧪 Test Notification</button>
                        <button id="returnToAdminBtn" class="button" style="display: none;">🔙 Return to Admin</button>
                        <button id="clientLogoutBtn" class="button button-secondary">Logout</button>
                    </div>
                </div>

                <!-- Client Stats -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="clientTotalServices">0</div>
                        <div class="stat-label">Total Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientActiveServices">0</div>
                        <div class="stat-label">Active Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientCompletedServices">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientTotalSpent">$0.00</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                </div>

                <!-- Client Navigation Tabs -->
                <div class="tabs">
                    <button class="tab-button active" data-client-section="services">🔧 My Services</button>
                    <button class="tab-button" data-client-section="browse">🛠️ Browse Services</button>
                    <button class="tab-button" data-client-section="estimates">📋 Estimates</button>
                    <button class="tab-button" data-client-section="profile">👤 My Profile</button>
                </div>

                <!-- Services Section -->
                <div id="clientServicesSection">
                    <div class="tabs" style="margin-top: 20px;">
                        <button class="tab-button active" data-client-tab="all">All Services</button>
                        <button class="tab-button" data-client-tab="upcoming">Upcoming</button>
                        <button class="tab-button" data-client-tab="active">In Progress</button>
                        <button class="tab-button" data-client-tab="completed">Completed</button>
                    </div>

                    <div id="clientServicesGrid" class="jobs-grid"></div>
                </div>

                <!-- Browse Services Section -->
                <div id="clientBrowseSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">🛠️ Available Services</h3>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #1f2a1f; border-radius: 8px;">
                            <div style="color: #19a974; font-weight: 600; margin-bottom: 8px;">📋 Browse Our Services</div>
                            <div style="color: #98bfa7; font-size: 14px; line-height: 1.5;">
                                Browse our available services and request estimates or schedule appointments. You can also submit a custom request if you don't see what you need.
                            </div>
                        </div>

                        <!-- Custom Request Section -->
                        <div class="panel" style="margin-bottom: 20px;">
                            <h4 style="color: #19a974; margin-bottom: 15px;">✍️ Custom Service Request</h4>
                            <div style="margin-bottom: 15px; color: #98bfa7; font-size: 14px;">
                                Don't see what you need? Describe your custom service request below:
                            </div>
                            
                            <div class="form-group">
                                <label for="customServiceTitle">Service Title *</label>
                                <input type="text" id="customServiceTitle" class="input" placeholder="e.g., Custom deck repair">
                            </div>
                            
                            <div class="form-group">
                                <label for="customServiceDescription">Description *</label>
                                <textarea id="customServiceDescription" class="input" rows="4" placeholder="Please describe what you need done in detail..."></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="customServiceUrgency">Urgency Level</label>
                                    <select id="customServiceUrgency" class="input">
                                        <option value="low">Low - Within 2 weeks</option>
                                        <option value="medium">Medium - Within 1 week</option>
                                        <option value="high">High - Within 2-3 days</option>
                                        <option value="emergency">Emergency - ASAP</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="customServiceDate">Preferred Date</label>
                                    <input type="date" id="customServiceDate" class="input">
                                </div>
                            </div>
                            
                            <button onclick="submitCustomServiceRequest()" class="button" style="width: 100%; margin-top: 15px;">
                                📋 Submit Custom Request
                            </button>
                        </div>
                        
                        <div id="clientBrowseGrid" class="jobs-grid"></div>
                    </div>
                </div>

                <!-- Estimates Section -->
                <div id="clientEstimatesSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">📋 My Estimates</h3>
                        <div id="clientEstimatesGrid" class="jobs-grid"></div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="clientProfileSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">👤 My Profile</h3>
                        
                        <div class="panel">
                            <h4 style="color: #19a974; margin-bottom: 20px;">Contact Information</h4>
                            <div id="clientProfileInfo" class="job-info">
                                <!-- Profile info will be populated here -->
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button id="editProfileBtn" class="button">Edit Profile</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Requests Modal -->
        <div id="clientRequestsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">🔔 Client Requests</h3>
                    <button class="close-button" onclick="closeRequestsModal()">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600;">Manage client requests for estimates and services</div>
                        <div style="display: flex; gap: 10px;">
                            <button id="markAllReadBtn" class="button button-secondary" style="padding: 6px 12px; font-size: 14px;">Mark All Read</button>
                            <button id="clearProcessedBtn" class="button button-secondary" style="padding: 6px 12px; font-size: 14px;">Clear Processed</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="requestStatusFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Requests</option>
                            <option value="pending">Pending Only</option>
                            <option value="processed">Processed Only</option>
                        </select>
                        <select id="requestTypeFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Types</option>
                            <option value="estimate">Estimates</option>
                            <option value="service">Services</option>
                        </select>
                        <select id="requestUrgencyFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Urgency</option>
                            <option value="emergency">Emergency</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                
                <div id="requestsList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Requests will be populated here -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeRequestsModal()" class="button button-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Request Estimate Modal -->
        <div id="requestEstimateModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">📋 Request Estimate</h3>
                    <button class="close-button" onclick="closeEstimateModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="estimateTitle">Service Needed *</label>
                    <input type="text" id="estimateTitle" class="input" placeholder="e.g., Kitchen faucet repair">
                </div>
                
                <div class="form-group">
                    <label for="estimateDescription">Description</label>
                    <textarea id="estimateDescription" class="input" rows="4" placeholder="Please describe what needs to be done..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="estimateUrgency">Urgency Level</label>
                    <select id="estimateUrgency" class="input">
                        <option value="low">Low - Within 2 weeks</option>
                        <option value="medium">Medium - Within 1 week</option>
                        <option value="high">High - Within 2-3 days</option>
                        <option value="emergency">Emergency - ASAP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="estimatePreferredDate">Preferred Date for Estimate</label>
                    <input type="date" id="estimatePreferredDate" class="input">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeEstimateModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="submitEstimateRequest()" class="button" style="flex: 1;">Submit Request</button>
                </div>
            </div>
        </div>

        <!-- Schedule Service Modal -->
        <div id="scheduleServiceModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">🔧 Schedule Service</h3>
                    <button class="close-button" onclick="closeServiceModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="serviceTitle">Service Title *</label>
                    <input type="text" id="serviceTitle" class="input" placeholder="e.g., Monthly lawn maintenance">
                </div>
                
                <div class="form-group">
                    <label for="serviceDescription">Service Description</label>
                    <textarea id="serviceDescription" class="input" rows="4" placeholder="Please describe the service needed..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="serviceDate">Preferred Service Date *</label>
                    <input type="datetime-local" id="serviceDate" class="input">
                </div>
                
                <div class="form-group">
                    <label for="serviceRecurring">Recurring Service</label>
                    <select id="serviceRecurring" class="input">
                        <option value="">One-time service</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 weeks</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeServiceModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="submitServiceRequest()" class="button" style="flex: 1;">Schedule Service</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== ROBUST DATABASE SYSTEM =====
        
        class HandymanDatabase {
            constructor() {
                this.dbName = 'HandymanSouthernUtahDB';
                this.version = 1.0;
                this.tables = {
                    jobs: 'handyman_jobs',
                    clients: 'handyman_clients', 
                    users: 'handyman_users',
                    workers: 'handyman_workers',
                    timeEntries: 'handyman_time_entries',
                    estimates: 'handyman_estimates',
                    clientRequests: 'handyman_client_requests',
                    serviceCatalog: 'handyman_service_catalog',
                    jobTemplates: 'handyman_job_templates',
                    workerGoals: 'handyman_worker_goals',
                    appSettings: 'handyman_app_settings',
                    geofences: 'handyman_geofences',
                    locationLogs: 'handyman_location_logs',
                    backups: 'handyman_backups'
                };
                this.init();
            }

            init() {
                console.log('🗄️ Initializing Handyman Database System...');
                this.createDefaultData();
            }

            createDefaultData() {
                // Create default admin user if none exists
                const users = this.load('users');
                if (!users || users.length === 0) {
                    const defaultUsers = [
                        {
                            id: 1,
                            username: 'admin',
                            password: 'admin123',
                            name: 'Admin User',
                            role: 'admin',
                            email: 'admin@handymansouthernutah.com',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('users', defaultUsers);
                }

                // Create default workers if none exist
                const workers = this.load('workers');
                if (!workers || workers.length === 0) {
                    const defaultWorkers = [
                        {
                            id: 1,
                            name: 'John Smith',
                            email: 'john@handymansouthernutah.com',
                            phone: '555-0101',
                            hourlyRate: 25.00,
                            status: 'active',
                            skills: ['Plumbing', 'Electrical', 'General Repair'],
                            hireDate: '2024-01-01',
                            totalEarnings: 2450.00,
                            hoursWorked: 98,
                            jobsCompleted: 15,
                            currentlyWorking: false,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: 'Mike Johnson',
                            email: 'mike@handymansouthernutah.com',
                            phone: '555-0102',
                            hourlyRate: 30.00,
                            status: 'active',
                            skills: ['Carpentry', 'Painting', 'Drywall'],
                            hireDate: '2024-01-15',
                            totalEarnings: 1800.00,
                            hoursWorked: 60,
                            jobsCompleted: 12,
                            currentlyWorking: true,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('workers', defaultWorkers);
                }

                // Create default geofences if none exist
                const geofences = this.load('geofences');
                if (!geofences || geofences.length === 0) {
                    const defaultGeofences = [
                        {
                            id: 1,
                            name: 'Main Work Area - St. George',
                            centerLat: 37.0965,
                            centerLng: -113.5684,
                            radius: 50000, // 50km radius
                            active: true,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: 'Cedar City Area',
                            centerLat: 37.6781,
                            centerLng: -113.0618,
                            radius: 30000, // 30km radius
                            active: true,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('geofences', defaultGeofences);
                }

                // Create default goals if none exist
                const goals = this.load('workerGoals');
                if (!goals || goals.length === 0) {
                    const defaultGoals = [
                        {
                            id: 1,
                            workerId: null, // Company-wide goal
                            title: 'Monthly Revenue Target',
                            type: 'revenue',
                            target: 5000,
                            current: 3250,
                            period: 'monthly',
                            startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString(),
                            endDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString(),
                            active: true
                        },
                        {
                            id: 2,
                            workerId: 1,
                            title: 'Weekly Hours Goal',
                            type: 'hours',
                            target: 40,
                            current: 28,
                            period: 'weekly',
                            startDate: new Date().toISOString(),
                            endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            active: true
                        }
                    ];
                    this.save('workerGoals', defaultGoals);
                }

                // Initialize other tables
                if (!this.load('jobs')) this.save('jobs', []);
                if (!this.load('clients')) this.save('clients', []);
                if (!this.load('estimates')) this.save('estimates', []);
                if (!this.load('clientRequests')) this.save('clientRequests', []);
                if (!this.load('timeEntries')) this.save('timeEntries', []);
                if (!this.load('locationLogs')) this.save('locationLogs', []);
            }

            save(table, data) {
                try {
                    const key = this.tables[table];
                    if (!key) {
                        throw new Error(`Unknown table: ${table}`);
                    }
                    
                    const serialized = JSON.stringify(data);
                    localStorage.setItem(key, serialized);
                    
                    console.log(`💾 Saved ${Array.isArray(data) ? data.length : 1} records to ${table}`);
                    return true;
                } catch (error) {
                    console.error(`❌ Failed to save to ${table}:`, error);
                    return false;
                }
            }

            load(table) {
                try {
                    const key = this.tables[table];
                    if (!key) {
                        throw new Error(`Unknown table: ${table}`);
                    }
                    
                    const data = localStorage.getItem(key);
                    if (!data) {
                        console.log(`📂 No data found for ${table}, returning empty array`);
                        return [];
                    }
                    
                    const parsed = JSON.parse(data);
                    console.log(`📂 Loaded ${Array.isArray(parsed) ? parsed.length : 1} records from ${table}`);
                    return parsed;
                } catch (error) {
                    console.error(`❌ Failed to load from ${table}:`, error);
                    return [];
                }
            }

            addClientRequest(request) {
                console.log('📝 Adding new client request:', request);
                const requests = this.load('clientRequests');
                request.id = Date.now() + Math.random(); // Ensure unique ID
                request.createdAt = new Date().toISOString();
                request.status = 'pending';
                request.read = false;
                requests.push(request);
                
                const saved = this.save('clientRequests', requests);
                console.log('💾 Client request saved:', saved);
                
                // Update notification count immediately
                setTimeout(() => {
                    this.updateNotificationCount();
                    console.log('🔔 Notification count updated');
                }, 100);
                
                return request;
            }

            updateNotificationCount() {
                const requests = this.load('clientRequests');
                const unreadCount = requests.filter(r => !r.read && r.status === 'pending').length;
                
                console.log(`🔔 Updating notification count: ${unreadCount} unread requests`);
                
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'flex';
                        console.log(`✅ Badge updated: ${unreadCount} notifications`);
                    } else {
                        badge.style.display = 'none';
                        console.log('✅ Badge hidden: no notifications');
                    }
                } else {
                    console.log('⚠️ Notification badge element not found');
                }
                
                return unreadCount;
            }

            getClientRequests(filters = {}) {
                let requests = this.load('clientRequests');
                
                if (filters.status) {
                    requests = requests.filter(r => r.status === filters.status);
                }
                
                if (filters.type) {
                    requests = requests.filter(r => r.type === filters.type);
                }
                
                if (filters.urgency) {
                    requests = requests.filter(r => r.urgency === filters.urgency);
                }
                
                return requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            markRequestAsRead(requestId) {
                const requests = this.load('clientRequests');
                const request = requests.find(r => r.id === requestId);
                if (request) {
                    request.read = true;
                    this.save('clientRequests', requests);
                    this.updateNotificationCount();
                }
            }

            markRequestAsProcessed(requestId) {
                const requests = this.load('clientRequests');
                const request = requests.find(r => r.id === requestId);
                if (request) {
                    request.status = 'processed';
                    request.processedAt = new Date().toISOString();
                    this.save('clientRequests', requests);
                    this.updateNotificationCount();
                }
            }
        }

        // Initialize database
        const db = new HandymanDatabase();
        let currentUser = null;
        let currentClientUser = null;
        let isClientView = false;

        // Geolocation and Time Tracking
        let currentLocation = null;
        let locationWatcher = null;
        let isInsideGeofence = false;
        let timeTracker = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            pausedTime: 0,
            currentJobId: null,
            sessionSeconds: 0,
            interval: null
        };

        // App initialization
        function initApp() {
            console.log('🚀 Initializing Handyman App...');
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                console.log('✅ App initialized successfully');
            }, 1000);

            setupEventListeners();
            updateCurrentDate();
            
            // Update notification count on load
            db.updateNotificationCount();
        }

        function setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Main app buttons
            document.getElementById('addJobBtn').addEventListener('click', () => {
                alert('Add Job functionality - coming soon!');
            });
            
            document.getElementById('addClientBtn').addEventListener('click', () => {
                alert('Add Client functionality - coming soon!');
            });

            document.getElementById('addWorkerBtn').addEventListener('click', () => {
                alert('Add Worker functionality - coming soon!');
            });

            document.getElementById('manageGoalsBtn').addEventListener('click', () => {
                alert('Manage Goals functionality - coming soon!');
            });
            
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('clientViewBtn').addEventListener('click', showClientView);
            
            // Client requests
            document.getElementById('requestNotificationBtn').addEventListener('click', showClientRequests);
            
            // Debug buttons
            document.getElementById('testLocationBtn').addEventListener('click', testLocationSystem);
            document.getElementById('testNotificationBtn').addEventListener('click', testNotificationSystem);
            
            // Time tracker controls
            document.getElementById('startTimer').addEventListener('click', startTimeTracking);
            document.getElementById('pauseTimer').addEventListener('click', pauseTimeTracking);
            document.getElementById('stopTimer').addEventListener('click', stopTimeTracking);
            document.getElementById('currentJobSelect').addEventListener('change', selectCurrentJob);
            
            // Client portal buttons
            document.getElementById('requestEstimateBtn').addEventListener('click', showEstimateModal);
            document.getElementById('scheduleServiceBtn').addEventListener('click', showServiceModal);
            document.getElementById('clientLogoutBtn').addEventListener('click', handleClientLogout);
            document.getElementById('returnToAdminBtn').addEventListener('click', returnToAdmin);

            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const tab = e.target.dataset.tab;
                    const clientSection = e.target.dataset.clientSection;
                    const clientTab = e.target.dataset.clientTab;
                    
                    if (section) {
                        switchSection(section);
                    } else if (tab) {
                        switchJobTab(tab);
                    } else if (clientSection) {
                        switchClientSection(clientSection);
                    } else if (clientTab) {
                        switchClientTab(clientTab);
                    }
                });
            });

            // Enter key for login
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'Please enter both username and password');
                return;
            }

            const users = db.load('users');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginForm').style.display = 'none';
                
                if (user.role === 'client') {
                    // Show client portal
                    currentClientUser = user;
                    showClientPortal();
                } else {
                    // Show admin app
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userName').textContent = user.name;
                    loadDashboard();
                }
            } else {
                showError(errorDiv, 'Invalid username or password');
            }
        }

        function handleLogout() {
            currentUser = null;
            currentClientUser = null;
            isClientView = false;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function handleClientLogout() {
            handleLogout();
        }

        function showClientView() {
            // For demo purposes, show client portal directly
            // In real app, you'd select which client to view as
            isClientView = true;
            document.getElementById('mainApp').style.display = 'none';
            showClientPortal();
            document.getElementById('returnToAdminBtn').style.display = 'inline-block';
        }

        function returnToAdmin() {
            isClientView = false;
            document.getElementById('clientPortal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('returnToAdminBtn').style.display = 'none';
        }

        function showClientPortal() {
            document.getElementById('clientPortal').style.display = 'block';
            document.getElementById('clientCurrentDate').textContent = document.getElementById('currentDate').textContent;
            
            if (currentClientUser) {
                document.getElementById('clientUserName').textContent = currentClientUser.name;
            } else {
                document.getElementById('clientUserName').textContent = 'Demo Client';
            }
            
            loadClientDashboard();
        }

        function loadDashboard() {
            updateStats();
            loadJobs();
            loadClients();
            loadWorkers();
            initializeGeolocation();
            loadJobsForTimeTracker();
            updateTimeTrackerDisplay();
            loadGoalsProgress();
            db.updateNotificationCount();
        }

        // ===== GEOLOCATION SYSTEM =====
        
        function initializeGeolocation() {
            console.log('🌍 Initializing geolocation system...');
            
            if (!navigator.geolocation) {
                console.error('❌ Geolocation not supported by this browser');
                updateLocationStatus('❌', 'Location not supported', 'unknown');
                return;
            }

            updateLocationStatus('🔍', 'Getting location...', 'unknown');
            
            // Get initial position with better error handling
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('✅ Initial location obtained:', position.coords);
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('📍 Current location:', currentLocation);
                    checkGeofenceStatus();
                    logLocation();
                    
                    // Start watching position
                    startLocationWatcher();
                },
                (error) => {
                    console.error('❌ Geolocation error:', error);
                    let errorMessage = 'Location error';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location timeout';
                            break;
                        default:
                            errorMessage = 'Unknown location error';
                            break;
                    }
                    
                    updateLocationStatus('❌', errorMessage, 'unknown');
                    
                    // For demo purposes, use a default location (St. George, UT)
                    console.log('🎭 Using demo location for testing');
                    currentLocation = {
                        lat: 37.0965,
                        lng: -113.5684,
                        accuracy: 100,
                        timestamp: new Date().toISOString(),
                        isDemo: true
                    };
                    
                    setTimeout(() => {
                        updateLocationStatus('🎭', 'Using demo location', 'inside');
                        checkGeofenceStatus();
                    }, 2000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        function startLocationWatcher() {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
                console.log('🔄 Cleared previous location watcher');
            }

            console.log('👀 Starting location watcher...');
            
            locationWatcher = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('📍 Location update received:', position.coords);
                    
                    // Only update if location has changed significantly (more than 10 meters)
                    if (currentLocation) {
                        const distance = calculateDistance(
                            currentLocation.lat, currentLocation.lng,
                            position.coords.latitude, position.coords.longitude
                        );
                        
                        if (distance < 10 && !currentLocation.isDemo && !currentLocation.isTest) {
                            console.log('📍 Location change too small, skipping update');
                            return;
                        }
                    }
                    
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('📍 Location updated:', currentLocation);
                    checkGeofenceStatus();
                    
                    // Log location every 5 minutes
                    const lastLog = localStorage.getItem('lastLocationLog');
                    const now = Date.now();
                    if (!lastLog || now - parseInt(lastLog) > 300000) { // 5 minutes
                        logLocation();
                        localStorage.setItem('lastLocationLog', now.toString());
                    }
                },
                (error) => {
                    console.error('❌ Location watch error:', error);
                    let errorMessage = 'Location tracking interrupted';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location timeout';
                            break;
                    }
                    
                    updateLocationStatus('⚠️', errorMessage, 'unknown');
                },
                {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 120000
                }
            );
            
            console.log('✅ Location watcher started');
        }

        function checkGeofenceStatus() {
            if (!currentLocation) {
                console.log('⚠️ No current location available for geofence check');
                return;
            }

            console.log('🔍 Checking geofence status for location:', currentLocation);
            
            const geofences = db.load('geofences');
            const activeGeofences = geofences.filter(g => g.active);
            
            console.log('📍 Active geofences:', activeGeofences);
            
            if (activeGeofences.length === 0) {
                console.log('⚠️ No active geofences found');
                updateLocationStatus('⚠️', 'No work areas defined', 'unknown');
                return;
            }
            
            let insideAny = false;
            let closestGeofence = null;
            let minDistance = Infinity;
            let currentGeofence = null;

            for (const geofence of activeGeofences) {
                const distance = calculateDistance(
                    currentLocation.lat, 
                    currentLocation.lng,
                    geofence.centerLat, 
                    geofence.centerLng
                );

                console.log(`📏 Distance to ${geofence.name}: ${(distance/1000).toFixed(2)}km (radius: ${(geofence.radius/1000).toFixed(2)}km)`);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestGeofence = geofence;
                }

                if (distance <= geofence.radius) {
                    insideAny = true;
                    currentGeofence = geofence;
                    console.log(`✅ Inside geofence: ${geofence.name}`);
                    break;
                }
            }

            const wasInside = isInsideGeofence;
            isInsideGeofence = insideAny;

            if (insideAny && currentGeofence) {
                updateLocationStatus('✅', `Inside ${currentGeofence.name}`, 'inside');
                hideGeofenceWarning();
                console.log('✅ User is inside work area');
            } else if (closestGeofence) {
                const distanceKm = (minDistance / 1000).toFixed(1);
                updateLocationStatus('📍', `${distanceKm}km from ${closestGeofence.name}`, 'outside');
                showGeofenceWarning();
                console.log(`📍 User is ${distanceKm}km from nearest work area`);
            } else {
                updateLocationStatus('❓', 'Location status unknown', 'unknown');
                console.log('❓ Could not determine location status');
            }

            // Log geofence status change
            if (wasInside !== isInsideGeofence) {
                console.log(`🔄 Geofence status changed: ${wasInside ? 'inside' : 'outside'} → ${isInsideGeofence ? 'inside' : 'outside'}`);
            }

            // Update location details in time tracker
            updateLocationDetails();
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateLocationStatus(icon, text, status) {
            const statusEl = document.getElementById('locationStatus');
            const iconEl = document.getElementById('locationIcon');
            const textEl = document.getElementById('locationText');
            
            if (statusEl && iconEl && textEl) {
                iconEl.textContent = icon;
                textEl.textContent = text;
                
                statusEl.className = 'location-status';
                if (status === 'outside') {
                    statusEl.classList.add('outside');
                } else if (status === 'unknown') {
                    statusEl.classList.add('unknown');
                }
                
                statusEl.style.display = 'flex';
            }
        }

        function updateLocationDetails() {
            const detailsEl = document.getElementById('locationDetails');
            if (!detailsEl || !currentLocation) return;

            const accuracy = currentLocation.accuracy ? `±${Math.round(currentLocation.accuracy)}m` : 'Unknown accuracy';
            const timestamp = new Date(currentLocation.timestamp).toLocaleTimeString();
            
            detailsEl.innerHTML = `
                Location: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}<br>
                Accuracy: ${accuracy} • Updated: ${timestamp}
            `;
        }

        function showGeofenceWarning() {
            const warningEl = document.getElementById('geofenceWarning');
            if (warningEl) {
                warningEl.style.display = 'block';
            }
            
            const geofenceInfo = document.getElementById('geofenceInfo');
            if (geofenceInfo) {
                geofenceInfo.classList.add('geofence-warning');
            }
        }

        function hideGeofenceWarning() {
            const warningEl = document.getElementById('geofenceWarning');
            if (warningEl) {
                warningEl.style.display = 'none';
            }
            
            const geofenceInfo = document.getElementById('geofenceInfo');
            if (geofenceInfo) {
                geofenceInfo.classList.remove('geofence-warning');
            }
        }

        function logLocation() {
            if (!currentLocation) return;

            const logs = db.load('locationLogs');
            const logEntry = {
                id: Date.now(),
                ...currentLocation,
                insideGeofence: isInsideGeofence,
                userId: currentUser ? currentUser.id : null
            };
            
            logs.push(logEntry);
            
            // Keep only last 1000 location logs
            if (logs.length > 1000) {
                logs.splice(0, logs.length - 1000);
            }
            
            db.save('locationLogs', logs);
        }

        // ===== TIME TRACKING SYSTEM =====
        
        function loadJobsForTimeTracker() {
            const jobs = db.load('jobs');
            const activeJobs = jobs.filter(j => j.status !== 'completed');
            const select = document.getElementById('currentJobSelect');
            
            if (select) {
                select.innerHTML = '<option value="">Select a job to track time</option>';
                activeJobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.id;
                    option.textContent = `${job.title} - ${job.clientName || 'No client'}`;
                    select.appendChild(option);
                });
            }
        }

        function selectCurrentJob() {
            const select = document.getElementById('currentJobSelect');
            const jobId = select.value;
            
            if (jobId) {
                timeTracker.currentJobId = parseInt(jobId);
                const jobs = db.load('jobs');
                const job = jobs.find(j => j.id === timeTracker.currentJobId);
                
                if (job) {
                    document.getElementById('currentJobInfo').textContent = 
                        `Selected: ${job.title} (${job.clientName || 'No client'}) - $${job.hourlyRate || 0}/hr`;
                }
            } else {
                timeTracker.currentJobId = null;
                document.getElementById('currentJobInfo').textContent = 'No job selected';
            }
            
            updateSessionEarnings();
        }

        function startTimeTracking() {
            if (!timeTracker.currentJobId) {
                alert('Please select a job first');
                return;
            }

            if (!isInsideGeofence) {
                if (!confirm('You are outside the work area. Start tracking anyway?')) {
                    return;
                }
            }

            timeTracker.isRunning = true;
            timeTracker.isPaused = false;
            timeTracker.startTime = Date.now() - timeTracker.pausedTime;
            
            // Update UI
            document.getElementById('startTimer').style.display = 'none';
            document.getElementById('pauseTimer').style.display = 'inline-block';
            document.getElementById('stopTimer').style.display = 'inline-block';
            
            // Start the timer interval
            timeTracker.interval = setInterval(updateTimeDisplay, 1000);
            
            console.log('⏱️ Time tracking started for job:', timeTracker.currentJobId);
        }

        function pauseTimeTracking() {
            if (!timeTracker.isRunning) return;

            timeTracker.isPaused = true;
            timeTracker.pausedTime = Date.now() - timeTracker.startTime;
            
            clearInterval(timeTracker.interval);
            
            // Update UI
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = '▶️ Resume';
            
            console.log('⏸️ Time tracking paused');
        }

        function stopTimeTracking() {
            if (!timeTracker.isRunning && !timeTracker.isPaused) return;

            const totalSeconds = timeTracker.isPaused ? 
                Math.floor(timeTracker.pausedTime / 1000) : 
                Math.floor((Date.now() - timeTracker.startTime) / 1000);

            if (totalSeconds < 60) {
                if (!confirm('Session is less than 1 minute. Save anyway?')) {
                    return;
                }
            }

            // Save time entry
            saveTimeEntry(totalSeconds);
            
            // Reset tracker
            timeTracker.isRunning = false;
            timeTracker.isPaused = false;
            timeTracker.startTime = null;
            timeTracker.pausedTime = 0;
            timeTracker.sessionSeconds = 0;
            
            clearInterval(timeTracker.interval);
            
            // Update UI
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('stopTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = '▶️ Start';
            document.getElementById('timeDisplay').textContent = '00:00:00';
            document.getElementById('sessionEarnings').textContent = 'Session Earnings: $0.00';
            
            // Refresh displays
            updateTimeTrackerDisplay();
            loadGoalsProgress();
            
            showSuccess(`Time entry saved: ${formatTime(totalSeconds)}`);
            console.log('⏹️ Time tracking stopped, entry saved');
        }

        function saveTimeEntry(totalSeconds) {
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === timeTracker.currentJobId);
            
            if (!job) return;

            const timeEntries = db.load('timeEntries');
            const hours = totalSeconds / 3600;
            const earnings = hours * (job.hourlyRate || 0);
            
            const entry = {
                id: Date.now(),
                jobId: timeTracker.currentJobId,
                jobTitle: job.title,
                clientName: job.clientName,
                workerId: currentUser ? currentUser.id : null,
                workerName: currentUser ? currentUser.name : 'Unknown',
                startTime: new Date(timeTracker.startTime).toISOString(),
                endTime: new Date().toISOString(),
                totalSeconds: totalSeconds,
                hours: parseFloat(hours.toFixed(2)),
                hourlyRate: job.hourlyRate || 0,
                earnings: parseFloat(earnings.toFixed(2)),
                location: currentLocation,
                insideGeofence: isInsideGeofence,
                createdAt: new Date().toISOString()
            };
            
            timeEntries.push(entry);
            db.save('timeEntries', timeEntries);
            
            // Update job total time and earnings
            job.totalHours = (job.totalHours || 0) + hours;
            job.totalEarnings = (job.totalEarnings || 0) + earnings;
            job.lastWorked = new Date().toISOString();
            
            db.save('jobs', jobs);
        }

        function updateTimeDisplay() {
            if (!timeTracker.isRunning || timeTracker.isPaused) return;

            const elapsed = Date.now() - timeTracker.startTime;
            const seconds = Math.floor(elapsed / 1000);
            
            timeTracker.sessionSeconds = seconds;
            document.getElementById('timeDisplay').textContent = formatTime(seconds);
            
            updateSessionEarnings();
        }

        function updateSessionEarnings() {
            if (!timeTracker.currentJobId) {
                document.getElementById('sessionEarnings').textContent = 'Session Earnings: $0.00';
                return;
            }

            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === timeTracker.currentJobId);
            
            if (job) {
                const hours = timeTracker.sessionSeconds / 3600;
                const earnings = hours * (job.hourlyRate || 0);
                document.getElementById('sessionEarnings').textContent = 
                    `Session Earnings: $${earnings.toFixed(2)}`;
            }
        }

        function updateTimeTrackerDisplay() {
            const timeEntries = db.load('timeEntries');
            const today = new Date().toDateString();
            
            const todayEntries = timeEntries.filter(entry => 
                new Date(entry.createdAt).toDateString() === today
            );
            
            const todayHours = todayEntries.reduce((sum, entry) => sum + entry.hours, 0);
            const todayEarnings = todayEntries.reduce((sum, entry) => sum + entry.earnings, 0);
            const todayJobs = new Set(todayEntries.map(entry => entry.jobId)).size;
            const avgRate = todayHours > 0 ? todayEarnings / todayHours : 0;
            
            document.getElementById('todayHours').textContent = todayHours.toFixed(1);
            document.getElementById('todayJobs').textContent = todayJobs;
            document.getElementById('todayEarningsTracker').textContent = `$${todayEarnings.toFixed(2)}`;
            document.getElementById('avgHourlyRate').textContent = `$${avgRate.toFixed(2)}`;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function loadClientDashboard() {
            updateClientStats();
            loadClientServices();
        }

        function updateStats() {
            const jobs = db.load('jobs');
            const completedJobs = jobs.filter(j => j.status === 'completed');
            const activeJobs = jobs.filter(j => j.status === 'in-progress');
            
            const totalEarnings = completedJobs.reduce((sum, job) => {
                return sum + (parseFloat(job.totalCost) || 0);
            }, 0);

            document.getElementById('totalJobs').textContent = jobs.length;
            document.getElementById('activeJobs').textContent = activeJobs.length;
            document.getElementById('completedJobs').textContent = completedJobs.length;
            document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
        }

        function updateClientStats() {
            // Demo client stats
            document.getElementById('clientTotalServices').textContent = '5';
            document.getElementById('clientActiveServices').textContent = '2';
            document.getElementById('clientCompletedServices').textContent = '3';
            document.getElementById('clientTotalSpent').textContent = '$450.00';
        }

        function loadJobs() {
            const grid = document.getElementById('jobsGrid');
            const jobs = db.load('jobs');

            if (jobs.length === 0) {
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📋</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Jobs Found</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            Get started by adding your first job!
                        </p>
                        <button onclick="alert('Add Job functionality coming soon!')" class="button">+ Add Your First Job</button>
                    </div>
                `;
                return;
            }

            // Display jobs (simplified for demo)
            grid.innerHTML = jobs.map(job => `
                <div class="job-card">
                    <div class="job-title">${job.title}</div>
                    <div class="job-status status-${job.status}">${getStatusText(job.status)}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Client:</span>
                            <strong>${job.clientName || 'Not assigned'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Rate:</span>
                            <strong>$${job.hourlyRate || '0'}/hr</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadClients() {
            const grid = document.getElementById('clientsGrid');
            const clients = db.load('clients');

            if (clients.length === 0) {
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Clients Yet</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            Add your first client to get started!
                        </p>
                        <button onclick="alert('Add Client functionality coming soon!')" class="button">+ Add Your First Client</button>
                    </div>
                `;
                return;
            }

            // Display clients
            grid.innerHTML = clients.map(client => `
                <div class="job-card">
                    <div class="job-title">${client.name}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Phone:</span>
                            <strong>${client.phone || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Email:</span>
                            <strong>${client.email || 'Not provided'}</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadClientServices() {
            const grid = document.getElementById('clientServicesGrid');
            
            // Demo services for client
            const demoServices = [
                {
                    title: 'Kitchen Faucet Repair',
                    status: 'completed',
                    date: '2024-01-15',
                    cost: '$85.00'
                },
                {
                    title: 'Bathroom Tile Replacement',
                    status: 'in-progress',
                    date: '2024-01-20',
                    cost: '$250.00'
                },
                {
                    title: 'Deck Staining',
                    status: 'pending',
                    date: '2024-01-25',
                    cost: '$180.00'
                }
            ];

            grid.innerHTML = demoServices.map(service => `
                <div class="job-card">
                    <div class="job-title">${service.title}</div>
                    <div class="job-status status-${service.status}">${getStatusText(service.status)}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Date:</span>
                            <strong>${formatDate(service.date)}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Cost:</span>
                            <strong>${service.cost}</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showClientRequests() {
            console.log('🔔 Opening client requests modal...');
            
            const allRequests = db.getClientRequests();
            console.log(`📋 Total requests found: ${allRequests.length}`);
            
            const modal = document.getElementById('clientRequestsModal');
            const requestsList = document.getElementById('requestsList');
            
            // Apply filters
            const statusFilter = document.getElementById('requestStatusFilter')?.value || '';
            const typeFilter = document.getElementById('requestTypeFilter')?.value || '';
            const urgencyFilter = document.getElementById('requestUrgencyFilter')?.value || '';
            
            let filteredRequests = allRequests;
            
            if (statusFilter) {
                filteredRequests = filteredRequests.filter(r => r.status === statusFilter);
            }
            if (typeFilter) {
                filteredRequests = filteredRequests.filter(r => r.type === typeFilter);
            }
            if (urgencyFilter) {
                filteredRequests = filteredRequests.filter(r => r.urgency === urgencyFilter);
            }
            
            console.log(`📋 Filtered requests: ${filteredRequests.length}`);
            
            if (filteredRequests.length === 0) {
                requestsList.innerHTML = `
                    <div class="job-card" style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📭</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Client Requests</h3>
                        <p style="color: #98bfa7;">
                            ${allRequests.length > 0 ? 'No requests match the current filters.' : 'Client requests for estimates and services will appear here.'}
                        </p>
                        ${allRequests.length > 0 ? '<button onclick="clearRequestFilters()" class="button" style="margin-top: 15px;">Clear Filters</button>' : ''}
                    </div>
                `;
            } else {
                requestsList.innerHTML = filteredRequests.map(request => `
                    <div class="job-card" style="border-left: 4px solid ${request.read ? '#98bfa7' : '#19a974'};">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div class="job-title" style="flex: 1;">${request.title}</div>
                            <div style="display: flex; gap: 5px;">
                                ${!request.read ? '<span style="background: #19a974; color: #0b0f0b; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">NEW</span>' : ''}
                                <span class="job-status status-${request.status === 'pending' ? 'pending' : 'completed'}">${request.status}</span>
                            </div>
                        </div>
                        
                        <div class="job-info">
                            <div class="job-info-item">
                                <span>Type:</span>
                                <strong>${request.type === 'estimate' ? 'Estimate Request' : 'Service Request'}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Client:</span>
                                <strong>${request.clientName || 'Unknown Client'}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Urgency:</span>
                                <strong style="color: ${getUrgencyColor(request.urgency)}">${request.urgency.toUpperCase()}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Requested:</span>
                                <strong>${formatDateTime(request.createdAt)}</strong>
                            </div>
                            ${request.description ? `
                                <div style="margin-top: 10px; padding: 10px; background: #1f2a1f; border-radius: 6px;">
                                    <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Description:</div>
                                    <div style="color: #e6ffee; font-size: 14px;">${request.description}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="job-actions" style="margin-top: 15px;">
                            ${request.status === 'pending' ? `
                                <button onclick="markRequestAsRead(${request.id})" class="button button-secondary">✓ Mark Read</button>
                                <button onclick="processRequest(${request.id})" class="button">📋 Process Request</button>
                            ` : `
                                <button onclick="viewProcessedRequest(${request.id})" class="button button-secondary">👁️ View Details</button>
                            `}
                        </div>
                    </div>
                `).join('');
            }
            
            modal.style.display = 'flex';
            
            // Set up filter event listeners
            setupRequestFilters();
            
            console.log('✅ Client requests modal opened');
        }
        
        function setupRequestFilters() {
            const statusFilter = document.getElementById('requestStatusFilter');
            const typeFilter = document.getElementById('requestTypeFilter');
            const urgencyFilter = document.getElementById('requestUrgencyFilter');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearProcessedBtn = document.getElementById('clearProcessedBtn');
            
            // Remove existing listeners
            [statusFilter, typeFilter, urgencyFilter].forEach(filter => {
                if (filter) {
                    filter.removeEventListener('change', showClientRequests);
                    filter.addEventListener('change', showClientRequests);
                }
            });
            
            if (markAllReadBtn) {
                markAllReadBtn.onclick = markAllRequestsAsRead;
            }
            
            if (clearProcessedBtn) {
                clearProcessedBtn.onclick = clearProcessedRequests;
            }
        }
        
        function clearRequestFilters() {
            document.getElementById('requestStatusFilter').value = '';
            document.getElementById('requestTypeFilter').value = '';
            document.getElementById('requestUrgencyFilter').value = '';
            showClientRequests();
        }
        
        function markAllRequestsAsRead() {
            const requests = db.load('clientRequests');
            let markedCount = 0;
            
            requests.forEach(request => {
                if (!request.read && request.status === 'pending') {
                    request.read = true;
                    markedCount++;
                }
            });
            
            if (markedCount > 0) {
                db.save('clientRequests', requests);
                db.updateNotificationCount();
                showClientRequests(); // Refresh the list
                showSuccess(`Marked ${markedCount} requests as read`);
            } else {
                showSuccess('No unread requests to mark');
            }
        }
        
        function clearProcessedRequests() {
            if (!confirm('Are you sure you want to delete all processed requests? This cannot be undone.')) {
                return;
            }
            
            const requests = db.load('clientRequests');
            const activeRequests = requests.filter(r => r.status === 'pending');
            const removedCount = requests.length - activeRequests.length;
            
            if (removedCount > 0) {
                db.save('clientRequests', activeRequests);
                showClientRequests(); // Refresh the list
                showSuccess(`Removed ${removedCount} processed requests`);
            } else {
                showSuccess('No processed requests to remove');
            }
        }

        function markRequestAsRead(requestId) {
            db.markRequestAsRead(requestId);
            showClientRequests(); // Refresh the list
        }

        function processRequest(requestId) {
            if (confirm('Mark this request as processed?')) {
                db.markRequestAsProcessed(requestId);
                showClientRequests(); // Refresh the list
                showSuccess('Request marked as processed!');
            }
        }

        function closeRequestsModal() {
            document.getElementById('clientRequestsModal').style.display = 'none';
        }

        function showEstimateModal() {
            document.getElementById('requestEstimateModal').style.display = 'flex';
        }

        function closeEstimateModal() {
            document.getElementById('requestEstimateModal').style.display = 'none';
        }

        function submitEstimateRequest() {
            const title = document.getElementById('estimateTitle').value.trim();
            const description = document.getElementById('estimateDescription').value.trim();
            const urgency = document.getElementById('estimateUrgency').value;
            const preferredDate = document.getElementById('estimatePreferredDate').value;

            if (!title) {
                alert('Please enter a service title');
                return;
            }

            const request = {
                type: 'estimate',
                title: title,
                description: description,
                urgency: urgency,
                preferredDate: preferredDate,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            closeEstimateModal();
            showSuccess('Estimate request submitted successfully!');
            
            // Clear form
            document.getElementById('estimateTitle').value = '';
            document.getElementById('estimateDescription').value = '';
            document.getElementById('estimateUrgency').value = 'low';
            document.getElementById('estimatePreferredDate').value = '';
        }

        function showServiceModal() {
            document.getElementById('scheduleServiceModal').style.display = 'flex';
        }

        function closeServiceModal() {
            document.getElementById('scheduleServiceModal').style.display = 'none';
        }

        function submitServiceRequest() {
            const title = document.getElementById('serviceTitle').value.trim();
            const description = document.getElementById('serviceDescription').value.trim();
            const date = document.getElementById('serviceDate').value;
            const recurring = document.getElementById('serviceRecurring').value;

            if (!title || !date) {
                alert('Please enter a service title and preferred date');
                return;
            }

            const request = {
                type: 'service',
                title: title,
                description: description,
                urgency: 'medium', // Default for service requests
                preferredDate: date,
                recurring: recurring,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            closeServiceModal();
            showSuccess('Service request submitted successfully!');
            
            // Clear form
            document.getElementById('serviceTitle').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('serviceDate').value = '';
            document.getElementById('serviceRecurring').value = '';
        }

        function submitCustomServiceRequest() {
            const title = document.getElementById('customServiceTitle').value.trim();
            const description = document.getElementById('customServiceDescription').value.trim();
            const urgency = document.getElementById('customServiceUrgency').value;
            const date = document.getElementById('customServiceDate').value;

            if (!title || !description) {
                alert('Please enter both a service title and description');
                return;
            }

            const request = {
                type: 'service',
                title: title,
                description: description,
                urgency: urgency,
                preferredDate: date,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            showSuccess('Custom service request submitted successfully!');
            
            // Clear form
            document.getElementById('customServiceTitle').value = '';
            document.getElementById('customServiceDescription').value = '';
            document.getElementById('customServiceUrgency').value = 'low';
            document.getElementById('customServiceDate').value = '';
        }

        // Utility functions
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                default: return 'Unknown';
            }
        }

        function getUrgencyColor(urgency) {
            switch (urgency) {
                case 'emergency': return '#dc3545';
                case 'high': return '#fd7e14';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#98bfa7';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateStr = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateStr;
            
            const clientDateEl = document.getElementById('clientCurrentDate');
            if (clientDateEl) {
                clientDateEl.textContent = dateStr;
            }
        }

        function loadWorkers() {
            const workers = db.load('workers');
            const grid = document.getElementById('workersGrid');

            if (workers.length === 0) {
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">👷</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Workers Found</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            Add your first worker to get started!
                        </p>
                        <button onclick="alert('Add Worker functionality coming soon!')" class="button">+ Add Your First Worker</button>
                    </div>
                `;
                return;
            }

            // Update worker stats
            const activeWorkers = workers.filter(w => w.status === 'active');
            const workingNow = workers.filter(w => w.currentlyWorking);
            const totalEarnings = workers.reduce((sum, w) => sum + (w.totalEarnings || 0), 0);

            document.getElementById('totalWorkers').textContent = workers.length;
            document.getElementById('activeWorkers').textContent = activeWorkers.length;
            document.getElementById('workingNow').textContent = workingNow.length;
            document.getElementById('totalWorkerEarnings').textContent = `$${totalEarnings.toFixed(2)}`;

            // Display workers
            grid.innerHTML = workers.map(worker => `
                <div class="worker-card">
                    <div class="worker-header">
                        <div class="worker-name">${worker.name}</div>
                        <div class="worker-status status-${worker.status}">
                            ${worker.currentlyWorking ? 'Working' : worker.status}
                        </div>
                    </div>
                    
                    <div class="worker-stats">
                        <div class="worker-stat">
                            <div class="worker-stat-value">$${worker.hourlyRate || 0}</div>
                            <div class="worker-stat-label">Rate/hr</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">${worker.hoursWorked || 0}</div>
                            <div class="worker-stat-label">Hours</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">${worker.jobsCompleted || 0}</div>
                            <div class="worker-stat-label">Jobs</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">$${(worker.totalEarnings || 0).toFixed(0)}</div>
                            <div class="worker-stat-label">Earnings</div>
                        </div>
                    </div>
                    
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Email:</span>
                            <strong>${worker.email || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Phone:</span>
                            <strong>${worker.phone || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Skills:</span>
                            <strong>${worker.skills ? worker.skills.join(', ') : 'None listed'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Hire Date:</span>
                            <strong>${formatDate(worker.hireDate)}</strong>
                        </div>
                    </div>
                    
                    <div class="job-actions" style="margin-top: 15px;">
                        <button onclick="viewWorkerDetails(${worker.id})" class="button button-secondary">👁️ View Details</button>
                        <button onclick="editWorker(${worker.id})" class="button button-secondary">✏️ Edit</button>
                        <button onclick="viewWorkerTimeEntries(${worker.id})" class="button">⏱️ Time Entries</button>
                    </div>
                </div>
            `).join('');
        }

        function loadGoalsProgress() {
            const goals = db.load('workerGoals');
            const activeGoals = goals.filter(g => g.active);
            const container = document.getElementById('goalsProgress');

            if (activeGoals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #98bfa7;">
                        <div style="font-size: 32px; margin-bottom: 10px;">🎯</div>
                        <div>No active goals set</div>
                        <button onclick="alert('Goal management coming soon!')" class="button" style="margin-top: 15px; width: auto; padding: 8px 16px;">Set Your First Goal</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeGoals.map(goal => {
                const percentage = Math.min((goal.current / goal.target) * 100, 100);
                const isOverTarget = goal.current > goal.target;
                
                return `
                    <div class="goal-progress">
                        <div class="goal-header">
                            <div class="goal-title">${goal.title}</div>
                            <div class="goal-percentage">${percentage.toFixed(1)}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; ${isOverTarget ? 'background: linear-gradient(90deg, #28a745, #20c997);' : ''}"></div>
                        </div>
                        <div class="goal-details">
                            <span>${goal.current} / ${goal.target} ${goal.type === 'revenue' ? '$' : goal.type === 'hours' ? 'hrs' : ''}</span>
                            <span>${goal.period} goal</span>
                        </div>
                        ${isOverTarget ? '<div style="color: #28a745; font-size: 12px; margin-top: 5px;">🎉 Goal exceeded!</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function viewWorkerDetails(workerId) {
            alert(`Worker details for ID ${workerId} - functionality coming soon!`);
        }

        function editWorker(workerId) {
            alert(`Edit worker ID ${workerId} - functionality coming soon!`);
        }

        function viewWorkerTimeEntries(workerId) {
            const timeEntries = db.load('timeEntries');
            const workerEntries = timeEntries.filter(entry => entry.workerId === workerId);
            
            if (workerEntries.length === 0) {
                alert('No time entries found for this worker.');
                return;
            }
            
            const totalHours = workerEntries.reduce((sum, entry) => sum + entry.hours, 0);
            const totalEarnings = workerEntries.reduce((sum, entry) => sum + entry.earnings, 0);
            
            alert(`Time Entries Summary:\nTotal Hours: ${totalHours.toFixed(2)}\nTotal Earnings: $${totalEarnings.toFixed(2)}\nEntries: ${workerEntries.length}\n\nDetailed view coming soon!`);
        }

        function switchSection(section) {
            // Update active tab
            document.querySelectorAll('[data-section]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Show/hide sections
            document.getElementById('jobsSection').style.display = section === 'jobs' ? 'block' : 'none';
            document.getElementById('clientsSection').style.display = section === 'clients' ? 'block' : 'none';
            document.getElementById('workersSection').style.display = section === 'workers' ? 'block' : 'none';
            document.getElementById('earningsSection').style.display = section === 'earnings' ? 'block' : 'none';
            document.getElementById('timeSection').style.display = section === 'time' ? 'block' : 'none';

            // Load section data
            if (section === 'clients') {
                loadClients();
            } else if (section === 'workers') {
                loadWorkers();
            } else if (section === 'earnings') {
                updateStats();
            } else if (section === 'time') {
                loadJobsForTimeTracker();
                updateTimeTrackerDisplay();
                loadGoalsProgress();
            }
        }

        function switchJobTab(tab) {
            // Update active tab
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            loadJobs();
        }

        function switchClientSection(section) {
            // Update active tab
            document.querySelectorAll('[data-client-section]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-client-section="${section}"]`).classList.add('active');

            // Show/hide sections
            document.getElementById('clientServicesSection').style.display = section === 'services' ? 'block' : 'none';
            document.getElementById('clientBrowseSection').style.display = section === 'browse' ? 'block' : 'none';
            document.getElementById('clientEstimatesSection').style.display = section === 'estimates' ? 'block' : 'none';
            document.getElementById('clientProfileSection').style.display = section === 'profile' ? 'block' : 'none';
        }

        function switchClientTab(tab) {
            // Update active tab
            document.querySelectorAll('[data-client-tab]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-client-tab="${tab}"]`).classList.add('active');

            loadClientServices();
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '10000';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
        }

        // Phone integration functions
        function callHandyman() {
            window.location.href = 'tel:+15551234567';
        }

        function textHandyman() {
            window.location.href = 'sms:+15551234567';
        }

        // ===== DEBUG FUNCTIONS =====
        
        function testLocationSystem() {
            console.log('🧪 Testing location system...');
            
            // Test with different locations
            const testLocations = [
                { name: 'St. George Center', lat: 37.0965, lng: -113.5684, shouldBeInside: true },
                { name: 'Cedar City Center', lat: 37.6781, lng: -113.0618, shouldBeInside: true },
                { name: 'Las Vegas (Outside)', lat: 36.1699, lng: -115.1398, shouldBeInside: false },
                { name: 'Salt Lake City (Outside)', lat: 40.7608, lng: -111.8910, shouldBeInside: false }
            ];
            
            let testIndex = 0;
            
            function runNextTest() {
                if (testIndex >= testLocations.length) {
                    console.log('✅ Location testing complete');
                    showSuccess('Location testing complete! Check console for details.');
                    return;
                }
                
                const testLocation = testLocations[testIndex];
                console.log(`🧪 Testing location: ${testLocation.name}`);
                
                // Temporarily set location
                currentLocation = {
                    lat: testLocation.lat,
                    lng: testLocation.lng,
                    accuracy: 10,
                    timestamp: new Date().toISOString(),
                    isTest: true
                };
                
                checkGeofenceStatus();
                
                const actualInside = isInsideGeofence;
                const expectedInside = testLocation.shouldBeInside;
                
                if (actualInside === expectedInside) {
                    console.log(`✅ ${testLocation.name}: PASS (${actualInside ? 'inside' : 'outside'})`);
                } else {
                    console.log(`❌ ${testLocation.name}: FAIL (expected ${expectedInside ? 'inside' : 'outside'}, got ${actualInside ? 'inside' : 'outside'})`);
                }
                
                testIndex++;
                setTimeout(runNextTest, 2000);
            }
            
            runNextTest();
        }
        
        function testNotificationSystem() {
            console.log('🧪 Testing notification system...');
            
            // Create a test request
            const testRequest = {
                type: 'estimate',
                title: 'Test Notification Request',
                description: 'This is a test request to verify the notification system is working properly.',
                urgency: 'high',
                preferredDate: new Date().toISOString(),
                clientName: 'Test Client',
                clientId: 'test-client-123'
            };
            
            console.log('📝 Creating test request:', testRequest);
            
            const savedRequest = db.addClientRequest(testRequest);
            console.log('💾 Test request saved:', savedRequest);
            
            // Force update notification count
            setTimeout(() => {
                const count = db.updateNotificationCount();
                console.log(`🔔 Current notification count: ${count}`);
                
                if (count > 0) {
                    showSuccess(`Test notification created! Badge shows ${count} notifications.`);
                } else {
                    showError(document.createElement('div'), 'Test notification failed - check console for details');
                }
            }, 500);
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9716a79d65a4f7a9',t:'MTc1NTU3NTA5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
