<!DOCTYPE html>
<html lang="en">
<head>
<!-- CLIENTLOCK SAFE-AREA + HIDDEN CSS -->
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --fallback-gap: 28px; /* a bit larger */
  }
  html, body { height: 100%; }
  body {
    padding-top: calc(var(--safe-top) + var(--fallback-gap));
    padding-bottom: calc(var(--safe-bottom) + var(--fallback-gap));
  }
  .hidden { display: none !important; }
</style>
<!-- SAFE-AREA + ROLE BAR CSS -->
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --fallback-gap: 24px;
  }
  html, body { height: 100%; }
  body {
    padding-top: calc(var(--safe-top) + var(--fallback-gap));
    padding-bottom: calc(var(--safe-bottom) + var(--fallback-gap));
  }
  .hidden{ display:none !important; }
  #roleBar {
    position: sticky;
    top: 0;
    z-index: 9999;
    padding: calc(var(--safe-top) + 8px) 12px 8px 12px;
    text-align: center;
    background: #a1d1b7; /* light green bar */
    color: #0f3c2b;
    font-weight: 600;
    border-bottom: 1px solid rgba(0,0,0,.15);
  }
  #roleBar button {
    border: 0;
    background: transparent;
    font: inherit;
    color: inherit;
  }
  #safeBottomSpacer {
    height: calc(var(--safe-bottom) + 12px);
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>.hidden{display:none !important}</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#0b0f0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Handyman SU">
    
    <!-- Cordova/PhoneGap Script --><title>Handyman Southern Utah Job Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons for different platforms -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Geolocation and Maps -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0f0b;
            color: #e6ffee;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Prevent zoom on iOS */
        input[type="text"], input[type="email"], input[type="tel"], 
        input[type="password"], input[type="number"], textarea, select {
            font-size: 16px !important;
        }

        /* Hide scrollbars but keep functionality */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Mobile-specific optimizations */
        @supports (-webkit-touch-callout: none) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
                padding-top: env(safe-area-inset-top);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #19a974;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #98bfa7;
            font-size: 1.1rem;
        }

        .panel {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #1f2a1f;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #98bfa7;
            font-weight: 600;
        }

        .input {
            background: #0f1a0f;
            color: #e6ffee;
            border: 1px solid #1f2a1f;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input:focus {
            border-color: #19a974;
        }

        .button {
            cursor: pointer;
            background: #19a974;
            color: #0b0f0b;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
        }

        .button:hover {
            background: #15a06a;
            transform: translateY(-2px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button-secondary {
            background: #98bfa7;
            color: #0b0f0b;
        }

        .button-secondary:hover {
            background: #8bb09a;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .job-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #1f2a1f;
            transition: transform 0.3s, border-color 0.3s;
        }

        .job-card:hover {
            transform: translateY(-5px);
            border-color: #19a974;
        }

        .job-title {
            color: #19a974;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .job-info {
            margin-bottom: 15px;
        }

        .job-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #98bfa7;
        }

        .job-info-item strong {
            color: #e6ffee;
        }

        .job-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-pending {
            background: #ffc107;
            color: #000;
        }

        .status-in-progress {
            background: #17a2b8;
            color: white;
        }

        .status-completed {
            background: #28a745;
            color: white;
        }

        .job-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .job-actions .button {
            flex: 1;
            min-width: 120px;
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 10px;
            overflow-y: auto;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .modal-content {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid #1f2a1f;
            position: relative;
            margin: auto;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            cursor: move;
        }

        .modal-content.dragging {
            user-select: none;
        }

        .modal-header {
            cursor: move;
            user-select: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #19a974;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            color: #98bfa7;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .close-button:hover {
            color: #e6ffee;
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #28a745;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #98bfa7;
        }

        .spinner {
            border: 3px solid #1f2a1f;
            border-top: 3px solid #19a974;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #1f2a1f;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #19a974;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            color: #98bfa7;
        }

        .user-info strong {
            color: #19a974;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid #1f2a1f;
            padding-bottom: 0;
        }

        .tab-button {
            background: none;
            border: none;
            color: #98bfa7;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button:hover {
            color: #e6ffee;
            background: #1f2a1f;
        }

        .tab-button.active {
            color: #19a974;
            background: #0f1a0f;
            border-bottom: 2px solid #19a974;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #19a974;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        /* Database Status Indicator */
        .db-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #19a974;
            color: #0b0f0b;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0.8;
        }

        .db-status.error {
            background: #dc3545;
            color: white;
        }

        .db-status.syncing {
            background: #ffc107;
            color: #000;
            animation: pulse 1s infinite;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .jobs-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .top-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .job-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .job-actions .button {
                min-width: auto;
                width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 2px;
            }
            
            .tab-button {
                flex: 1;
                min-width: 100px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .panel {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .modal-content {
                margin: 10px;
                padding: 20px;
                max-width: calc(100vw - 20px);
            }
            
            .job-card {
                padding: 15px;
            }
            
            .job-title {
                font-size: 1.1rem;
            }
            
            .job-info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .tab-button {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .modal-content {
                margin: 5px;
                padding: 15px;
            }
            
            .job-card {
                padding: 12px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .top-bar > div:first-child {
                text-align: center;
            }
        }

        /* Rating Stars */
        .rating-star {
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .rating-star:hover {
            color: #ffc107 !important;
            transform: scale(1.1);
        }

        .rating-star.selected {
            color: #ffc107 !important;
        }

        /* In-App Notifications */
        .in-app-notification {
            animation: slideInRight 0.5s ease-out;
        }

        /* Weather Display */
        .weather-info {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #19a974;
        }

        .weather-warning {
            background: #dc3545;
            color: white;
            border-left-color: #dc3545;
        }

        /* Mileage Display */
        .mileage-info {
            background: #1f2a1f;
            border-radius: 6px;
            padding: 8px;
            margin: 8px 0;
            font-size: 12px;
        }

        /* Geofence and Location Styles */
        .location-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #19a974;
            color: #0b0f0b;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 5px;
            /*
             * Disable pointer events on the geofence/location status banner so it
             * doesnâ€™t intercept clicks or taps on mobile devices. Without
             * pointer-events: none the banner can block underlying UI
             * interactions, especially on small screens.
             */
            pointer-events: none;
        }

        .location-status.outside {
            background: #dc3545;
            color: white;
        }

        .location-status.unknown {
            background: #ffc107;
            color: #000;
        }

        .geofence-info {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #19a974;
        }

        .geofence-warning {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .time-tracker {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #19a974;
        }

        .time-display {
            font-size: 2rem;
            font-weight: 700;
            color: #19a974;
            text-align: center;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .timer-button {
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        .timer-start {
            background: #28a745;
            color: white;
        }

        .timer-pause {
            background: #ffc107;
            color: #000;
        }

        .timer-stop {
            background: #dc3545;
            color: white;
        }

        .timer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .earnings-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .earnings-card {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #19a974;
        }

        .earnings-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #19a974;
            margin-bottom: 5px;
        }

        .earnings-label {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        /* Worker Management Styles */
        .worker-card {
            background: #0f1a0f;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #1f2a1f;
            margin-bottom: 15px;
        }

        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .worker-name {
            color: #19a974;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .worker-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-inactive {
            background: #6c757d;
            color: white;
        }

        .status-working {
            background: #17a2b8;
            color: white;
        }

        .worker-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .worker-stat {
            text-align: center;
            padding: 8px;
            background: #1f2a1f;
            border-radius: 6px;
        }

        .worker-stat-value {
            font-weight: 700;
            color: #19a974;
            font-size: 1.1rem;
        }

        .worker-stat-label {
            color: #98bfa7;
            font-size: 0.8rem;
        }

        /* Goal Tracking */
        .goal-progress {
            background: #1f2a1f;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title {
            color: #19a974;
            font-weight: 600;
        }

        .goal-percentage {
            color: #98bfa7;
            font-size: 0.9rem;
        }

        .progress-bar {
            background: #0f1a0f;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #19a974, #28a745);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .goal-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #98bfa7;
        }
    </style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

</head>
<body>

<div id="roleBar" class="hidden">
  <button id="roleMgrFab"><i class="bi bi-wrench-adjustable"></i> Manage Roles</button>
</div>

    <!-- Database Status Indicator -->
    <div id="dbStatus" class="db-status" style="display: none;">
        ðŸ’¾ Database Ready
    </div>

    <!-- Location Status Indicator -->
    <div id="locationStatus" class="location-status" style="display: none;">
        <span id="locationIcon">ðŸ“</span>
        <span id="locationText">Checking location...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>ðŸ”§ Handyman Southern Utah Job Tracker</h1>
            <p>Manage your jobs, track time, and get paid</p>
        </div>

        <!-- Loading Screen -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading your jobs...</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="panel login-form" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px; color: #19a974;">Welcome Back</h2>
            <div id="loginError" class="error" style="display: none;"></div>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="input" placeholder="Enter your username" autocomplete="username">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <div style="position: relative;">
                    <input type="password" id="password" class="input" placeholder="Enter your password" style="padding-right: 45px;" autocomplete="current-password">
                    <button type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #98bfa7; cursor: pointer; font-size: 18px; padding: 5px;">ðŸ‘ï¸</button>
                </div>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; margin-bottom: 0; font-weight: normal; cursor: pointer;">
                    <input type="checkbox" id="rememberDevice" style="margin-right: 8px;">
                    Remember this device
                </label>
            </div>
            
            <button id="loginBtn" class="button">Sign In</button>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #1f2a1f;">
                <p style="color: #98bfa7; margin-bottom: 15px;">Need help with your account?</p>
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button id="forgotPasswordBtn" class="button button-secondary">ðŸ”‘ Forgot Password</button>
                    <button id="showRegisterBtn" class="button button-secondary">ðŸ†• New Client - Create Account</button>
                    <!-- Removed first-time login button to avoid confusion; existing clients should use the main login -->
                </div>
            </div>
        </div>

        <!-- Registration Modal -->
        <div id="registerModal" class="modal" style="display: none;">
            <div class="modal-content" style="background: #0c1a0c; padding: 20px; border-radius: 8px; color: #e6ffee; position: relative; max-width: 500px; width: 90%;">
                <!-- Close icon -->
                <span id="registerModalClose" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;" onclick="window.closeRegisterModal()">&times;</span>
                <h3 style="margin-top: 0; margin-bottom: 15px; color: #19a974;">New Client â€“ Create Account</h3>
                <!-- Registration form fields -->
                <div class="form-group">
                    <label for="regFullName">Full Name *</label>
                    <input type="text" id="regFullName" class="input" placeholder="John Doe" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="regPhone">Phone Number *</label>
                    <input type="tel" id="regPhone" class="input" placeholder="(555) 123-4567" autocomplete="tel">
                </div>
                <div class="form-group">
                    <label for="regStreet">Street Address *</label>
                    <input type="text" id="regStreet" class="input" placeholder="123 Main St" autocomplete="street-address">
                </div>
                <div class="form-group">
                    <label for="regCity">City *</label>
                    <input type="text" id="regCity" class="input" placeholder="St. George" autocomplete="address-level2">
                </div>
                <div class="form-group">
                    <label for="regState">State *</label>
                    <select id="regState" class="input">
                        <option value="">Select State</option>
                        <option value="UT">Utah</option>
                        <option value="AZ">Arizona</option>
                        <option value="NV">Nevada</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <!-- Add more states as needed -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="regZip">Zip Code *</label>
                    <input type="text" id="regZip" class="input" placeholder="84770" autocomplete="postal-code">
                </div>
                <div class="form-group">
                    <label for="regEmail">Email *</label>
                    <input type="email" id="regEmail" class="input" placeholder="you@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="regPassword">Password *</label>
                    <input type="password" id="regPassword" class="input" placeholder="Create a password" autocomplete="new-password">
                </div>
                <button id="registerSubmitBtn" class="button" style="width: 100%;">Create Account</button>
            </div>
        </div>

        <script>
        // Registration modal helpers
        window.showRegisterModal = function() {
            const modal = document.getElementById('registerModal');
            if (modal) modal.style.display = 'flex';
        };
        window.closeRegisterModal = function() {
            const modal = document.getElementById('registerModal');
            if (modal) modal.style.display = 'none';
            // Reset fields
            ['regFullName','regPhone','regStreet','regCity','regState','regZip','regEmail','regPassword'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        };
        // Handle registration form submission
        async function handleRegisterSubmit() {
            const fullName = document.getElementById('regFullName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const street = document.getElementById('regStreet').value.trim();
            const city = document.getElementById('regCity').value.trim();
            const state = document.getElementById('regState').value;
            const zip = document.getElementById('regZip').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            // Basic validation
            if (!fullName || !phone || !street || !city || !state || !zip || !email || !password) {
                showSuccess('âš ï¸ Please fill out all required registration fields.');
                return;
            }
            // Normalize phone
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 10) {
                showSuccess('âš ï¸ Please enter a valid phone number (at least 10 digits).');
                return;
            }
            // Email regex
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                showSuccess('âš ï¸ Please enter a valid email address.');
                return;
            }
            try {
                // Create auth user
                const cred = await window.fsCreateUser(window.fsAuth, email, password);
                const uid = cred.user.uid;
                // Save user profile in Firestore
                await window.fsSetDoc(window.fsDoc(window.fsDB, 'users', uid), {
                    name: fullName,
                    phone: phoneDigits,
                    street: street,
                    city: city,
                    state: state,
                    zipcode: zip,
                    email: email,
                    role: 'client',
                    createdAt: new Date().toISOString()
                }, { merge: true });
                // Also save to local client database
                const clients = db.load('clients');
                clients.push({
                    id: Date.now(),
                    name: fullName,
                    phone: phoneDigits,
                    street: street,
                    city: city,
                    state: state,
                    zipcode: zip,
                    email: email,
                    type: 'residential',
                    totalJobs: 0,
                    totalSpent: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                db.save('clients', clients);
                showSuccess('Account created! Please sign in.');
                window.closeRegisterModal();
            } catch (err) {
                showSuccess('âš ï¸ ' + (err.message || 'Error creating account.'));
            }
        }
        // Attach event listeners after DOM load
        document.addEventListener('DOMContentLoaded', () => {
            const regBtn = document.getElementById('registerSubmitBtn');
            if (regBtn) regBtn.addEventListener('click', handleRegisterSubmit);
            const newClientBtn = document.getElementById('showRegisterBtn');
            if (newClientBtn) newClientBtn.addEventListener('click', window.showRegisterModal);
        });
        </script>


        <!-- Main App -->
        <div id="mainApp" style="display: none;">
            <div class="top-bar">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div id="currentDate" style="color: #19a974; font-weight: 600; font-size: 0.9rem;"></div>
                    <div class="user-info">
                        Welcome back, <strong id="userName">Admin</strong>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <!-- Cloud Setup button removed -->
                    <button id="requestNotificationBtn" class="button button-secondary" style="position: relative;">
                        ðŸ”” Requests
                        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <!-- Test Location button removed -->
                    <button id="addJobBtn" class="button">+ Add New Job</button>
                    <button id="clientViewBtn" class="button button-secondary">ðŸ‘ï¸ Client View</button>
                    <button id="logoutBtn" class="button button-secondary">Logout</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalJobs">0</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeJobs">0</div>
                    <div class="stat-label">Active Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedJobs">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarnings">$0.00</div>
                    <div class="stat-label">Total Earnings</div>
                </div>
            </div>

            <!-- Main Navigation Tabs -->
            <div class="tabs">
                <button class="tab-button active" data-section="jobs">ðŸ“‹ Jobs</button>
                <button class="tab-button" data-section="clients">ðŸ‘¥ Clients</button>
                <button class="tab-button" data-section="workers">ðŸ‘· Workers</button>
                <button class="tab-button" data-section="earnings">ðŸ’° Earnings</button>
            </div>

            <!-- Job Section -->
            <div id="jobsSection">
                <!-- Job Tabs -->
                <div class="tabs" style="margin-top: 20px;">
                    <button class="tab-button active" data-tab="all">All Jobs</button>
                    <button class="tab-button" data-tab="active">Active</button>
                    <button class="tab-button" data-tab="upcoming">Upcoming</button>
                    <button class="tab-button" data-tab="completed">Completed</button>
                </div>

                <!-- Jobs Grid -->
                <div id="jobsGrid" class="jobs-grid"></div>
            </div>

            <!-- Clients Section -->
            <div id="clientsSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #19a974; font-size: 1.3rem;">Client Directory</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="addClientBtn" class="button">+ Add New Client</button>
                    </div>
                </div>
                <div id="clientsGrid" class="jobs-grid"></div>
            </div>

            <!-- Workers Section -->
            <div id="workersSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #19a974; font-size: 1.3rem;">ðŸ‘· Worker Management</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="addWorkerBtn" class="button">+ Add New Worker</button>
                        <button id="manageGoalsBtn" class="button button-secondary">ðŸŽ¯ Manage Goals</button>
                    </div>
                </div>
                
                <!-- Worker Stats Overview -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkers">0</div>
                        <div class="stat-label">Total Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeWorkers">0</div>
                        <div class="stat-label">Active Workers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="workingNow">0</div>
                        <div class="stat-label">Working Now</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalWorkerEarnings">$0.00</div>
                        <div class="stat-label">Total Worker Earnings</div>
                    </div>
                </div>

                <div id="workersGrid" class="jobs-grid"></div>
            </div>

            <!-- Earnings Section -->
            <div id="earningsSection" style="display: none;">
                <div style="margin: 20px 0;">
                    <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">ðŸ’° Earnings Dashboard</h3>
                    
                    <!-- Completed Earnings -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">âœ… Completed Earnings</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="todayEarnings">$0.00</div>
                                <div class="stat-label">Today</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="weekEarnings">$0.00</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="monthEarnings">$0.00</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="sixMonthEarnings">$0.00</div>
                                <div class="stat-label">Last 6 Months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Potential Earnings -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">ðŸŽ¯ Potential Earnings (Upcoming Jobs)</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="potentialTodayEarnings">$0.00</div>
                                <div class="stat-label">Today</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialWeekEarnings">$0.00</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialMonthEarnings">$0.00</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="potentialSixMonthEarnings">$0.00</div>
                                <div class="stat-label">Next 6 Months</div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Projections -->
                    <div class="panel">
                        <h4 style="color: #19a974; margin-bottom: 20px; font-size: 1.2rem;">ðŸ“ˆ Total Projections (Completed + Potential)</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalTodayProjection">$0.00</div>
                                <div class="stat-label">Today Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalWeekProjection">$0.00</div>
                                <div class="stat-label">Week Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalMonthProjection">$0.00</div>
                                <div class="stat-label">Month Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalSixMonthProjection">$0.00</div>
                                <div class="stat-label">6-Month Total</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- Client Portal -->
        <div id="clientPortal" style="display: none;">
            <div class="container">
                <div class="header">
                    <h1>ðŸ  My Home Services</h1>
                    <p>All your service needs in one place</p>
                </div>

                <div class="top-bar">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div id="clientCurrentDate" style="color: #19a974; font-weight: 600; font-size: 0.9rem;"></div>
                        <div class="user-info">
                            Welcome, <strong id="clientUserName">Client</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="callHandyman()" class="button" style="background: #28a745;">ðŸ“ž Call Now</button>
                        <button onclick="textHandyman()" class="button" style="background: #17a2b8;">ðŸ’¬ Text Now</button>
                        <!--
                          Add inline click handlers so these buttons respond on all
                          platforms (desktop, mobile, WebView) even if event
                          listeners fail to attach. Each handler simply calls the
                          associated function defined in the script. The
                          display:none style on returnToAdminBtn is still
                          controlled by JavaScript.
                        -->
                        <button id="requestEstimateBtn" class="button" onclick="showEstimateModal()">ðŸ“‹ Request Estimate</button>
                        <button id="scheduleServiceBtn" class="button" onclick="showServiceModal()">ðŸ”§ Schedule Service</button>
                        <button id="testNotificationBtn" class="button" style="background: #ffc107; color: #000;">ðŸ§ª Test Notification</button>
                        <button id="returnToAdminBtn" class="button" style="display: none;" onclick="returnToAdmin()">ðŸ”™ Return to Admin</button>
                        <button id="clientLogoutBtn" class="button button-secondary" onclick="handleClientLogout()">Logout</button>
                    </div>
                </div>

                <!-- Client Stats -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="clientTotalServices">0</div>
                        <div class="stat-label">Total Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientActiveServices">0</div>
                        <div class="stat-label">Active Services</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientCompletedServices">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="clientTotalSpent">$0.00</div>
                        <div class="stat-label">Total Spent</div>
                    </div>
                </div>

                <!-- Client Navigation Tabs -->
                <div class="tabs">
                    <button class="tab-button active" data-client-section="services">ðŸ”§ My Services</button>
                    <button class="tab-button" data-client-section="browse">ðŸ› ï¸ Browse Services</button>
                    <button class="tab-button" data-client-section="estimates">ðŸ“‹ Estimates</button>
                    <button class="tab-button" data-client-section="profile">ðŸ‘¤ My Profile</button>
                </div>

                <!-- Services Section -->
                <div id="clientServicesSection">
                    <div class="tabs" style="margin-top: 20px;">
                        <button class="tab-button active" data-client-tab="all">All Services</button>
                        <button class="tab-button" data-client-tab="upcoming">Upcoming</button>
                        <button class="tab-button" data-client-tab="active">In Progress</button>
                        <button class="tab-button" data-client-tab="completed">Completed</button>
                    </div>

                    <div id="clientServicesGrid" class="jobs-grid"></div>
                </div>

                <!-- Browse Services Section -->
                <div id="clientBrowseSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">ðŸ› ï¸ Available Services</h3>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #1f2a1f; border-radius: 8px;">
                            <div style="color: #19a974; font-weight: 600; margin-bottom: 8px;">ðŸ“‹ Browse Our Services</div>
                            <div style="color: #98bfa7; font-size: 14px; line-height: 1.5;">
                                Browse our available services and request estimates or schedule appointments. You can also submit a custom request if you don't see what you need.
                            </div>
                        </div>

                        <!-- Custom Request Section -->
                        <div class="panel" style="margin-bottom: 20px;">
                            <h4 style="color: #19a974; margin-bottom: 15px;">âœï¸ Custom Service Request</h4>
                            <div style="margin-bottom: 15px; color: #98bfa7; font-size: 14px;">
                                Don't see what you need? Describe your custom service request below:
                            </div>
                            
                            <div class="form-group">
                                <label for="customServiceTitle">Service Title *</label>
                                <input type="text" id="customServiceTitle" class="input" placeholder="e.g., Custom deck repair">
                            </div>
                            
                            <div class="form-group">
                                <label for="customServiceDescription">Description *</label>
                                <textarea id="customServiceDescription" class="input" rows="4" placeholder="Please describe what you need done in detail..."></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="customServiceUrgency">Urgency Level</label>
                                    <select id="customServiceUrgency" class="input">
                                        <option value="low">Low - Within 2 weeks</option>
                                        <option value="medium">Medium - Within 1 week</option>
                                        <option value="high">High - Within 2-3 days</option>
                                        <option value="emergency">Emergency - ASAP</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="customServiceDate">Preferred Date</label>
                                    <input type="date" id="customServiceDate" class="input">
                                </div>
                            </div>
                            
                            <button onclick="submitCustomServiceRequest()" class="button" style="width: 100%; margin-top: 15px;">
                                ðŸ“‹ Submit Custom Request
                            </button>
                        </div>
                        
                        <div id="clientBrowseGrid" class="jobs-grid"></div>
                    </div>
                </div>

                <!-- Estimates Section -->
                <div id="clientEstimatesSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">ðŸ“‹ My Estimates</h3>
                        <div id="clientEstimatesGrid" class="jobs-grid"></div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="clientProfileSection" style="display: none;">
                    <div style="margin: 20px 0;">
                        <h3 style="color: #19a974; font-size: 1.3rem; margin-bottom: 20px;">ðŸ‘¤ My Profile</h3>
                        
                        <div class="panel">
                            <h4 style="color: #19a974; margin-bottom: 20px;">Contact Information</h4>
                            <div id="clientProfileInfo" class="job-info">
                                <!-- Profile info will be populated here -->
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button id="editProfileBtn" class="button">Edit Profile</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Requests Modal -->
        <div id="clientRequestsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ”” Client Requests</h3>
                    <button class="close-button" onclick="closeRequestsModal()">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600;">Manage client requests for estimates and services</div>
                        <div style="display: flex; gap: 10px;">
                            <button id="markAllReadBtn" class="button button-secondary" style="padding: 6px 12px; font-size: 14px;">Mark All Read</button>
                            <button id="clearProcessedBtn" class="button button-secondary" style="padding: 6px 12px; font-size: 14px;">Clear Processed</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="requestStatusFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Requests</option>
                            <option value="pending">Pending Only</option>
                            <option value="processed">Processed Only</option>
                        </select>
                        <select id="requestTypeFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Types</option>
                            <option value="estimate">Estimates</option>
                            <option value="service">Services</option>
                        </select>
                        <select id="requestUrgencyFilter" class="input" style="width: auto; padding: 6px;">
                            <option value="">All Urgency</option>
                            <option value="emergency">Emergency</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                
                <div id="requestsList" style="max-height: 500px; overflow-y: auto;">
                    <!-- Requests will be populated here -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeRequestsModal()" class="button button-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Request Estimate Modal -->
        <div id="requestEstimateModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ“‹ Request Estimate</h3>
                    <button class="close-button" onclick="closeEstimateModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="estimateTitle">Service Needed *</label>
                    <input type="text" id="estimateTitle" class="input" placeholder="e.g., Kitchen faucet repair">
                </div>
                
                <div class="form-group">
                    <label for="estimateDescription">Description</label>
                    <textarea id="estimateDescription" class="input" rows="4" placeholder="Please describe what needs to be done..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="estimateUrgency">Urgency Level</label>
                    <select id="estimateUrgency" class="input">
                        <option value="low">Low - Within 2 weeks</option>
                        <option value="medium">Medium - Within 1 week</option>
                        <option value="high">High - Within 2-3 days</option>
                        <option value="emergency">Emergency - ASAP</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="estimatePreferredDate">Preferred Date for Estimate</label>
                    <input type="date" id="estimatePreferredDate" class="input">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeEstimateModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="submitEstimateRequest()" class="button" style="flex: 1;">Submit Request</button>
                </div>
            </div>
        </div>

        <!-- Schedule Service Modal -->
        <div id="scheduleServiceModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ”§ Schedule Service</h3>
                    <button class="close-button" onclick="closeServiceModal()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label for="serviceTitle">Service Title *</label>
                    <input type="text" id="serviceTitle" class="input" placeholder="e.g., Monthly lawn maintenance">
                </div>
                
                <div class="form-group">
                    <label for="serviceDescription">Service Description</label>
                    <textarea id="serviceDescription" class="input" rows="4" placeholder="Please describe the service needed..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="serviceDate">Preferred Service Date *</label>
                    <input type="datetime-local" id="serviceDate" class="input">
                </div>
                
                <div class="form-group">
                    <label for="serviceRecurring">Recurring Service</label>
                    <select id="serviceRecurring" class="input">
                        <option value="">One-time service</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 weeks</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="closeServiceModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="submitServiceRequest()" class="button" style="flex: 1;">Schedule Service</button>
                </div>
            </div>
        </div>

        <!-- Add Job Modal -->
        <div id="addJobModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">âž• Add New Job</h3>
                    <button class="close-button" onclick="closeAddJobModal()">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobTitle">Job Title *</label>
                        <input type="text" id="jobTitle" class="input" placeholder="e.g., Kitchen faucet repair">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobClient">Client *</label>
                        <select id="jobClient" class="input">
                            <option value="">Select a client</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="jobDescription">Description</label>
                    <textarea id="jobDescription" class="input" rows="3" placeholder="Describe the work to be done..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobHourlyRate">Hourly Rate ($)</label>
                        <input type="number" id="jobHourlyRate" class="input" placeholder="25.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobEstimatedHours">Est. Hours</label>
                        <input type="number" id="jobEstimatedHours" class="input" placeholder="4" step="0.5" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobPriority">Priority</label>
                        <select id="jobPriority" class="input">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobScheduledDate">Scheduled Date</label>
                        <input type="datetime-local" id="jobScheduledDate" class="input">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobStatus">Status</label>
                        <select id="jobStatus" class="input">
                            <option value="pending">Pending</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="jobStreet">Job Street Address</label>
                    <input type="text" id="jobStreet" class="input" placeholder="123 Main St">
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobCity">City</label>
                        <input type="text" id="jobCity" class="input" placeholder="St. George">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobState">State</label>
                        <select id="jobState" class="input">
                            <option value="">Select State</option>
                            <option value="UT">Utah</option>
                            <option value="AZ">Arizona</option>
                            <option value="NV">Nevada</option>
                            <option value="CO">Colorado</option>
                            <option value="ID">Idaho</option>
                            <option value="WY">Wyoming</option>
                            <option value="CA">California</option>
                            <option value="NM">New Mexico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="jobZipcode">Zip Code</label>
                        <input type="text" id="jobZipcode" class="input" placeholder="84770" maxlength="5" pattern="[0-9]{5}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="jobNotes">Notes</label>
                    <textarea id="jobNotes" class="input" rows="2" placeholder="Any special instructions or notes..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeAddJobModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="saveNewJob()" class="button" style="flex: 1;">Create Job</button>
                </div>
            </div>
        </div>

        <!-- Add Client Modal -->
        <div id="addClientModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ‘¤ Add New Client</h3>
                    <button class="close-button" onclick="closeAddClientModal()">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="clientFirstName">First Name *</label>
                        <input type="text" id="clientFirstName" class="input" placeholder="John">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientLastName">Last Name *</label>
                        <input type="text" id="clientLastName" class="input" placeholder="Smith">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" class="input" placeholder="john.smith@email.com">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="clientPhone">Phone *</label>
                        <input type="tel" id="clientPhone" class="input" placeholder="(555) 123-4567">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientType">Client Type</label>
                        <select id="clientType" class="input">
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                            <option value="property-management">Property Management</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientStreet">Street Address *</label>
                    <input type="text" id="clientStreet" class="input" placeholder="123 Main St">
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="clientCity">City *</label>
                        <input type="text" id="clientCity" class="input" placeholder="St. George">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientState">State *</label>
                        <select id="clientState" class="input">
                            <option value="">Select State</option>
                            <option value="UT">Utah</option>
                            <option value="AZ">Arizona</option>
                            <option value="NV">Nevada</option>
                            <option value="CO">Colorado</option>
                            <option value="ID">Idaho</option>
                            <option value="WY">Wyoming</option>
                            <option value="CA">California</option>
                            <option value="NM">New Mexico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientZipcode">Zip Code *</label>
                        <input type="text" id="clientZipcode" class="input" placeholder="84770" maxlength="5" pattern="[0-9]{5}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="clientNotes">Notes</label>
                    <textarea id="clientNotes" class="input" rows="3" placeholder="Any special notes about this client..."></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeAddClientModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="saveNewClient()" class="button" style="flex: 1;">Add Client</button>
                </div>
            </div>
        </div>

        <!-- Add Worker Modal -->
        <div id="addWorkerModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸ‘· Add New Worker</h3>
                    <button class="close-button" onclick="closeAddWorkerModal()">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="workerFirstName">First Name *</label>
                        <input type="text" id="workerFirstName" class="input" placeholder="Mike">
                    </div>
                    
                    <div class="form-group">
                        <label for="workerLastName">Last Name *</label>
                        <input type="text" id="workerLastName" class="input" placeholder="Johnson">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="workerEmail">Email *</label>
                    <input type="email" id="workerEmail" class="input" placeholder="mike.johnson@email.com">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="workerPhone">Phone *</label>
                        <input type="tel" id="workerPhone" class="input" placeholder="(555) 123-4567">
                    </div>
                    
                    <div class="form-group">
                        <label for="workerHourlyRate">Hourly Rate ($) *</label>
                        <input type="number" id="workerHourlyRate" class="input" placeholder="25.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="workerSkills">Skills (comma separated)</label>
                    <input type="text" id="workerSkills" class="input" placeholder="Plumbing, Electrical, Carpentry">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="workerHireDate">Hire Date</label>
                        <input type="date" id="workerHireDate" class="input">
                    </div>
                    
                    <div class="form-group">
                        <label for="workerStatus">Status</label>
                        <select id="workerStatus" class="input">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="on-leave">On Leave</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeAddWorkerModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="saveNewWorker()" class="button" style="flex: 1;">Add Worker</button>
                </div>
            </div>
        </div>

        <!-- Manage Goals Modal -->
        <div id="manageGoalsModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">ðŸŽ¯ Manage Goals</h3>
                    <button class="close-button" onclick="closeManageGoalsModal()">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="showAddGoalForm()" class="button">+ Add New Goal</button>
                </div>
                
                <div id="addGoalForm" style="display: none; background: #1f2a1f; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #19a974; margin-bottom: 15px;">Create New Goal</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="goalTitle">Goal Title *</label>
                            <input type="text" id="goalTitle" class="input" placeholder="e.g., Monthly Revenue Target">
                        </div>
                        
                        <div class="form-group">
                            <label for="goalWorker">Assign to Worker</label>
                            <select id="goalWorker" class="input">
                                <option value="">Company-wide goal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="goalType">Goal Type</label>
                            <select id="goalType" class="input">
                                <option value="revenue">Revenue ($)</option>
                                <option value="hours">Hours</option>
                                <option value="jobs">Jobs Completed</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="goalTarget">Target Amount *</label>
                            <input type="number" id="goalTarget" class="input" placeholder="5000" step="0.01" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="goalPeriod">Period</label>
                            <select id="goalPeriod" class="input">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="hideAddGoalForm()" class="button button-secondary">Cancel</button>
                        <button onclick="saveNewGoal()" class="button">Create Goal</button>
                    </div>
                </div>
                
                <div id="goalsList">
                    <!-- Goals will be populated here -->
                </div>
            </div>
        </div>

        <!-- Cloud Setup Modal -->
        <div id="cloudSetupModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3 class="modal-title">â˜ï¸ Cloud Storage Setup</h3>
                    <button class="close-button" onclick="closeCloudSetupModal()">&times;</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="background: #1f2a1f; padding: 20px; border-radius: 8px; border-left: 4px solid #19a974; margin-bottom: 20px;">
                        <div style="color: #19a974; font-weight: 600; margin-bottom: 10px;">ðŸš€ Enable Cloud Sync</div>
                        <div style="color: #98bfa7; font-size: 14px; line-height: 1.5;">
                            Connect your app to Firebase for real-time cloud storage. Your data will sync across all devices and be safely backed up in Google's cloud infrastructure.
                        </div>
                    </div>
                    
                    <div id="cloudStatus" style="padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #dc3545; color: white;">
                        <div style="font-weight: 600; margin-bottom: 5px;">âŒ Cloud Storage: Disabled</div>
                        <div style="font-size: 14px;">Currently using local storage only. Set up Firebase to enable cloud sync.</div>
                    </div>
                </div>
                
                <div id="setupInstructions" style="margin-bottom: 20px;">
                    <h4 style="color: #19a974; margin-bottom: 15px;">ðŸ“‹ Setup Instructions</h4>
                    
                    <div style="background: #0f1a0f; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600; margin-bottom: 10px;">Step 1: Create Firebase Project</div>
                        <ol style="color: #98bfa7; font-size: 14px; line-height: 1.6; margin-left: 20px;">
                            <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color: #19a974;">Firebase Console</a></li>
                            <li>Click "Create a project" or "Add project"</li>
                            <li>Enter project name (e.g., "handyman-app")</li>
                            <li>Disable Google Analytics (optional)</li>
                            <li>Click "Create project"</li>
                        </ol>
                    </div>
                    
                    <div style="background: #0f1a0f; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600; margin-bottom: 10px;">Step 2: Add Web App</div>
                        <ol style="color: #98bfa7; font-size: 14px; line-height: 1.6; margin-left: 20px;">
                            <li>In your Firebase project, click the web icon (&lt;/&gt;)</li>
                            <li>Enter app nickname (e.g., "Handyman Web App")</li>
                            <li>Check "Also set up Firebase Hosting" (optional)</li>
                            <li>Click "Register app"</li>
                        </ol>
                    </div>
                    
                    <div style="background: #0f1a0f; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600; margin-bottom: 10px;">Step 3: Enable Firestore Database</div>
                        <ol style="color: #98bfa7; font-size: 14px; line-height: 1.6; margin-left: 20px;">
                            <li>Go to "Firestore Database" in the left sidebar</li>
                            <li>Click "Create database"</li>
                            <li>Choose "Start in test mode" for now</li>
                            <li>Select your preferred location</li>
                            <li>Click "Done"</li>
                        </ol>
                    </div>
                    
                    <div style="background: #0f1a0f; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #19a974; font-weight: 600; margin-bottom: 10px;">Step 4: Get Configuration</div>
                        <ol style="color: #98bfa7; font-size: 14px; line-height: 1.6; margin-left: 20px;">
                            <li>Go to Project Settings (gear icon)</li>
                            <li>Scroll down to "Your apps" section</li>
                            <li>Find your web app and click "Config"</li>
                            <li>Copy the firebaseConfig object</li>
                            <li>Paste it in the form below</li>
                        </ol>
                    </div>
                </div>
                
                <div style="background: #1f2a1f; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #19a974; margin-bottom: 15px;">ðŸ”§ Firebase Configuration</h4>
                    
                    <div class="form-group">
                        <label for="firebaseApiKey">API Key *</label>
                        <input type="text" id="firebaseApiKey" class="input" placeholder="AIzaSyC...">
                    </div>
                    
                    <div class="form-group">
                        <label for="firebaseAuthDomain">Auth Domain *</label>
                        <input type="text" id="firebaseAuthDomain" class="input" placeholder="your-project.firebaseapp.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="firebaseProjectId">Project ID *</label>
                        <input type="text" id="firebaseProjectId" class="input" placeholder="your-project-id">
                    </div>
                    
                    <div class="form-group">
                        <label for="firebaseStorageBucket">Storage Bucket</label>
                        <input type="text" id="firebaseStorageBucket" class="input" placeholder="your-project.appspot.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="firebaseMessagingSenderId">Messaging Sender ID</label>
                        <input type="text" id="firebaseMessagingSenderId" class="input" placeholder="123456789">
                    </div>
                    
                    <div class="form-group">
                        <label for="firebaseAppId">App ID *</label>
                        <input type="text" id="firebaseAppId" class="input" placeholder="1:123456789:web:abc123">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="testFirebaseConnection()" class="button button-secondary" style="flex: 1;">ðŸ§ª Test Connection</button>
                        <button onclick="saveFirebaseConfig()" class="button" style="flex: 1;">ðŸ’¾ Save & Enable Cloud</button>
                    </div>
                </div>
                
                <div id="connectionTest" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- Test results will appear here -->
                </div>
                
                <div style="background: #0f1a0f; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="color: #19a974; font-weight: 600; margin-bottom: 8px;">ðŸ’¡ Pro Tips</div>
                    <ul style="color: #98bfa7; font-size: 14px; line-height: 1.5; margin-left: 20px;">
                        <li>Firebase offers generous free usage limits</li>
                        <li>Your data is encrypted and secure</li>
                        <li>Works offline - syncs when back online</li>
                        <li>Real-time updates across all devices</li>
                        <li>Automatic backups included</li>
                    </ul>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="closeCloudSetupModal()" class="button button-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Edit Job Modal -->
        <div id="editJobModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">âœï¸ Edit Job</h3>
                    <button class="close-button" onclick="closeEditJobModal()">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editJobTitle">Job Title *</label>
                        <input type="text" id="editJobTitle" class="input">
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobClient">Client *</label>
                        <select id="editJobClient" class="input">
                            <option value="">Select a client</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editJobDescription">Description</label>
                    <textarea id="editJobDescription" class="input" rows="3"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editJobHourlyRate">Hourly Rate ($)</label>
                        <input type="number" id="editJobHourlyRate" class="input" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobEstimatedHours">Est. Hours</label>
                        <input type="number" id="editJobEstimatedHours" class="input" step="0.5" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobPriority">Priority</label>
                        <select id="editJobPriority" class="input">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editJobScheduledDate">Scheduled Date</label>
                        <input type="datetime-local" id="editJobScheduledDate" class="input">
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobStatus">Status</label>
                        <select id="editJobStatus" class="input">
                            <option value="pending">Pending</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editJobStreet">Job Street Address</label>
                    <input type="text" id="editJobStreet" class="input" placeholder="123 Main St">
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="editJobCity">City</label>
                        <input type="text" id="editJobCity" class="input" placeholder="St. George">
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobState">State</label>
                        <select id="editJobState" class="input">
                            <option value="">Select State</option>
                            <option value="UT">Utah</option>
                            <option value="AZ">Arizona</option>
                            <option value="NV">Nevada</option>
                            <option value="CO">Colorado</option>
                            <option value="ID">Idaho</option>
                            <option value="WY">Wyoming</option>
                            <option value="CA">California</option>
                            <option value="NM">New Mexico</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editJobZipcode">Zip Code</label>
                        <input type="text" id="editJobZipcode" class="input" placeholder="84770" maxlength="5" pattern="[0-9]{5}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editJobNotes">Notes</label>
                    <textarea id="editJobNotes" class="input" rows="2"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="closeEditJobModal()" class="button button-secondary" style="flex: 1;">Cancel</button>
                    <button onclick="updateJob()" class="button" style="flex: 1;">Update Job</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== ROBUST DATABASE SYSTEM =====
        
        class HandymanDatabase {
            constructor() {
                this.dbName = 'HandymanSouthernUtahDB';
                this.version = 1.0;
                this.tables = {
                    jobs: 'handyman_jobs',
                    clients: 'handyman_clients', 
                    users: 'handyman_users',
                    workers: 'handyman_workers',
                    timeEntries: 'handyman_time_entries',
                    estimates: 'handyman_estimates',
                    clientRequests: 'handyman_client_requests',
                    serviceCatalog: 'handyman_service_catalog',
                    jobTemplates: 'handyman_job_templates',
                    workerGoals: 'handyman_worker_goals',
                    appSettings: 'handyman_app_settings',
                    geofences: 'handyman_geofences',
                    locationLogs: 'handyman_location_logs',
                    backups: 'handyman_backups'
                };
                this.init();
            }

            loadSavedFirebaseConfig() {
                try {
                    const saved = localStorage.getItem('firebaseConfig');
                    if (saved) {
                        const config = JSON.parse(saved);
                        // Only enable cloud if we have a valid config
                        if (config.apiKey && config.projectId && config.apiKey !== 'your-api-key-here') {
                            this.useCloud = true;
                            console.log('âœ… Loaded saved Firebase configuration');
                            return config;
                        }
                    }
                } catch (error) {
                    console.error('âŒ Failed to load saved Firebase config:', error);
                }
                return null;
            }

            init() {
                console.log('ðŸ—„ï¸ Initializing Handyman Database System...');
                this.createDefaultData();
            }

            createDefaultData() {
                // Create default admin user if none exists
                const users = this.load('users');
                if (!users || users.length === 0) {
                    const defaultUsers = [
                        {
                            id: 1,
                            username: 'admin',
                            password: 'admin123',
                            name: 'Admin User',
                            role: 'admin',
                            email: 'admin@handymansouthernutah.com',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('users', defaultUsers);
                }

                // Create default workers if none exist
                const workers = this.load('workers');
                if (!workers || workers.length === 0) {
                    const defaultWorkers = [
                        {
                            id: 1,
                            name: 'John Smith',
                            email: 'john@handymansouthernutah.com',
                            phone: '555-0101',
                            hourlyRate: 25.00,
                            status: 'active',
                            skills: ['Plumbing', 'Electrical', 'General Repair'],
                            hireDate: '2024-01-01',
                            totalEarnings: 2450.00,
                            hoursWorked: 98,
                            jobsCompleted: 15,
                            currentlyWorking: false,
                            userId: 101,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: 'Mike Johnson',
                            email: 'mike@handymansouthernutah.com',
                            phone: '555-0102',
                            hourlyRate: 30.00,
                            status: 'active',
                            skills: ['Carpentry', 'Painting', 'Drywall'],
                            hireDate: '2024-01-15',
                            totalEarnings: 1800.00,
                            hoursWorked: 60,
                            jobsCompleted: 12,
                            currentlyWorking: true,
                            userId: 102,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('workers', defaultWorkers);
                }

                // Create default geofences if none exist
                const geofences = this.load('geofences');
                if (!geofences || geofences.length === 0) {
                    const defaultGeofences = [
                        {
                            id: 1,
                            name: 'Main Work Area - St. George',
                            centerLat: 37.0965,
                            centerLng: -113.5684,
                            radius: 50000, // 50km radius
                            active: true,
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            name: 'Cedar City Area',
                            centerLat: 37.6781,
                            centerLng: -113.0618,
                            radius: 30000, // 30km radius
                            active: true,
                            createdAt: new Date().toISOString()
                        }
                    ];
                    this.save('geofences', defaultGeofences);
                }

                // Create default goals if none exist
                const goals = this.load('workerGoals');
                if (!goals || goals.length === 0) {
                    const defaultGoals = [
                        {
                            id: 1,
                            workerId: null, // Company-wide goal
                            title: 'Monthly Revenue Target',
                            type: 'revenue',
                            target: 5000,
                            current: 3250,
                            period: 'monthly',
                            startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString(),
                            endDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).toISOString(),
                            active: true
                        },
                        {
                            id: 2,
                            workerId: 1,
                            title: 'Weekly Hours Goal',
                            type: 'hours',
                            target: 40,
                            current: 28,
                            period: 'weekly',
                            startDate: new Date().toISOString(),
                            endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            active: true
                        }
                    ];
                    this.save('workerGoals', defaultGoals);
                }

                // Create sample clients if none exist
                const clients = this.load('clients');
                if (!clients || clients.length === 0) {
                    const sampleClients = [
                        {
                            id: 1,
                            name: 'Sarah Johnson',
                            firstName: 'Sarah',
                            lastName: 'Johnson',
                            email: 'sarah.johnson@email.com',
                            phone: '(435) 555-0123',
                            type: 'residential',
                            address: '123 Main St, St. George, UT 84770',
                            notes: 'Prefers morning appointments',
                            totalJobs: 3,
                            totalSpent: 450.00,
                            createdAt: '2024-01-10T10:00:00.000Z',
                            updatedAt: '2024-01-15T14:30:00.000Z'
                        },
                        {
                            id: 2,
                            name: 'Mountain View Properties',
                            firstName: 'Mountain View',
                            lastName: 'Properties',
                            email: 'contact@mountainviewproperties.com',
                            phone: '(435) 555-0456',
                            type: 'property-management',
                            address: '456 Business Blvd, St. George, UT 84770',
                            notes: 'Property management company - multiple locations',
                            totalJobs: 8,
                            totalSpent: 1250.00,
                            createdAt: '2024-01-05T09:00:00.000Z',
                            updatedAt: '2024-01-20T16:45:00.000Z'
                        },
                        {
                            id: 3,
                            name: 'Robert Chen',
                            firstName: 'Robert',
                            lastName: 'Chen',
                            email: 'robert.chen@email.com',
                            phone: '(435) 555-0789',
                            type: 'residential',
                            address: '789 Oak Avenue, Cedar City, UT 84720',
                            notes: 'New customer - referred by Sarah Johnson',
                            totalJobs: 1,
                            totalSpent: 125.00,
                            createdAt: '2024-01-18T11:15:00.000Z',
                            updatedAt: '2024-01-18T11:15:00.000Z'
                        }
                    ];
                    this.save('clients', sampleClients);
                }

                // Create sample jobs if none exist
                const jobs = this.load('jobs');
                if (!jobs || jobs.length === 0) {
                    const sampleJobs = [
                        {
                            id: 1,
                            title: 'Kitchen Faucet Repair',
                            clientId: 1,
                            clientName: 'Sarah Johnson',
                            description: 'Replace leaky kitchen faucet and check water pressure',
                            hourlyRate: 45.00,
                            estimatedHours: 2,
                            priority: 'medium',
                            scheduledDate: '2024-01-25T10:00:00',
                            status: 'scheduled',
                            address: '123 Main St, St. George, UT 84770',
                            notes: 'Customer will provide new faucet',
                            totalHours: 0,
                            totalEarnings: 0,
                            createdAt: '2024-01-20T09:30:00.000Z',
                            updatedAt: '2024-01-20T09:30:00.000Z'
                        },
                        {
                            id: 2,
                            title: 'Bathroom Tile Replacement',
                            clientId: 2,
                            clientName: 'Mountain View Properties',
                            description: 'Replace cracked tiles in unit 4B bathroom',
                            hourlyRate: 50.00,
                            estimatedHours: 6,
                            priority: 'high',
                            scheduledDate: '2024-01-23T08:00:00',
                            status: 'in-progress',
                            address: '456 Business Blvd, Unit 4B, St. George, UT 84770',
                            notes: 'Tenant will be out 8am-5pm',
                            totalHours: 3.5,
                            totalEarnings: 175.00,
                            createdAt: '2024-01-15T14:20:00.000Z',
                            updatedAt: '2024-01-22T16:45:00.000Z'
                        },
                        {
                            id: 3,
                            title: 'Deck Staining',
                            clientId: 1,
                            clientName: 'Sarah Johnson',
                            description: 'Clean and stain back deck - approximately 200 sq ft',
                            hourlyRate: 40.00,
                            estimatedHours: 4,
                            priority: 'low',
                            scheduledDate: '2024-01-28T09:00:00',
                            status: 'pending',
                            address: '123 Main St, St. George, UT 84770',
                            notes: 'Weather dependent - need 2 dry days',
                            totalHours: 0,
                            totalEarnings: 0,
                            createdAt: '2024-01-18T11:00:00.000Z',
                            updatedAt: '2024-01-18T11:00:00.000Z'
                        },
                        {
                            id: 4,
                            title: 'Electrical Outlet Installation',
                            clientId: 3,
                            clientName: 'Robert Chen',
                            description: 'Install 3 new GFCI outlets in garage',
                            hourlyRate: 55.00,
                            estimatedHours: 3,
                            priority: 'medium',
                            scheduledDate: '',
                            status: 'pending',
                            address: '789 Oak Avenue, Cedar City, UT 84720',
                            notes: 'Customer needs permit first',
                            totalHours: 0,
                            totalEarnings: 0,
                            createdAt: '2024-01-19T15:30:00.000Z',
                            updatedAt: '2024-01-19T15:30:00.000Z'
                        },
                        {
                            id: 5,
                            title: 'Drywall Patch and Paint',
                            clientId: 2,
                            clientName: 'Mountain View Properties',
                            description: 'Patch holes and repaint living room in unit 2A',
                            hourlyRate: 42.00,
                            estimatedHours: 5,
                            priority: 'medium',
                            scheduledDate: '2024-01-15T09:00:00',
                            status: 'completed',
                            address: '456 Business Blvd, Unit 2A, St. George, UT 84770',
                            notes: 'Completed ahead of schedule',
                            totalHours: 4.5,
                            totalEarnings: 189.00,
                            createdAt: '2024-01-12T10:15:00.000Z',
                            updatedAt: '2024-01-15T17:30:00.000Z'
                        }
                    ];
                    this.save('jobs', sampleJobs);
                }

                // Initialize other tables
                if (!this.load('estimates')) this.save('estimates', []);
                if (!this.load('clientRequests')) this.save('clientRequests', []);
                if (!this.load('estimates')) this.save('estimates', []);
                if (!this.load('clientRequests')) this.save('clientRequests', []);
                if (!this.load('timeEntries')) this.save('timeEntries', []);
                if (!this.load('locationLogs')) this.save('locationLogs', []);
            }

            save(table, data) {
                try {
                    const key = this.tables[table];
                    if (!key) {
                        throw new Error(`Unknown table: ${table}`);
                    }
                    
                    const serialized = JSON.stringify(data);
                    localStorage.setItem(key, serialized);
                    
                    console.log(`ðŸ’¾ Saved ${Array.isArray(data) ? data.length : 1} records to ${table}`);
                    return true;
                } catch (error) {
                    console.error(`âŒ Failed to save to ${table}:`, error);
                    return false;
                }
            }

            load(table) {
                try {
                    const key = this.tables[table];
                    if (!key) {
                        throw new Error(`Unknown table: ${table}`);
                    }
                    
                    const data = localStorage.getItem(key);
                    if (!data) {
                        console.log(`ðŸ“‚ No data found for ${table}, returning empty array`);
                        return [];
                    }
                    
                    const parsed = JSON.parse(data);
                    console.log(`ðŸ“‚ Loaded ${Array.isArray(parsed) ? parsed.length : 1} records from ${table}`);
                    return parsed;
                } catch (error) {
                    console.error(`âŒ Failed to load from ${table}:`, error);
                    return [];
                }
            }

            addClientRequest(request) {
                console.log('ðŸ“ Adding new client request:', request);
                const requests = this.load('clientRequests');
                request.id = Date.now() + Math.random(); // Ensure unique ID
                request.createdAt = new Date().toISOString();
                request.status = 'pending';
                request.read = false;
                requests.push(request);
                
                const saved = this.save('clientRequests', requests);
                console.log('ðŸ’¾ Client request saved:', saved);
                
                // Update notification count immediately
                setTimeout(() => {
                    this.updateNotificationCount();
                    console.log('ðŸ”” Notification count updated');
                }, 100);
                
                return request;
            }

            updateNotificationCount() {
                const requests = this.load('clientRequests');
                const unreadCount = requests.filter(r => !r.read && r.status === 'pending').length;
                
                console.log(`ðŸ”” Updating notification count: ${unreadCount} unread requests`);
                
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'flex';
                        console.log(`âœ… Badge updated: ${unreadCount} notifications`);
                    } else {
                        badge.style.display = 'none';
                        console.log('âœ… Badge hidden: no notifications');
                    }
                } else {
                    console.log('âš ï¸ Notification badge element not found');
                }
                
                return unreadCount;
            }

            getClientRequests(filters = {}) {
                let requests = this.load('clientRequests');
                
                if (filters.status) {
                    requests = requests.filter(r => r.status === filters.status);
                }
                
                if (filters.type) {
                    requests = requests.filter(r => r.type === filters.type);
                }
                
                if (filters.urgency) {
                    requests = requests.filter(r => r.urgency === filters.urgency);
                }
                
                return requests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            markRequestAsRead(requestId) {
                const requests = this.load('clientRequests');
                const request = requests.find(r => r.id === requestId);
                if (request) {
                    request.read = true;
                    this.save('clientRequests', requests);
                    this.updateNotificationCount();
                }
            }

            markRequestAsProcessed(requestId) {
                const requests = this.load('clientRequests');
                const request = requests.find(r => r.id === requestId);
                if (request) {
                    request.status = 'processed';
                    request.processedAt = new Date().toISOString();
                    this.save('clientRequests', requests);
                    this.updateNotificationCount();
                }
            }
        }

        // Initialize database
        const db = new HandymanDatabase();
        let currentUser = null;
        let currentClientUser = null;
        let isClientView = false;

        // Geolocation and Time Tracking
        let currentLocation = null;
        let locationWatcher = null;
        let isInsideGeofence = false;
        let timeTracker = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            pausedTime: 0,
            currentJobId: null,
            sessionSeconds: 0,
            interval: null
        };

        // App initialization
        function initApp() {
            console.log('ðŸš€ Initializing Handyman App...');
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                console.log('âœ… App initialized successfully');
            }, 1000);

            setupEventListeners();
            updateCurrentDate();
            
            // Update notification count on load
            db.updateNotificationCount();
        }

        function setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Main app buttons
            // Cloud Setup button removed
            document.getElementById('addJobBtn').addEventListener('click', showAddJobModal);
            
            document.getElementById('addClientBtn').addEventListener('click', showAddClientModal);

            document.getElementById('addWorkerBtn').addEventListener('click', showAddWorkerModal);

            document.getElementById('manageGoalsBtn').addEventListener('click', showManageGoalsModal);
            
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('clientViewBtn').addEventListener('click', showClientView);
            
            // Client requests
            document.getElementById('requestNotificationBtn').addEventListener('click', showClientRequests);
            
            // Login form buttons
            document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
                alert('Password reset functionality coming soon! Please contact your administrator.');
            });
            
            const newClientBtn = document.getElementById('showRegisterBtn');
            if (newClientBtn) {
                newClientBtn.addEventListener('click', () => {
                    // Use the modal registration form rather than alerts
                    if (typeof window.showRegisterModal === 'function') {
                        window.showRegisterModal();
                    } else {
                        alert('Registration modal is not available. Please contact support.');
                    }
                });
            }
            
            // Remove first-time client login button event; the button has been
            // removed from the markup. Check existence before binding to
            // avoid errors in environments where the element does not exist.
            const firstTimeLoginBtn = document.getElementById('showNewClientLoginBtn');
            if (firstTimeLoginBtn) {
                firstTimeLoginBtn.addEventListener('click', () => {
                    alert('First-time client login setup coming soon! Please contact us for your login credentials.');
                });
            }
            
            // Debug buttons removed (Test Location and Test Notification)
            
            // Time tracker controls (check if elements exist first)
            const startTimer = document.getElementById('startTimer');
            const pauseTimer = document.getElementById('pauseTimer');
            const stopTimer = document.getElementById('stopTimer');
            const currentJobSelect = document.getElementById('currentJobSelect');
            
            if (startTimer) startTimer.addEventListener('click', startTimeTracking);
            if (pauseTimer) pauseTimer.addEventListener('click', pauseTimeTracking);
            if (stopTimer) stopTimer.addEventListener('click', stopTimeTracking);
            if (currentJobSelect) currentJobSelect.addEventListener('change', selectCurrentJob);
            
            // Client portal buttons
            document.getElementById('requestEstimateBtn').addEventListener('click', showEstimateModal);
            document.getElementById('scheduleServiceBtn').addEventListener('click', showServiceModal);
            document.getElementById('clientLogoutBtn').addEventListener('click', handleClientLogout);
            document.getElementById('returnToAdminBtn').addEventListener('click', returnToAdmin);

            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    const tab = e.target.dataset.tab;
                    const clientSection = e.target.dataset.clientSection;
                    const clientTab = e.target.dataset.clientTab;
                    
                    if (section) {
                        switchSection(section);
                    } else if (tab) {
                        switchJobTab(tab);
                    } else if (clientSection) {
                        switchClientSection(clientSection);
                    } else if (clientTab) {
                        switchClientTab(clientTab);
                    }
                });
            });

            // Enter key for login
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Password toggle functionality
            document.getElementById('togglePassword').addEventListener('click', () => {
                const passwordField = document.getElementById('password');
                const toggleBtn = document.getElementById('togglePassword');
                
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    toggleBtn.textContent = 'ðŸ™ˆ';
                } else {
                    passwordField.type = 'password';
                    toggleBtn.textContent = 'ðŸ‘ï¸';
                }
            });
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'Please enter both username and password');
                return;
            }

            const users = db.load('users');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginForm').style.display = 'none';
                
                if (user.role === 'client') {
                    // Show client portal
                    currentClientUser = user;
                    showClientPortal();
                } else {
                    // Show admin app
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userName').textContent = user.name;
                    loadDashboard();
                }
            } else {
                showError(errorDiv, 'Invalid username or password');
            }
        }

        function handleLogout() {
            currentUser = null;
            currentClientUser = null;
            isClientView = false;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function handleClientLogout() {
            handleLogout();
        }

        function showClientView() {
            // For demo purposes, show client portal directly
            // In real app, you'd select which client to view as
            isClientView = true;
            document.getElementById('mainApp').style.display = 'none';
            showClientPortal();
            document.getElementById('returnToAdminBtn').style.display = 'inline-block';
        }

        function returnToAdmin() {
            console.log('ðŸ”™ Returning to admin view...');
            isClientView = false;
            document.getElementById('clientPortal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Hide the return button in client portal
            const returnBtn = document.getElementById('returnToAdminBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }
            
            // Refresh admin dashboard
            loadDashboard();
            showSuccess('Returned to admin view');
        }

        function showClientPortal() {
            document.getElementById('clientPortal').style.display = 'block';
            document.getElementById('clientCurrentDate').textContent = document.getElementById('currentDate').textContent;
            
            if (currentClientUser) {
                document.getElementById('clientUserName').textContent = currentClientUser.name;
            } else {
                document.getElementById('clientUserName').textContent = 'Demo Client';
            }
            
            loadClientDashboard();
        }

        function loadDashboard() {
            updateStats();
            loadJobs();
            loadClients();
            loadWorkers();
            initializeGeolocation();
            loadJobsForTimeTracker();
            updateTimeTrackerDisplay();
            loadGoalsProgress();
            db.updateNotificationCount();
        }

        // ===== GEOLOCATION SYSTEM =====
        
        function initializeGeolocation() {
            console.log('ðŸŒ Initializing geolocation system...');
            
            if (!navigator.geolocation) {
                console.error('âŒ Geolocation not supported by this browser');
                updateLocationStatus('âŒ', 'Location not supported', 'unknown');
                return;
            }

            updateLocationStatus('ðŸ”', 'Getting location...', 'unknown');
            
            // Get initial position with better error handling
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('âœ… Initial location obtained:', position.coords);
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('ðŸ“ Current location:', currentLocation);
                    checkGeofenceStatus();
                    logLocation();
                    
                    // Start watching position
                    startLocationWatcher();
                },
                (error) => {
                    console.error('âŒ Geolocation error:', error);
                    let errorMessage = 'Location error';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location timeout';
                            break;
                        default:
                            errorMessage = 'Unknown location error';
                            break;
                    }
                    
                    updateLocationStatus('âŒ', errorMessage, 'unknown');
                    
                    // For demo purposes, use a default location (St. George, UT)
                    console.log('ðŸŽ­ Using demo location for testing');
                    currentLocation = {
                        lat: 37.0965,
                        lng: -113.5684,
                        accuracy: 100,
                        timestamp: new Date().toISOString(),
                        isDemo: true
                    };
                    
                    setTimeout(() => {
                        updateLocationStatus('ðŸŽ­', 'Using demo location', 'inside');
                        checkGeofenceStatus();
                    }, 2000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 300000
                }
            );
        }

        function startLocationWatcher() {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
                console.log('ðŸ”„ Cleared previous location watcher');
            }

            console.log('ðŸ‘€ Starting location watcher...');
            
            locationWatcher = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('ðŸ“ Location update received:', position.coords);
                    
                    // Only update if location has changed significantly (more than 10 meters)
                    if (currentLocation) {
                        const distance = calculateDistance(
                            currentLocation.lat, currentLocation.lng,
                            position.coords.latitude, position.coords.longitude
                        );
                        
                        if (distance < 10 && !currentLocation.isDemo && !currentLocation.isTest) {
                            console.log('ðŸ“ Location change too small, skipping update');
                            return;
                        }
                    }
                    
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('ðŸ“ Location updated:', currentLocation);
                    checkGeofenceStatus();
                    
                    // Log location every 5 minutes
                    const lastLog = localStorage.getItem('lastLocationLog');
                    const now = Date.now();
                    if (!lastLog || now - parseInt(lastLog) > 300000) { // 5 minutes
                        logLocation();
                        localStorage.setItem('lastLocationLog', now.toString());
                    }
                },
                (error) => {
                    console.error('âŒ Location watch error:', error);
                    let errorMessage = 'Location tracking interrupted';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location timeout';
                            break;
                    }
                    
                    updateLocationStatus('âš ï¸', errorMessage, 'unknown');
                },
                {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 120000
                }
            );
            
            console.log('âœ… Location watcher started');
        }

        function checkGeofenceStatus() {
            if (!currentLocation) {
                console.log('âš ï¸ No current location available for geofence check');
                return;
            }

            console.log('ðŸ” Checking geofence status for location:', currentLocation);
            
            // Check if we're near any active job locations instead of fixed geofences
            const jobs = db.load('jobs');
            const activeJobs = jobs.filter(j => j.status !== 'completed' && j.address);
            
            console.log('ðŸ“ Active jobs with addresses:', activeJobs.length);
            
            if (activeJobs.length === 0) {
                console.log('âš ï¸ No active jobs with addresses found');
                updateLocationStatus('âš ï¸', 'No active job locations', 'unknown');
                return;
            }
            
            let insideAny = false;
            let closestJob = null;
            let minDistance = Infinity;
            let currentJobLocation = null;

            // Check each job location (we'll need to geocode addresses in a real implementation)
            for (const job of activeJobs) {
                // For demo purposes, we'll use approximate coordinates for known addresses
                const jobCoords = getJobCoordinates(job.address);
                
                if (!jobCoords) {
                    console.log(`âš ï¸ Could not get coordinates for job: ${job.title}`);
                    continue;
                }

                const distance = calculateDistance(
                    currentLocation.lat, 
                    currentLocation.lng,
                    jobCoords.lat, 
                    jobCoords.lng
                );

                console.log(`ðŸ“ Distance to ${job.title}: ${(distance/1000).toFixed(2)}km`);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestJob = job;
                }

                // Consider within 500 meters of job location as "at work"
                if (distance <= 500) {
                    insideAny = true;
                    currentJobLocation = job;
                    console.log(`âœ… At job location: ${job.title}`);
                    break;
                }
            }

            const wasInside = isInsideGeofence;
            isInsideGeofence = insideAny;

            if (insideAny && currentJobLocation) {
                updateLocationStatus('âœ…', `At job: ${currentJobLocation.title}`, 'inside');
                hideGeofenceWarning();
                console.log('âœ… User is at job location');
            } else if (closestJob) {
                const distanceKm = (minDistance / 1000).toFixed(1);
                updateLocationStatus('ðŸ“', `${distanceKm}km from ${closestJob.title}`, 'outside');
                showGeofenceWarning();
                console.log(`ðŸ“ User is ${distanceKm}km from nearest job`);
            } else {
                updateLocationStatus('â“', 'Location status unknown', 'unknown');
                console.log('â“ Could not determine location status');
            }

            // Log geofence status change
            if (wasInside !== isInsideGeofence) {
                console.log(`ðŸ”„ Job location status changed: ${wasInside ? 'at job' : 'away'} â†’ ${isInsideGeofence ? 'at job' : 'away'}`);
            }

            // Update location details in time tracker
            updateLocationDetails();
        }

        // Helper function to get coordinates for job addresses
        function getJobCoordinates(address) {
            // In a real implementation, you'd use Google Geocoding API
            // For demo purposes, we'll map some common addresses to coordinates
            const addressMap = {
                '123 Main St, St. George, UT 84770': { lat: 37.0965, lng: -113.5684 },
                '456 Business Blvd, St. George, UT 84770': { lat: 37.1041, lng: -113.5841 },
                '456 Business Blvd, Unit 4B, St. George, UT 84770': { lat: 37.1041, lng: -113.5841 },
                '456 Business Blvd, Unit 2A, St. George, UT 84770': { lat: 37.1041, lng: -113.5841 },
                '789 Oak Avenue, Cedar City, UT 84720': { lat: 37.6781, lng: -113.0618 }
            };
            
            // Try exact match first
            if (addressMap[address]) {
                return addressMap[address];
            }
            
            // Try partial matches for similar addresses
            for (const [mapAddress, coords] of Object.entries(addressMap)) {
                if (address.toLowerCase().includes(mapAddress.toLowerCase().split(',')[0])) {
                    return coords;
                }
            }
            
            // Default to St. George center if no match found
            console.log(`âš ï¸ No coordinates found for address: ${address}, using St. George center`);
            return { lat: 37.0965, lng: -113.5684 };
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateLocationStatus(icon, text, status) {
            const statusEl = document.getElementById('locationStatus');
            const iconEl = document.getElementById('locationIcon');
            const textEl = document.getElementById('locationText');
            
            if (statusEl && iconEl && textEl) {
                iconEl.textContent = icon;
                textEl.textContent = text;
                
                statusEl.className = 'location-status';
                if (status === 'outside') {
                    statusEl.classList.add('outside');
                } else if (status === 'unknown') {
                    statusEl.classList.add('unknown');
                }
                
                statusEl.style.display = 'flex';
            }
        }

        function updateLocationDetails() {
            const detailsEl = document.getElementById('locationDetails');
            if (!detailsEl || !currentLocation) return;

            const accuracy = currentLocation.accuracy ? `Â±${Math.round(currentLocation.accuracy)}m` : 'Unknown accuracy';
            const timestamp = new Date(currentLocation.timestamp).toLocaleTimeString();
            
            detailsEl.innerHTML = `
                Location: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}<br>
                Accuracy: ${accuracy} â€¢ Updated: ${timestamp}
            `;
        }

        function showGeofenceWarning() {
            const warningEl = document.getElementById('geofenceWarning');
            if (warningEl) {
                warningEl.style.display = 'block';
            }
            
            const geofenceInfo = document.getElementById('geofenceInfo');
            if (geofenceInfo) {
                geofenceInfo.classList.add('geofence-warning');
            }
        }

        function hideGeofenceWarning() {
            const warningEl = document.getElementById('geofenceWarning');
            if (warningEl) {
                warningEl.style.display = 'none';
            }
            
            const geofenceInfo = document.getElementById('geofenceInfo');
            if (geofenceInfo) {
                geofenceInfo.classList.remove('geofence-warning');
            }
        }

        function logLocation() {
            if (!currentLocation) return;

            const logs = db.load('locationLogs');
            const logEntry = {
                id: Date.now(),
                ...currentLocation,
                insideGeofence: isInsideGeofence,
                userId: currentUser ? currentUser.id : null
            };
            
            logs.push(logEntry);
            
            // Keep only last 1000 location logs
            if (logs.length > 1000) {
                logs.splice(0, logs.length - 1000);
            }
            
            db.save('locationLogs', logs);
        }

        // ===== TIME TRACKING SYSTEM =====
        
        function loadJobsForTimeTracker() {
            const jobs = db.load('jobs');
            const activeJobs = jobs.filter(j => j.status !== 'completed');
            const select = document.getElementById('currentJobSelect');
            
            if (select) {
                select.innerHTML = '<option value="">Select a job to track time</option>';
                activeJobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.id;
                    option.textContent = `${job.title} - ${job.clientName || 'No client'}`;
                    select.appendChild(option);
                });
            }
        }

        function selectCurrentJob() {
            const select = document.getElementById('currentJobSelect');
            const jobId = select.value;
            
            if (jobId) {
                timeTracker.currentJobId = parseInt(jobId);
                const jobs = db.load('jobs');
                const job = jobs.find(j => j.id === timeTracker.currentJobId);
                
                if (job) {
                    document.getElementById('currentJobInfo').textContent = 
                        `Selected: ${job.title} (${job.clientName || 'No client'}) - $${job.hourlyRate || 0}/hr`;
                }
            } else {
                timeTracker.currentJobId = null;
                document.getElementById('currentJobInfo').textContent = 'No job selected';
            }
            
            updateSessionEarnings();
        }

        function startTimeTracking() {
            if (!timeTracker.currentJobId) {
                alert('Please select a job first');
                return;
            }

            if (!isInsideGeofence) {
                if (!confirm('You are not at a job location. Start tracking anyway?')) {
                    return;
                }
            }

            timeTracker.isRunning = true;
            timeTracker.isPaused = false;
            timeTracker.startTime = Date.now() - timeTracker.pausedTime;
            
            // Update UI
            document.getElementById('startTimer').style.display = 'none';
            document.getElementById('pauseTimer').style.display = 'inline-block';
            document.getElementById('stopTimer').style.display = 'inline-block';
            
            // Start the timer interval
            timeTracker.interval = setInterval(updateTimeDisplay, 1000);
            
            console.log('â±ï¸ Time tracking started for job:', timeTracker.currentJobId);
        }

        function pauseTimeTracking() {
            if (!timeTracker.isRunning) return;

            timeTracker.isPaused = true;
            timeTracker.pausedTime = Date.now() - timeTracker.startTime;
            
            clearInterval(timeTracker.interval);
            
            // Update UI
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = 'â–¶ï¸ Resume';
            
            console.log('â¸ï¸ Time tracking paused');
        }

        function stopTimeTracking() {
            if (!timeTracker.isRunning && !timeTracker.isPaused) return;

            const totalSeconds = timeTracker.isPaused ? 
                Math.floor(timeTracker.pausedTime / 1000) : 
                Math.floor((Date.now() - timeTracker.startTime) / 1000);

            if (totalSeconds < 60) {
                if (!confirm('Session is less than 1 minute. Save anyway?')) {
                    return;
                }
            }

            // Save time entry
            saveTimeEntry(totalSeconds);
            
            // Reset tracker
            timeTracker.isRunning = false;
            timeTracker.isPaused = false;
            timeTracker.startTime = null;
            timeTracker.pausedTime = 0;
            timeTracker.sessionSeconds = 0;
            
            clearInterval(timeTracker.interval);
            
            // Update UI
            document.getElementById('startTimer').style.display = 'inline-block';
            document.getElementById('pauseTimer').style.display = 'none';
            document.getElementById('stopTimer').style.display = 'none';
            document.getElementById('startTimer').textContent = 'â–¶ï¸ Start';
            document.getElementById('timeDisplay').textContent = '00:00:00';
            document.getElementById('sessionEarnings').textContent = 'Session Earnings: $0.00';
            
            // Refresh displays
            updateTimeTrackerDisplay();
            loadGoalsProgress();
            
            showSuccess(`Time entry saved: ${formatTime(totalSeconds)}`);
            console.log('â¹ï¸ Time tracking stopped, entry saved');
        }

        function saveTimeEntry(totalSeconds) {
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === timeTracker.currentJobId);
            
            if (!job) return;

            const timeEntries = db.load('timeEntries');
            const hours = totalSeconds / 3600;
            const earnings = hours * (job.hourlyRate || 0);
            
            const entry = {
                id: Date.now(),
                jobId: timeTracker.currentJobId,
                jobTitle: job.title,
                clientName: job.clientName,
                workerId: currentUser ? currentUser.id : null,
                workerName: currentUser ? currentUser.name : 'Unknown',
                startTime: new Date(timeTracker.startTime).toISOString(),
                endTime: new Date().toISOString(),
                totalSeconds: totalSeconds,
                hours: parseFloat(hours.toFixed(2)),
                hourlyRate: job.hourlyRate || 0,
                earnings: parseFloat(earnings.toFixed(2)),
                location: currentLocation,
                insideGeofence: isInsideGeofence,
                createdAt: new Date().toISOString()
            };
            
            timeEntries.push(entry);
            db.save('timeEntries', timeEntries);
            
            // Update job total time and earnings
            job.totalHours = (job.totalHours || 0) + hours;
            job.totalEarnings = (job.totalEarnings || 0) + earnings;
            job.lastWorked = new Date().toISOString();
            
            db.save('jobs', jobs);
        }

        function updateTimeDisplay() {
            if (!timeTracker.isRunning || timeTracker.isPaused) return;

            const elapsed = Date.now() - timeTracker.startTime;
            const seconds = Math.floor(elapsed / 1000);
            
            timeTracker.sessionSeconds = seconds;
            document.getElementById('timeDisplay').textContent = formatTime(seconds);
            
            updateSessionEarnings();
        }

        function updateSessionEarnings() {
            if (!timeTracker.currentJobId) {
                document.getElementById('sessionEarnings').textContent = 'Session Earnings: $0.00';
                return;
            }

            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === timeTracker.currentJobId);
            
            if (job) {
                const hours = timeTracker.sessionSeconds / 3600;
                const earnings = hours * (job.hourlyRate || 0);
                document.getElementById('sessionEarnings').textContent = 
                    `Session Earnings: $${earnings.toFixed(2)}`;
            }
        }

        function updateTimeTrackerDisplay() {
            const timeEntries = db.load('timeEntries');
            const today = new Date().toDateString();
            
            const todayEntries = timeEntries.filter(entry => 
                new Date(entry.createdAt).toDateString() === today
            );
            
            const todayHours = todayEntries.reduce((sum, entry) => sum + entry.hours, 0);
            const todayEarnings = todayEntries.reduce((sum, entry) => sum + entry.earnings, 0);
            const todayJobs = new Set(todayEntries.map(entry => entry.jobId)).size;
            const avgRate = todayHours > 0 ? todayEarnings / todayHours : 0;
            
            document.getElementById('todayHours').textContent = todayHours.toFixed(1);
            document.getElementById('todayJobs').textContent = todayJobs;
            document.getElementById('todayEarningsTracker').textContent = `$${todayEarnings.toFixed(2)}`;
            document.getElementById('avgHourlyRate').textContent = `$${avgRate.toFixed(2)}`;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function loadClientDashboard() {
            updateClientStats();
            loadClientServices();
        }

        function updateStats() {
            const jobs = db.load('jobs');
            const completedJobs = jobs.filter(j => j.status === 'completed');
            const activeJobs = jobs.filter(j => j.status === 'in-progress');
            
            const totalEarnings = completedJobs.reduce((sum, job) => {
                return sum + (parseFloat(job.totalEarnings) || 0);
            }, 0);

            document.getElementById('totalJobs').textContent = jobs.length;
            document.getElementById('activeJobs').textContent = activeJobs.length;
            document.getElementById('completedJobs').textContent = completedJobs.length;
            document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
            
            // Update earnings section if visible
            updateEarningsSection();
        }

        function updateEarningsSection() {
            const jobs = db.load('jobs');
            const completedJobs = jobs.filter(j => j.status === 'completed');
            const upcomingJobs = jobs.filter(j => j.status !== 'completed' && j.scheduledDate);
            
            const now = new Date();
            const today = now.toDateString();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);
            
            // Completed earnings
            const todayCompleted = completedJobs.filter(j => new Date(j.updatedAt).toDateString() === today);
            const weekCompleted = completedJobs.filter(j => new Date(j.updatedAt) >= weekStart);
            const monthCompleted = completedJobs.filter(j => new Date(j.updatedAt) >= monthStart);
            const sixMonthCompleted = completedJobs.filter(j => new Date(j.updatedAt) >= sixMonthsAgo);
            
            document.getElementById('todayEarnings').textContent = `$${todayCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0).toFixed(2)}`;
            document.getElementById('weekEarnings').textContent = `$${weekCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0).toFixed(2)}`;
            document.getElementById('monthEarnings').textContent = `$${monthCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0).toFixed(2)}`;
            document.getElementById('sixMonthEarnings').textContent = `$${sixMonthCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0).toFixed(2)}`;
            
            // Potential earnings (upcoming jobs)
            const todayUpcoming = upcomingJobs.filter(j => new Date(j.scheduledDate).toDateString() === today);
            const weekUpcoming = upcomingJobs.filter(j => new Date(j.scheduledDate) >= weekStart && new Date(j.scheduledDate) <= new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000));
            const monthUpcoming = upcomingJobs.filter(j => new Date(j.scheduledDate) >= monthStart && new Date(j.scheduledDate) < new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 1));
            const sixMonthUpcoming = upcomingJobs.filter(j => new Date(j.scheduledDate) >= now && new Date(j.scheduledDate) < new Date(now.getFullYear(), now.getMonth() + 6, 1));
            
            const calcPotential = (jobs) => jobs.reduce((sum, j) => sum + ((j.hourlyRate || 0) * (j.estimatedHours || 0)), 0);
            
            const todayPotential = calcPotential(todayUpcoming);
            const weekPotential = calcPotential(weekUpcoming);
            const monthPotential = calcPotential(monthUpcoming);
            const sixMonthPotential = calcPotential(sixMonthUpcoming);
            
            document.getElementById('potentialTodayEarnings').textContent = `$${todayPotential.toFixed(2)}`;
            document.getElementById('potentialWeekEarnings').textContent = `$${weekPotential.toFixed(2)}`;
            document.getElementById('potentialMonthEarnings').textContent = `$${monthPotential.toFixed(2)}`;
            document.getElementById('potentialSixMonthEarnings').textContent = `$${sixMonthPotential.toFixed(2)}`;
            
            // Total projections
            const todayActual = todayCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0);
            const weekActual = weekCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0);
            const monthActual = monthCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0);
            const sixMonthActual = sixMonthCompleted.reduce((sum, j) => sum + (j.totalEarnings || 0), 0);
            
            document.getElementById('totalTodayProjection').textContent = `$${(todayActual + todayPotential).toFixed(2)}`;
            document.getElementById('totalWeekProjection').textContent = `$${(weekActual + weekPotential).toFixed(2)}`;
            document.getElementById('totalMonthProjection').textContent = `$${(monthActual + monthPotential).toFixed(2)}`;
            document.getElementById('totalSixMonthProjection').textContent = `$${(sixMonthActual + sixMonthPotential).toFixed(2)}`;
        }

        function updateClientStats() {
            // Demo client stats
            document.getElementById('clientTotalServices').textContent = '5';
            document.getElementById('clientActiveServices').textContent = '2';
            document.getElementById('clientCompletedServices').textContent = '3';
            document.getElementById('clientTotalSpent').textContent = '$450.00';
        }



        function loadClients() {
            const grid = document.getElementById('clientsGrid');
            const clients = db.load('clients');

            if (clients.length === 0) {
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ðŸ‘¥</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Clients Yet</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            Add your first client to get started!
                        </p>
                        <button onclick="alert('Add Client functionality coming soon!')" class="button">+ Add Your First Client</button>
                    </div>
                `;
                return;
            }

            // Display clients with full functionality
            grid.innerHTML = clients.map(client => `
                <div class="job-card">
                    <div class="job-title">${client.name}</div>
                    <div class="job-status status-${client.type === 'commercial' ? 'in-progress' : 'completed'}">${client.type ? client.type.replace('-', ' ').toUpperCase() : 'RESIDENTIAL'}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Phone:</span>
                            <strong>${client.phone || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Email:</span>
                            <strong>${client.email || 'Not provided'}</strong>
                        </div>
                        ${client.address ? `
                            <div class="job-info-item">
                                <span>Address:</span>
                                <strong>${client.address}</strong>
                            </div>
                        ` : ''}
                        <div class="job-info-item">
                            <span>Total Jobs:</span>
                            <strong>${client.totalJobs || 0}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Total Spent:</span>
                            <strong>$${(client.totalSpent || 0).toFixed(2)}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Member Since:</span>
                            <strong>${formatDate(client.createdAt)}</strong>
                        </div>
                        ${client.notes ? `
                            <div style="margin-top: 10px; padding: 10px; background: #1f2a1f; border-radius: 6px;">
                                <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Notes:</div>
                                <div style="color: #e6ffee; font-size: 14px;">${client.notes}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="job-actions" style="margin-top: 15px;">
                        <button onclick="editClient(${client.id})" class="button button-secondary">âœï¸ Edit</button>
                        <button onclick="viewClientDetails(${client.id})" class="button button-secondary">ðŸ‘ï¸ View</button>
                        <button onclick="callClient('${client.phone}')" class="button" style="background: #28a745;">ðŸ“ž Call</button>
                        <button onclick="deleteClient(${client.id})" class="button button-danger">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadClientServices() {
            const grid = document.getElementById('clientServicesGrid');
            
            // Demo services for client
            const demoServices = [
                {
                    title: 'Kitchen Faucet Repair',
                    status: 'completed',
                    date: '2024-01-15',
                    cost: '$85.00'
                },
                {
                    title: 'Bathroom Tile Replacement',
                    status: 'in-progress',
                    date: '2024-01-20',
                    cost: '$250.00'
                },
                {
                    title: 'Deck Staining',
                    status: 'pending',
                    date: '2024-01-25',
                    cost: '$180.00'
                }
            ];

            grid.innerHTML = demoServices.map(service => `
                <div class="job-card">
                    <div class="job-title">${service.title}</div>
                    <div class="job-status status-${service.status}">${getStatusText(service.status)}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Date:</span>
                            <strong>${formatDate(service.date)}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Cost:</span>
                            <strong>${service.cost}</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showClientRequests() {
            console.log('ðŸ”” Opening client requests modal...');
            
            const allRequests = db.getClientRequests();
            console.log(`ðŸ“‹ Total requests found: ${allRequests.length}`);
            
            const modal = document.getElementById('clientRequestsModal');
            const requestsList = document.getElementById('requestsList');
            
            // Apply filters
            const statusFilter = document.getElementById('requestStatusFilter')?.value || '';
            const typeFilter = document.getElementById('requestTypeFilter')?.value || '';
            const urgencyFilter = document.getElementById('requestUrgencyFilter')?.value || '';
            
            let filteredRequests = allRequests;
            
            if (statusFilter) {
                filteredRequests = filteredRequests.filter(r => r.status === statusFilter);
            }
            if (typeFilter) {
                filteredRequests = filteredRequests.filter(r => r.type === typeFilter);
            }
            if (urgencyFilter) {
                filteredRequests = filteredRequests.filter(r => r.urgency === urgencyFilter);
            }
            
            console.log(`ðŸ“‹ Filtered requests: ${filteredRequests.length}`);
            
            if (filteredRequests.length === 0) {
                requestsList.innerHTML = `
                    <div class="job-card" style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ðŸ“­</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Client Requests</h3>
                        <p style="color: #98bfa7;">
                            ${allRequests.length > 0 ? 'No requests match the current filters.' : 'Client requests for estimates and services will appear here.'}
                        </p>
                        ${allRequests.length > 0 ? '<button onclick="clearRequestFilters()" class="button" style="margin-top: 15px;">Clear Filters</button>' : ''}
                    </div>
                `;
            } else {
                requestsList.innerHTML = filteredRequests.map(request => `
                    <div class="job-card" style="border-left: 4px solid ${request.read ? '#98bfa7' : '#19a974'};">
                        <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                            <div class="job-title" style="flex: 1;">${request.title}</div>
                            <div style="display: flex; gap: 5px;">
                                ${!request.read ? '<span style="background: #19a974; color: #0b0f0b; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">NEW</span>' : ''}
                                <span class="job-status status-${request.status === 'pending' ? 'pending' : 'completed'}">${request.status}</span>
                            </div>
                        </div>
                        
                        <div class="job-info">
                            <div class="job-info-item">
                                <span>Type:</span>
                                <strong>${request.type === 'estimate' ? 'Estimate Request' : 'Service Request'}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Client:</span>
                                <strong>${request.clientName || 'Unknown Client'}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Urgency:</span>
                                <strong style="color: ${getUrgencyColor(request.urgency)}">${request.urgency.toUpperCase()}</strong>
                            </div>
                            <div class="job-info-item">
                                <span>Requested:</span>
                                <strong>${formatDateTime(request.createdAt)}</strong>
                            </div>
                            ${request.description ? `
                                <div style="margin-top: 10px; padding: 10px; background: #1f2a1f; border-radius: 6px;">
                                    <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Description:</div>
                                    <div style="color: #e6ffee; font-size: 14px;">${request.description}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="job-actions" style="margin-top: 15px;">
                            ${request.status === 'pending' ? `
                                <button onclick="markRequestAsRead(${request.id})" class="button button-secondary">âœ“ Mark Read</button>
                                <button onclick="processRequest(${request.id})" class="button">ðŸ“‹ Process Request</button>
                            ` : `
                                <button onclick="viewProcessedRequest(${request.id})" class="button button-secondary">ðŸ‘ï¸ View Details</button>
                            `}
                        </div>
                    </div>
                `).join('');
            }
            
            modal.style.display = 'flex';
            
            // Set up filter event listeners
            setupRequestFilters();
            
            console.log('âœ… Client requests modal opened');
        }
        
        function setupRequestFilters() {
            const statusFilter = document.getElementById('requestStatusFilter');
            const typeFilter = document.getElementById('requestTypeFilter');
            const urgencyFilter = document.getElementById('requestUrgencyFilter');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const clearProcessedBtn = document.getElementById('clearProcessedBtn');
            
            // Remove existing listeners
            [statusFilter, typeFilter, urgencyFilter].forEach(filter => {
                if (filter) {
                    filter.removeEventListener('change', showClientRequests);
                    filter.addEventListener('change', showClientRequests);
                }
            });
            
            if (markAllReadBtn) {
                markAllReadBtn.onclick = markAllRequestsAsRead;
            }
            
            if (clearProcessedBtn) {
                clearProcessedBtn.onclick = clearProcessedRequests;
            }
        }
        
        function clearRequestFilters() {
            document.getElementById('requestStatusFilter').value = '';
            document.getElementById('requestTypeFilter').value = '';
            document.getElementById('requestUrgencyFilter').value = '';
            showClientRequests();
        }
        
        function markAllRequestsAsRead() {
            const requests = db.load('clientRequests');
            let markedCount = 0;
            
            requests.forEach(request => {
                if (!request.read && request.status === 'pending') {
                    request.read = true;
                    markedCount++;
                }
            });
            
            if (markedCount > 0) {
                db.save('clientRequests', requests);
                db.updateNotificationCount();
                showClientRequests(); // Refresh the list
                showSuccess(`Marked ${markedCount} requests as read`);
            } else {
                showSuccess('No unread requests to mark');
            }
        }
        
        function clearProcessedRequests() {
            if (!confirm('Are you sure you want to delete all processed requests? This cannot be undone.')) {
                return;
            }
            
            const requests = db.load('clientRequests');
            const activeRequests = requests.filter(r => r.status === 'pending');
            const removedCount = requests.length - activeRequests.length;
            
            if (removedCount > 0) {
                db.save('clientRequests', activeRequests);
                showClientRequests(); // Refresh the list
                showSuccess(`Removed ${removedCount} processed requests`);
            } else {
                showSuccess('No processed requests to remove');
            }
        }

        function markRequestAsRead(requestId) {
            db.markRequestAsRead(requestId);
            showClientRequests(); // Refresh the list
        }

        function processRequest(requestId) {
            if (confirm('Mark this request as processed?')) {
                db.markRequestAsProcessed(requestId);
                showClientRequests(); // Refresh the list
                showSuccess('Request marked as processed!');
            }
        }

        function closeRequestsModal() {
            document.getElementById('clientRequestsModal').style.display = 'none';
        }

        function showEstimateModal() {
            document.getElementById('requestEstimateModal').style.display = 'flex';
        }

        function closeEstimateModal() {
            document.getElementById('requestEstimateModal').style.display = 'none';
        }

        function submitEstimateRequest() {
            const title = document.getElementById('estimateTitle').value.trim();
            const description = document.getElementById('estimateDescription').value.trim();
            const urgency = document.getElementById('estimateUrgency').value;
            const preferredDate = document.getElementById('estimatePreferredDate').value;

            if (!title) {
                alert('Please enter a service title');
                return;
            }

            const request = {
                type: 'estimate',
                title: title,
                description: description,
                urgency: urgency,
                preferredDate: preferredDate,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            closeEstimateModal();
            showSuccess('Estimate request submitted successfully!');
            
            // Clear form
            document.getElementById('estimateTitle').value = '';
            document.getElementById('estimateDescription').value = '';
            document.getElementById('estimateUrgency').value = 'low';
            document.getElementById('estimatePreferredDate').value = '';
        }

        function showServiceModal() {
            document.getElementById('scheduleServiceModal').style.display = 'flex';
        }

        function closeServiceModal() {
            document.getElementById('scheduleServiceModal').style.display = 'none';
        }

        function submitServiceRequest() {
            const title = document.getElementById('serviceTitle').value.trim();
            const description = document.getElementById('serviceDescription').value.trim();
            const date = document.getElementById('serviceDate').value;
            const recurring = document.getElementById('serviceRecurring').value;

            if (!title || !date) {
                alert('Please enter a service title and preferred date');
                return;
            }

            const request = {
                type: 'service',
                title: title,
                description: description,
                urgency: 'medium', // Default for service requests
                preferredDate: date,
                recurring: recurring,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            closeServiceModal();
            showSuccess('Service request submitted successfully!');
            
            // Clear form
            document.getElementById('serviceTitle').value = '';
            document.getElementById('serviceDescription').value = '';
            document.getElementById('serviceDate').value = '';
            document.getElementById('serviceRecurring').value = '';
        }

        function submitCustomServiceRequest() {
            const title = document.getElementById('customServiceTitle').value.trim();
            const description = document.getElementById('customServiceDescription').value.trim();
            const urgency = document.getElementById('customServiceUrgency').value;
            const date = document.getElementById('customServiceDate').value;

            if (!title || !description) {
                alert('Please enter both a service title and description');
                return;
            }

            const request = {
                type: 'service',
                title: title,
                description: description,
                urgency: urgency,
                preferredDate: date,
                clientName: currentClientUser ? currentClientUser.name : 'Demo Client',
                clientId: currentClientUser ? currentClientUser.id : null
            };

            db.addClientRequest(request);
            showSuccess('Custom service request submitted successfully!');
            
            // Clear form
            document.getElementById('customServiceTitle').value = '';
            document.getElementById('customServiceDescription').value = '';
            document.getElementById('customServiceUrgency').value = 'low';
            document.getElementById('customServiceDate').value = '';
        }

        // Utility functions
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'in-progress': return 'In Progress';
                case 'completed': return 'Completed';
                default: return 'Unknown';
            }
        }

        function getUrgencyColor(urgency) {
            switch (urgency) {
                case 'emergency': return '#dc3545';
                case 'high': return '#fd7e14';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#98bfa7';
            }
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'urgent': return '#dc3545';
                case 'high': return '#fd7e14';
                case 'medium': return '#ffc107';
                case 'low': return '#28a745';
                default: return '#98bfa7';
            }
        }

        // Job Timer Functions
        function startJobTimer(jobId) {
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === jobId);
            
            if (!job) {
                alert('Job not found');
                return;
            }

            if (!isInsideGeofence) {
                if (!confirm('You are not at the job location. Start job anyway?')) {
                    return;
                }
            }

            // Check if another job is already running
            if (timeTracker.isRunning && timeTracker.currentJobId !== jobId) {
                if (!confirm('Another job is currently running. Stop it and start this job?')) {
                    return;
                }
                stopTimeTracking();
            }

            // Start tracking this job
            timeTracker.currentJobId = jobId;
            timeTracker.isRunning = true;
            timeTracker.isPaused = false;
            timeTracker.startTime = Date.now();
            timeTracker.pausedTime = 0;
            
            // Start the timer interval
            timeTracker.interval = setInterval(updateJobTimerDisplay, 1000);
            
            // Update job status to in-progress if it's pending
            if (job.status === 'pending') {
                job.status = 'in-progress';
                job.updatedAt = new Date().toISOString();
                db.save('jobs', jobs);
            }
            
            // Show timer display immediately
            const timerDiv = document.getElementById(`timer-${jobId}`);
            if (timerDiv) {
                timerDiv.style.display = 'block';
            }
            
            // Hide start button and show timer is running
            const startBtn = document.getElementById(`start-btn-${jobId}`);
            if (startBtn) {
                startBtn.style.display = 'none';
            }
            
            showSuccess(`Started working on: ${job.title}`);
            console.log('â±ï¸ Job timer started for:', job.title);
        }

        function updateJobTimerDisplay() {
            if (!timeTracker.isRunning || timeTracker.isPaused) return;

            const elapsed = Date.now() - timeTracker.startTime;
            const seconds = Math.floor(elapsed / 1000);
            
            timeTracker.sessionSeconds = seconds;
            
            // Update any visible timer displays
            const timerDisplays = document.querySelectorAll('.job-timer-display');
            timerDisplays.forEach(display => {
                if (display.dataset.jobId == timeTracker.currentJobId) {
                    display.textContent = formatTime(seconds);
                }
            });
            
            // Show/hide timer displays
            document.querySelectorAll('[id^="timer-"]').forEach(timer => {
                const jobId = parseInt(timer.id.replace('timer-', ''));
                timer.style.display = (jobId === timeTracker.currentJobId && timeTracker.isRunning) ? 'block' : 'none';
            });
        }

        function pauseJobTimer(jobId) {
            if (!timeTracker.isRunning || timeTracker.currentJobId !== jobId) return;

            timeTracker.isPaused = true;
            timeTracker.pausedTime = Date.now() - timeTracker.startTime;
            
            clearInterval(timeTracker.interval);
            
            // Update timer display
            const timerDiv = document.getElementById(`timer-${jobId}`);
            if (timerDiv) {
                timerDiv.style.background = '#ffc107';
                timerDiv.querySelector('div').innerHTML = 'â¸ï¸ TIMER PAUSED';
                timerDiv.querySelector('button[onclick*="pause"]').innerHTML = 'â–¶ï¸ Resume';
                timerDiv.querySelector('button[onclick*="pause"]').onclick = () => resumeJobTimer(jobId);
            }
            
            console.log('â¸ï¸ Job timer paused');
        }

        function resumeJobTimer(jobId) {
            if (!timeTracker.isPaused || timeTracker.currentJobId !== jobId) return;

            timeTracker.isPaused = false;
            timeTracker.startTime = Date.now() - timeTracker.pausedTime;
            
            // Start the timer interval again
            timeTracker.interval = setInterval(updateJobTimerDisplay, 1000);
            
            // Update timer display
            const timerDiv = document.getElementById(`timer-${jobId}`);
            if (timerDiv) {
                timerDiv.style.background = '#28a745';
                timerDiv.querySelector('div').innerHTML = 'â±ï¸ TIMER RUNNING';
                timerDiv.querySelector('button[onclick*="resume"]').innerHTML = 'â¸ï¸ Pause';
                timerDiv.querySelector('button[onclick*="resume"]').onclick = () => pauseJobTimer(jobId);
            }
            
            console.log('â–¶ï¸ Job timer resumed');
        }

        function stopJobTimer(jobId) {
            if (!timeTracker.isRunning && !timeTracker.isPaused) return;
            if (timeTracker.currentJobId !== jobId) return;

            const totalSeconds = timeTracker.isPaused ? 
                Math.floor(timeTracker.pausedTime / 1000) : 
                Math.floor((Date.now() - timeTracker.startTime) / 1000);

            if (totalSeconds < 60) {
                if (!confirm('Session is less than 1 minute. Save anyway?')) {
                    return;
                }
            }

            // Save time entry
            saveTimeEntry(totalSeconds);
            
            // Reset tracker
            timeTracker.isRunning = false;
            timeTracker.isPaused = false;
            timeTracker.startTime = null;
            timeTracker.pausedTime = 0;
            timeTracker.sessionSeconds = 0;
            timeTracker.currentJobId = null;
            
            clearInterval(timeTracker.interval);
            
            // Hide timer display and show start button again
            const timerDiv = document.getElementById(`timer-${jobId}`);
            if (timerDiv) {
                timerDiv.style.display = 'none';
            }
            
            const startBtn = document.getElementById(`start-btn-${jobId}`);
            if (startBtn) {
                startBtn.style.display = 'inline-block';
            }
            
            // Refresh the jobs display
            loadJobs();
            updateStats();
            
            showSuccess(`Time entry saved: ${formatTime(totalSeconds)}`);
            console.log('â¹ï¸ Job timer stopped, entry saved');
        }

        function editClient(clientId) {
            const clients = db.load('clients');
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Client not found');
                return;
            }
            
            // Pre-fill edit form with client data
            document.getElementById('clientFirstName').value = client.firstName || client.name.split(' ')[0] || '';
            document.getElementById('clientLastName').value = client.lastName || client.name.split(' ').slice(1).join(' ') || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientType').value = client.type || 'residential';
            document.getElementById('clientStreet').value = client.street || '';
            document.getElementById('clientCity').value = client.city || '';
            document.getElementById('clientState').value = client.state || '';
            document.getElementById('clientZipcode').value = client.zipcode || '';
            document.getElementById('clientNotes').value = client.notes || '';
            
            // Change modal title and button
            document.querySelector('#addClientModal .modal-title').textContent = 'âœï¸ Edit Client';
            document.querySelector('#addClientModal button[onclick="saveNewClient()"]').textContent = 'Update Client';
            document.querySelector('#addClientModal button[onclick="saveNewClient()"]').onclick = () => updateClient(clientId);
            
            showAddClientModal();
        }

        function updateClient(clientId) {
            const firstName = document.getElementById('clientFirstName').value.trim();
            const lastName = document.getElementById('clientLastName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const type = document.getElementById('clientType').value;
            const street = document.getElementById('clientStreet').value.trim();
            const city = document.getElementById('clientCity').value.trim();
            const state = document.getElementById('clientState').value;
            const zipcode = document.getElementById('clientZipcode').value.trim();
            const notes = document.getElementById('clientNotes').value.trim();
            
            if (!firstName || !lastName || !phone || !street || !city || !state || !zipcode) {
                alert('Please fill in all required fields: name, phone, and complete address');
                return;
            }
            
            const clients = db.load('clients');
            const clientIndex = clients.findIndex(c => c.id === clientId);
            
            if (clientIndex === -1) {
                alert('Client not found');
                return;
            }
            
            const fullAddress = `${street}, ${city}, ${state} ${zipcode}`;
            clients[clientIndex] = {
                ...clients[clientIndex],
                name: `${firstName} ${lastName}`,
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                type: type,
                street: street,
                city: city,
                state: state,
                zipcode: zipcode,
                address: fullAddress,
                notes: notes,
                updatedAt: new Date().toISOString()
            };
            
            db.save('clients', clients);
            closeAddClientModal();
            
            // Reset modal to add mode
            document.querySelector('#addClientModal .modal-title').textContent = 'ðŸ‘¤ Add New Client';
            document.querySelector('#addClientModal button[onclick*="Client"]').textContent = 'Add Client';
            document.querySelector('#addClientModal button[onclick*="Client"]').onclick = saveNewClient;
            
            loadClients();
            showSuccess('Client updated successfully!');
        }

        function viewClientDetails(clientId) {
            const clients = db.load('clients');
            const client = clients.find(c => c.id === clientId);
            
            if (!client) {
                alert('Client not found');
                return;
            }
            
            const jobs = db.load('jobs');
            const clientJobs = jobs.filter(j => j.clientId === clientId);
            const completedJobs = clientJobs.filter(j => j.status === 'completed');
            const totalSpent = completedJobs.reduce((sum, job) => sum + (job.totalEarnings || 0), 0);
            
            const details = `
Client Details: ${client.name}

ðŸ“§ Email: ${client.email || 'Not provided'}
ðŸ“ž Phone: ${client.phone || 'Not provided'}
ðŸ  Type: ${client.type ? client.type.replace('-', ' ').toUpperCase() : 'RESIDENTIAL'}
ðŸ“ Address: ${client.address || 'Not provided'}

ðŸ“Š Statistics:
â€¢ Total Jobs: ${clientJobs.length}
â€¢ Completed Jobs: ${completedJobs.length}
â€¢ Active Jobs: ${clientJobs.filter(j => j.status === 'in-progress').length}
â€¢ Total Spent: $${totalSpent.toFixed(2)}

ðŸ“ Notes: ${client.notes || 'No notes'}

Member Since: ${formatDateTime(client.createdAt)}
Last Updated: ${formatDateTime(client.updatedAt)}
            `;
            
            alert(details);
        }

        function callClient(phone) {
            if (phone && phone !== 'Not provided') {
                window.location.href = `tel:${phone}`;
            } else {
                alert('No phone number available for this client');
            }
        }

        function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client? This action cannot be undone.')) {
                return;
            }
            
            const clients = db.load('clients');
            const filteredClients = clients.filter(c => c.id !== clientId);
            
            db.save('clients', filteredClients);
            loadClients();
            showSuccess('Client deleted successfully!');
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateStr = now.toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = dateStr;
            
            const clientDateEl = document.getElementById('clientCurrentDate');
            if (clientDateEl) {
                clientDateEl.textContent = dateStr;
            }
        }

        function loadWorkers() {
            const workers = db.load('workers');
            const grid = document.getElementById('workersGrid');

            if (workers.length === 0) {
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ðŸ‘·</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Workers Found</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            Add your first worker to get started!
                        </p>
                        <button onclick="alert('Add Worker functionality coming soon!')" class="button">+ Add Your First Worker</button>
                    </div>
                `;
                return;
            }

            // Update worker stats
            const activeWorkers = workers.filter(w => w.status === 'active');
            const workingNow = workers.filter(w => w.currentlyWorking);
            const totalEarnings = workers.reduce((sum, w) => sum + (w.totalEarnings || 0), 0);

            document.getElementById('totalWorkers').textContent = workers.length;
            document.getElementById('activeWorkers').textContent = activeWorkers.length;
            document.getElementById('workingNow').textContent = workingNow.length;
            document.getElementById('totalWorkerEarnings').textContent = `$${totalEarnings.toFixed(2)}`;

            // Display workers
            grid.innerHTML = workers.map(worker => `
                <div class="worker-card">
                    <div class="worker-header">
                        <div class="worker-name">${worker.name}</div>
                        <div class="worker-status status-${worker.status}">
                            ${worker.currentlyWorking ? 'Working' : worker.status}
                        </div>
                    </div>
                    
                    <div class="worker-stats">
                        <div class="worker-stat">
                            <div class="worker-stat-value">$${worker.hourlyRate || 0}</div>
                            <div class="worker-stat-label">Rate/hr</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">${worker.hoursWorked || 0}</div>
                            <div class="worker-stat-label">Hours</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">${worker.jobsCompleted || 0}</div>
                            <div class="worker-stat-label">Jobs</div>
                        </div>
                        <div class="worker-stat">
                            <div class="worker-stat-value">$${(worker.totalEarnings || 0).toFixed(0)}</div>
                            <div class="worker-stat-label">Earnings</div>
                        </div>
                    </div>
                    
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Email:</span>
                            <strong>${worker.email || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Phone:</span>
                            <strong>${worker.phone || 'Not provided'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Skills:</span>
                            <strong>${worker.skills ? worker.skills.join(', ') : 'None listed'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Hire Date:</span>
                            <strong>${formatDate(worker.hireDate)}</strong>
                        </div>
                    </div>
                    
                    <div class="job-actions" style="margin-top: 15px;">
                        <button onclick="viewWorkerDetails(${worker.id})" class="button button-secondary">ðŸ‘ï¸ View Details</button>
                        <button onclick="editWorker(${worker.id})" class="button button-secondary">âœï¸ Edit</button>
                        <button onclick="viewWorkerTimeEntries(${worker.id})" class="button">â±ï¸ Time Entries</button>
                    </div>
                </div>
            `).join('');
        }

        function loadGoalsProgress() {
            const goals = db.load('workerGoals');
            const activeGoals = goals.filter(g => g.active);
            const container = document.getElementById('goalsProgress');

            if (activeGoals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #98bfa7;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ðŸŽ¯</div>
                        <div>No active goals set</div>
                        <button onclick="alert('Goal management coming soon!')" class="button" style="margin-top: 15px; width: auto; padding: 8px 16px;">Set Your First Goal</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeGoals.map(goal => {
                const percentage = Math.min((goal.current / goal.target) * 100, 100);
                const isOverTarget = goal.current > goal.target;
                
                return `
                    <div class="goal-progress">
                        <div class="goal-header">
                            <div class="goal-title">${goal.title}</div>
                            <div class="goal-percentage">${percentage.toFixed(1)}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; ${isOverTarget ? 'background: linear-gradient(90deg, #28a745, #20c997);' : ''}"></div>
                        </div>
                        <div class="goal-details">
                            <span>${goal.current} / ${goal.target} ${goal.type === 'revenue' ? '$' : goal.type === 'hours' ? 'hrs' : ''}</span>
                            <span>${goal.period} goal</span>
                        </div>
                        ${isOverTarget ? '<div style="color: #28a745; font-size: 12px; margin-top: 5px;">ðŸŽ‰ Goal exceeded!</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function viewWorkerDetails(workerId) {
            const workers = db.load('workers');
            const worker = workers.find(w => w.id === workerId);
            
            if (!worker) {
                alert('Worker not found');
                return;
            }
            
            const timeEntries = db.load('timeEntries');
            const workerEntries = timeEntries.filter(entry => entry.workerId === workerId);
            
            const totalHours = workerEntries.reduce((sum, entry) => sum + entry.hours, 0);
            const totalEarnings = workerEntries.reduce((sum, entry) => sum + entry.earnings, 0);
            const avgRate = totalHours > 0 ? totalEarnings / totalHours : 0;
            
            const details = `
Worker Details: ${worker.name}

ðŸ“§ Email: ${worker.email || 'Not provided'}
ðŸ“ž Phone: ${worker.phone || 'Not provided'}
ðŸ’° Hourly Rate: $${worker.hourlyRate || 0}/hr
ðŸ“… Hire Date: ${formatDate(worker.hireDate)}
ðŸ“Š Status: ${worker.status}

ðŸ› ï¸ Skills: ${worker.skills ? worker.skills.join(', ') : 'None listed'}

ðŸ“ˆ Performance:
â€¢ Total Hours: ${totalHours.toFixed(2)}
â€¢ Total Earnings: $${totalEarnings.toFixed(2)}
â€¢ Jobs Completed: ${worker.jobsCompleted || 0}
â€¢ Average Rate: $${avgRate.toFixed(2)}/hr
â€¢ Currently Working: ${worker.currentlyWorking ? 'Yes' : 'No'}

Recent Activity: ${workerEntries.length} time entries
            `;
            
            alert(details);
        }

        function editWorker(workerId) {
            const workers = db.load('workers');
            const worker = workers.find(w => w.id === workerId);
            
            if (!worker) {
                alert('Worker not found');
                return;
            }
            
            // Pre-fill edit form with worker data
            document.getElementById('workerFirstName').value = worker.name.split(' ')[0] || '';
            document.getElementById('workerLastName').value = worker.name.split(' ').slice(1).join(' ') || '';
            document.getElementById('workerEmail').value = worker.email || '';
            document.getElementById('workerPhone').value = worker.phone || '';
            document.getElementById('workerHourlyRate').value = worker.hourlyRate || '';
            document.getElementById('workerSkills').value = worker.skills ? worker.skills.join(', ') : '';
            document.getElementById('workerHireDate').value = worker.hireDate || '';
            document.getElementById('workerStatus').value = worker.status || 'active';
            
            // Change modal title and button
            document.querySelector('#addWorkerModal .modal-title').textContent = 'âœï¸ Edit Worker';
            document.querySelector('#addWorkerModal button[onclick="saveNewWorker()"]').textContent = 'Update Worker';
            document.querySelector('#addWorkerModal button[onclick="saveNewWorker()"]').onclick = () => updateWorker(workerId);
            
            showAddWorkerModal();
        }

        function viewWorkerTimeEntries(workerId) {
            const timeEntries = db.load('timeEntries');
            const workerEntries = timeEntries.filter(entry => entry.workerId === workerId);
            
            if (workerEntries.length === 0) {
                alert('No time entries found for this worker.');
                return;
            }
            
            const totalHours = workerEntries.reduce((sum, entry) => sum + entry.hours, 0);
            const totalEarnings = workerEntries.reduce((sum, entry) => sum + entry.earnings, 0);
            
            alert(`Time Entries Summary:\nTotal Hours: ${totalHours.toFixed(2)}\nTotal Earnings: $${totalEarnings.toFixed(2)}\nEntries: ${workerEntries.length}\n\nDetailed view coming soon!`);
        }

        function switchSection(section) {
            // Update active tab
            document.querySelectorAll('[data-section]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Show/hide sections
            document.getElementById('jobsSection').style.display = section === 'jobs' ? 'block' : 'none';
            document.getElementById('clientsSection').style.display = section === 'clients' ? 'block' : 'none';
            document.getElementById('workersSection').style.display = section === 'workers' ? 'block' : 'none';
            document.getElementById('earningsSection').style.display = section === 'earnings' ? 'block' : 'none';

            // Load section data
            if (section === 'clients') {
                loadClients();
            } else if (section === 'workers') {
                loadWorkers();
            } else if (section === 'earnings') {
                updateStats();
            }
        }

        function switchJobTab(tab) {
            // Update active tab
            document.querySelectorAll('[data-tab]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            loadJobs(tab);
        }

        function loadJobs(filterTab = 'all') {
            const grid = document.getElementById('jobsGrid');
            let jobs = db.load('jobs');

            // Apply filter based on tab
            switch (filterTab) {
                case 'active':
                    jobs = jobs.filter(j => j.status === 'in-progress');
                    break;
                case 'upcoming':
                    jobs = jobs.filter(j => j.status === 'scheduled' || j.status === 'pending');
                    break;
                case 'completed':
                    jobs = jobs.filter(j => j.status === 'completed');
                    break;
                default:
                    // 'all' - no filter
                    break;
            }

            if (jobs.length === 0) {
                const emptyMessage = filterTab === 'all' ? 
                    'No Jobs Found' : 
                    `No ${filterTab.charAt(0).toUpperCase() + filterTab.slice(1)} Jobs`;
                    
                grid.innerHTML = `
                    <div class="job-card" style="text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ðŸ“‹</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">${emptyMessage}</h3>
                        <p style="color: #98bfa7; margin-bottom: 20px;">
                            ${filterTab === 'all' ? 'Get started by adding your first job!' : `No jobs match the ${filterTab} filter.`}
                        </p>
                        ${filterTab === 'all' ? '<button onclick="showAddJobModal()" class="button">+ Add Your First Job</button>' : ''}
                    </div>
                `;
                return;
            }

            // Display jobs with full functionality
            grid.innerHTML = jobs.map(job => `
                <div class="job-card">
                    <div class="job-title">${job.title}</div>
                    <div class="job-status status-${job.status}">${getStatusText(job.status)}</div>
                    <div class="job-info">
                        <div class="job-info-item">
                            <span>Client:</span>
                            <strong>${job.clientName || 'Not assigned'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Rate:</span>
                            <strong>$${job.hourlyRate || '0'}/hr</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Priority:</span>
                            <strong style="color: ${getPriorityColor(job.priority)}">${job.priority ? job.priority.toUpperCase() : 'MEDIUM'}</strong>
                        </div>
                        <div class="job-info-item">
                            <span>Estimated:</span>
                            <strong>${job.estimatedHours || 0}h</strong>
                        </div>
                        ${job.scheduledDate ? `
                            <div class="job-info-item">
                                <span>Scheduled:</span>
                                <strong>${formatDateTime(job.scheduledDate)}</strong>
                            </div>
                        ` : ''}
                        ${job.address ? `
                            <div class="job-info-item">
                                <span>Address:</span>
                                <strong><a href="#" onclick="openInMaps('${job.address.replace(/'/g, "\\'")}'); return false;" style="color: #19a974; text-decoration: underline; cursor: pointer;" title="Click to open in Google Maps">${job.address}</a></strong>
                            </div>
                        ` : ''}
                        ${job.description ? `
                            <div style="margin-top: 10px; padding: 10px; background: #1f2a1f; border-radius: 6px;">
                                <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Description:</div>
                                <div style="color: #e6ffee; font-size: 14px;">${job.description}</div>
                            </div>
                        ` : ''}
                        ${job.notes ? `
                            <div style="margin-top: 8px; padding: 8px; background: #1f2a1f; border-radius: 6px;">
                                <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Notes:</div>
                                <div style="color: #e6ffee; font-size: 14px;">${job.notes}</div>
                            </div>
                        ` : ''}
                        ${job.totalHours > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: #1f2a1f; border-radius: 6px; border-left: 4px solid #19a974;">
                                <div style="color: #98bfa7; font-size: 12px; margin-bottom: 5px;">Time Worked:</div>
                                <div style="color: #19a974; font-weight: 600;">${job.totalHours.toFixed(2)} hours â€¢ $${(job.totalEarnings || 0).toFixed(2)} earned</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Active Timer Display -->
                    <div id="timer-${job.id}" style="display: none; margin-top: 15px; padding: 15px; background: #28a745; border-radius: 8px; text-align: center;">
                        <div style="color: white; font-weight: 600; margin-bottom: 5px;">â±ï¸ TIMER RUNNING</div>
                        <div class="job-timer-display" data-job-id="${job.id}" style="color: white; font-size: 1.5rem; font-weight: 700; font-family: monospace;">00:00:00</div>
                        <div style="margin-top: 10px;">
                            <button onclick="pauseJobTimer(${job.id})" class="button" style="background: #ffc107; color: #000; margin-right: 10px;">â¸ï¸ Pause</button>
                            <button onclick="stopJobTimer(${job.id})" class="button" style="background: #28a745;">âœ… Complete</button>
                        </div>
                    </div>
                    
                    <div class="job-actions" style="margin-top: 15px;">
                        ${job.status !== 'completed' ? `
                            <button onclick="startJobTimer(${job.id})" class="button" style="background: #28a745;" id="start-btn-${job.id}">â–¶ï¸ Start Job</button>
                        ` : ''}
                        <button onclick="showEditJobModal(${job.id})" class="button button-secondary">âœï¸ Edit</button>
                        <button class="button button-secondary comments-btn" data-job-id="${job.id}">ðŸ’¬ Comments</button>
                        <button onclick="deleteJob(${job.id})" class="button button-danger">ðŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `).join('');
            // After rendering job cards, attach event listeners to the comments buttons.
            // Inline onclick handlers can be unreliable depending on script scope,
            // so we attach event listeners here to ensure the chat modal opens when clicked.
            const commentButtons = document.querySelectorAll('.comments-btn');
            commentButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Extract the job ID from the data attribute and open chat modal
                    const jobIdAttr = btn.getAttribute('data-job-id');
                    const jobIdNum = jobIdAttr ? parseInt(jobIdAttr, 10) : NaN;
                    if (!isNaN(jobIdNum)) {
                        showJobChatModal(jobIdNum);
                    }
                });
            });
        }

        function switchClientSection(section) {
            // Update active tab
            document.querySelectorAll('[data-client-section]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-client-section="${section}"]`).classList.add('active');

            // Show/hide sections
            document.getElementById('clientServicesSection').style.display = section === 'services' ? 'block' : 'none';
            document.getElementById('clientBrowseSection').style.display = section === 'browse' ? 'block' : 'none';
            document.getElementById('clientEstimatesSection').style.display = section === 'estimates' ? 'block' : 'none';
            document.getElementById('clientProfileSection').style.display = section === 'profile' ? 'block' : 'none';
        }

        function switchClientTab(tab) {
            // Update active tab
            document.querySelectorAll('[data-client-tab]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-client-tab="${tab}"]`).classList.add('active');

            loadClientServices();
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '10000';
            successDiv.style.maxWidth = '300px';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
        }

        // Phone integration functions
        function callHandyman() {
            window.location.href = 'tel:+15551234567';
        }

        function textHandyman() {
            window.location.href = 'sms:+15551234567';
        }

        // Maps integration function
        function openInMaps(address) {
            if (!address) {
                alert('No address available');
                return;
            }
            
            console.log('ðŸ—ºï¸ Opening address in maps:', address);
            
            // Encode the address for URL
            const encodedAddress = encodeURIComponent(address);
            
            // Try to detect if we're on mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // On mobile, try to open native maps app first
                const mapsUrl = `https://maps.google.com/maps?q=${encodedAddress}`;
                window.open(mapsUrl, '_blank');
            } else {
                // On desktop, open Google Maps in new tab
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
                window.open(mapsUrl, '_blank');
            }
        }

        // ===== DEBUG FUNCTIONS =====
        
        function testLocationSystem() {
            console.log('ðŸ§ª Testing location system...');
            
            // Test with different locations
            const testLocations = [
                { name: 'St. George Center', lat: 37.0965, lng: -113.5684, shouldBeInside: true },
                { name: 'Cedar City Center', lat: 37.6781, lng: -113.0618, shouldBeInside: true },
                { name: 'Las Vegas (Outside)', lat: 36.1699, lng: -115.1398, shouldBeInside: false },
                { name: 'Salt Lake City (Outside)', lat: 40.7608, lng: -111.8910, shouldBeInside: false }
            ];
            
            let testIndex = 0;
            
            function runNextTest() {
                if (testIndex >= testLocations.length) {
                    console.log('âœ… Location testing complete');
                    showSuccess('Location testing complete! Check console for details.');
                    return;
                }
                
                const testLocation = testLocations[testIndex];
                console.log(`ðŸ§ª Testing location: ${testLocation.name}`);
                
                // Temporarily set location
                currentLocation = {
                    lat: testLocation.lat,
                    lng: testLocation.lng,
                    accuracy: 10,
                    timestamp: new Date().toISOString(),
                    isTest: true
                };
                
                checkGeofenceStatus();
                
                const actualInside = isInsideGeofence;
                const expectedInside = testLocation.shouldBeInside;
                
                if (actualInside === expectedInside) {
                    console.log(`âœ… ${testLocation.name}: PASS (${actualInside ? 'inside' : 'outside'})`);
                } else {
                    console.log(`âŒ ${testLocation.name}: FAIL (expected ${expectedInside ? 'inside' : 'outside'}, got ${actualInside ? 'inside' : 'outside'})`);
                }
                
                testIndex++;
                setTimeout(runNextTest, 2000);
            }
            
            runNextTest();
        }
        
        function testNotificationSystem() {
            console.log('ðŸ§ª Testing notification system...');
            
            // Create a test request
            const testRequest = {
                type: 'estimate',
                title: 'Test Notification Request',
                description: 'This is a test request to verify the notification system is working properly.',
                urgency: 'high',
                preferredDate: new Date().toISOString(),
                clientName: 'Test Client',
                clientId: 'test-client-123'
            };
            
            console.log('ðŸ“ Creating test request:', testRequest);
            
            const savedRequest = db.addClientRequest(testRequest);
            console.log('ðŸ’¾ Test request saved:', savedRequest);
            
            // Force update notification count
            setTimeout(() => {
                const count = db.updateNotificationCount();
                console.log(`ðŸ”” Current notification count: ${count}`);
                
                if (count > 0) {
                    showSuccess(`Test notification created! Badge shows ${count} notifications.`);
                } else {
                    showError(document.createElement('div'), 'Test notification failed - check console for details');
                }
            }, 500);
        }

        // ===== MODAL AND FORM FUNCTIONS =====
        
        // Job Management Functions
        function showAddJobModal() {
            populateClientDropdown('jobClient');
            document.getElementById('addJobModal').style.display = 'flex';
        }
        
        function closeAddJobModal() {
            document.getElementById('addJobModal').style.display = 'none';
            clearJobForm();
        }
        
        function saveNewJob() {
            const title = document.getElementById('jobTitle').value.trim();
            const clientId = document.getElementById('jobClient').value;
            const description = document.getElementById('jobDescription').value.trim();
            const hourlyRate = parseFloat(document.getElementById('jobHourlyRate').value) || 0;
            const estimatedHours = parseFloat(document.getElementById('jobEstimatedHours').value) || 0;
            const priority = document.getElementById('jobPriority').value;
            const scheduledDate = document.getElementById('jobScheduledDate').value;
            const status = document.getElementById('jobStatus').value;
            const street = document.getElementById('jobStreet').value.trim();
            const city = document.getElementById('jobCity').value.trim();
            const state = document.getElementById('jobState').value;
            const zipcode = document.getElementById('jobZipcode').value.trim();
            const notes = document.getElementById('jobNotes').value.trim();
            
            if (!title || !clientId) {
                alert('Please enter a job title and select a client');
                return;
            }
            
            const clients = db.load('clients');
            const client = clients.find(c => c.id == clientId);
            
            // Build full address if components are provided
            let fullAddress = '';
            if (street || city || state || zipcode) {
                const addressParts = [];
                if (street) addressParts.push(street);
                if (city) addressParts.push(city);
                if (state && zipcode) addressParts.push(`${state} ${zipcode}`);
                else if (state) addressParts.push(state);
                else if (zipcode) addressParts.push(zipcode);
                fullAddress = addressParts.join(', ');
            }
            
            const jobs = db.load('jobs');
            const newJob = {
                id: Date.now(),
                title: title,
                clientId: parseInt(clientId),
                clientName: client ? client.name : 'Unknown Client',
                description: description,
                hourlyRate: hourlyRate,
                estimatedHours: estimatedHours,
                priority: priority,
                scheduledDate: scheduledDate,
                status: status,
                street: street,
                city: city,
                state: state,
                zipcode: zipcode,
                address: fullAddress,
                notes: notes,
                totalHours: 0,
                totalEarnings: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            jobs.push(newJob);
            db.save('jobs', jobs);
            
            closeAddJobModal();
            loadJobs();
            updateStats();
            showSuccess('Job created successfully!');
        }
        
        function showEditJobModal(jobId) {
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === jobId);
            
            if (!job) {
                alert('Job not found');
                return;
            }
            
            // Populate form with job data
            document.getElementById('editJobTitle').value = job.title || '';
            document.getElementById('editJobDescription').value = job.description || '';
            document.getElementById('editJobHourlyRate').value = job.hourlyRate || '';
            document.getElementById('editJobEstimatedHours').value = job.estimatedHours || '';
            document.getElementById('editJobPriority').value = job.priority || 'medium';
            document.getElementById('editJobScheduledDate').value = job.scheduledDate || '';
            document.getElementById('editJobStatus').value = job.status || 'pending';
            document.getElementById('editJobStreet').value = job.street || '';
            document.getElementById('editJobCity').value = job.city || '';
            document.getElementById('editJobState').value = job.state || '';
            document.getElementById('editJobZipcode').value = job.zipcode || '';
            document.getElementById('editJobNotes').value = job.notes || '';
            
            populateClientDropdown('editJobClient');
            document.getElementById('editJobClient').value = job.clientId || '';
            
            // Store job ID for update
            document.getElementById('editJobModal').dataset.jobId = jobId;
            document.getElementById('editJobModal').style.display = 'flex';
        }
        
        function closeEditJobModal() {
            document.getElementById('editJobModal').style.display = 'none';
        }
        
        function updateJob() {
            const jobId = parseInt(document.getElementById('editJobModal').dataset.jobId);
            const jobs = db.load('jobs');
            const jobIndex = jobs.findIndex(j => j.id === jobId);
            
            if (jobIndex === -1) {
                alert('Job not found');
                return;
            }
            
            const title = document.getElementById('editJobTitle').value.trim();
            const clientId = document.getElementById('editJobClient').value;
            const street = document.getElementById('editJobStreet').value.trim();
            const city = document.getElementById('editJobCity').value.trim();
            const state = document.getElementById('editJobState').value;
            const zipcode = document.getElementById('editJobZipcode').value.trim();
            
            if (!title || !clientId) {
                alert('Please enter a job title and select a client');
                return;
            }
            
            const clients = db.load('clients');
            const client = clients.find(c => c.id == clientId);
            
            // Build full address if components are provided
            let fullAddress = '';
            if (street || city || state || zipcode) {
                const addressParts = [];
                if (street) addressParts.push(street);
                if (city) addressParts.push(city);
                if (state && zipcode) addressParts.push(`${state} ${zipcode}`);
                else if (state) addressParts.push(state);
                else if (zipcode) addressParts.push(zipcode);
                fullAddress = addressParts.join(', ');
            }
            
            // Update job
            jobs[jobIndex] = {
                ...jobs[jobIndex],
                title: title,
                clientId: parseInt(clientId),
                clientName: client ? client.name : 'Unknown Client',
                description: document.getElementById('editJobDescription').value.trim(),
                hourlyRate: parseFloat(document.getElementById('editJobHourlyRate').value) || 0,
                estimatedHours: parseFloat(document.getElementById('editJobEstimatedHours').value) || 0,
                priority: document.getElementById('editJobPriority').value,
                scheduledDate: document.getElementById('editJobScheduledDate').value,
                status: document.getElementById('editJobStatus').value,
                street: street,
                city: city,
                state: state,
                zipcode: zipcode,
                address: fullAddress,
                notes: document.getElementById('editJobNotes').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            db.save('jobs', jobs);
            closeEditJobModal();
            loadJobs();
            updateStats();
            showSuccess('Job updated successfully!');
        }
        
        function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
            }
            
            const jobs = db.load('jobs');
            const filteredJobs = jobs.filter(j => j.id !== jobId);
            
            if (db.save('jobs', filteredJobs)) {
                loadJobs();
                updateStats();
                showSuccess('Job deleted successfully!');
            } else {
                alert('Failed to delete job. Please try again.');
            }
        }
        
        function clearJobForm() {
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobClient').value = '';
            document.getElementById('jobDescription').value = '';
            document.getElementById('jobHourlyRate').value = '';
            document.getElementById('jobEstimatedHours').value = '';
            document.getElementById('jobPriority').value = 'medium';
            document.getElementById('jobScheduledDate').value = '';
            document.getElementById('jobStatus').value = 'pending';
            document.getElementById('jobStreet').value = '';
            document.getElementById('jobCity').value = '';
            document.getElementById('jobState').value = '';
            document.getElementById('jobZipcode').value = '';
            document.getElementById('jobNotes').value = '';
        }
        
        // Client Management Functions
        function showAddClientModal() {
            document.getElementById('addClientModal').style.display = 'flex';
        }
        
        function closeAddClientModal() {
            document.getElementById('addClientModal').style.display = 'none';
            clearClientForm();
        }
        
        function saveNewClient() {
            const firstName = document.getElementById('clientFirstName').value.trim();
            const lastName = document.getElementById('clientLastName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const type = document.getElementById('clientType').value;
            const street = document.getElementById('clientStreet').value.trim();
            const city = document.getElementById('clientCity').value.trim();
            const state = document.getElementById('clientState').value;
            const zipcode = document.getElementById('clientZipcode').value.trim();
            const notes = document.getElementById('clientNotes').value.trim();
            
            // Validate required fields
            if (!firstName || !lastName || !phone || !street || !city || !state || !zipcode) {
                showSuccess('âš ï¸ Please fill in all required fields: name, phone, and complete address');
                return;
            }

            // Normalize and validate phone number: strip non-digits and require at least 10 digits
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 10) {
                showSuccess('âš ï¸ Please enter a valid phone number (at least 10 digits).');
                return;
            }

            // Simple email validation if provided
            if (email && !/^\S+@\S+\.\S+$/.test(email)) {
                showSuccess('âš ï¸ Please enter a valid email address.');
                return;
            }

            const clients = db.load('clients');
            // Prevent duplicate clients by checking name, phone, or email
            const duplicate = clients.some(c => {
                return (
                    c.firstName.toLowerCase() === firstName.toLowerCase() &&
                    c.lastName.toLowerCase() === lastName.toLowerCase()
                ) || (c.phone && c.phone.replace(/\D/g, '') === phoneDigits) || (email && c.email && c.email.toLowerCase() === email.toLowerCase());
            });
            if (duplicate) {
                showSuccess('âš ï¸ A client with the same name, phone number, or email already exists.');
                return;
            }

            const fullAddress = `${street}, ${city}, ${state} ${zipcode}`;
            const newClient = {
                id: Date.now(),
                name: `${firstName} ${lastName}`,
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phoneDigits,
                type: type,
                street: street,
                city: city,
                state: state,
                zipcode: zipcode,
                address: fullAddress,
                notes: notes,
                totalJobs: 0,
                totalSpent: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            clients.push(newClient);
            db.save('clients', clients);

            closeAddClientModal();
            loadClients();
            showSuccess('Client added successfully!');
        }
        
        function clearClientForm() {
            document.getElementById('clientFirstName').value = '';
            document.getElementById('clientLastName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientType').value = 'residential';
            document.getElementById('clientStreet').value = '';
            document.getElementById('clientCity').value = '';
            document.getElementById('clientState').value = '';
            document.getElementById('clientZipcode').value = '';
            document.getElementById('clientNotes').value = '';
        }
        
        // Worker Management Functions
        function showAddWorkerModal() {
            populateWorkerDropdown('goalWorker');
            document.getElementById('addWorkerModal').style.display = 'flex';
        }
        
        function closeAddWorkerModal() {
            document.getElementById('addWorkerModal').style.display = 'none';
            clearWorkerForm();
            
            // Reset modal to add mode
            document.querySelector('#addWorkerModal .modal-title').textContent = 'ðŸ‘· Add New Worker';
            document.querySelector('#addWorkerModal button[onclick*="Worker"]').textContent = 'Add Worker';
            document.querySelector('#addWorkerModal button[onclick*="Worker"]').onclick = saveNewWorker;
        }
        
        function saveNewWorker() {
            const firstName = document.getElementById('workerFirstName').value.trim();
            const lastName = document.getElementById('workerLastName').value.trim();
            const email = document.getElementById('workerEmail').value.trim();
            const phone = document.getElementById('workerPhone').value.trim();
            const hourlyRate = parseFloat(document.getElementById('workerHourlyRate').value);
            const skills = document.getElementById('workerSkills').value.trim();
            const hireDate = document.getElementById('workerHireDate').value;
            const status = document.getElementById('workerStatus').value;
            
            if (!firstName || !lastName || !email || !phone || !hourlyRate) {
                alert('Please fill in all required fields');
                return;
            }
            
            const workers = db.load('workers');
            const newWorker = {
                id: Date.now(),
                name: `${firstName} ${lastName}`,
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                hourlyRate: hourlyRate,
                skills: skills ? skills.split(',').map(s => s.trim()) : [],
                hireDate: hireDate || new Date().toISOString().split('T')[0],
                status: status,
                totalEarnings: 0,
                hoursWorked: 0,
                jobsCompleted: 0,
                currentlyWorking: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            workers.push(newWorker);
            db.save('workers', workers);
            
            closeAddWorkerModal();
            loadWorkers();
            showSuccess('Worker added successfully!');
        }
        
        function updateWorker(workerId) {
            const firstName = document.getElementById('workerFirstName').value.trim();
            const lastName = document.getElementById('workerLastName').value.trim();
            const email = document.getElementById('workerEmail').value.trim();
            const phone = document.getElementById('workerPhone').value.trim();
            const hourlyRate = parseFloat(document.getElementById('workerHourlyRate').value);
            const skills = document.getElementById('workerSkills').value.trim();
            const hireDate = document.getElementById('workerHireDate').value;
            const status = document.getElementById('workerStatus').value;
            
            if (!firstName || !lastName || !email || !phone || !hourlyRate) {
                alert('Please fill in all required fields');
                return;
            }
            
            const workers = db.load('workers');
            const workerIndex = workers.findIndex(w => w.id === workerId);
            
            if (workerIndex === -1) {
                alert('Worker not found');
                return;
            }
            
            workers[workerIndex] = {
                ...workers[workerIndex],
                name: `${firstName} ${lastName}`,
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                hourlyRate: hourlyRate,
                skills: skills ? skills.split(',').map(s => s.trim()) : [],
                hireDate: hireDate,
                status: status,
                updatedAt: new Date().toISOString()
            };
            
            db.save('workers', workers);
            closeAddWorkerModal();
            loadWorkers();
            showSuccess('Worker updated successfully!');
        }
        
        function clearWorkerForm() {
            document.getElementById('workerFirstName').value = '';
            document.getElementById('workerLastName').value = '';
            document.getElementById('workerEmail').value = '';
            document.getElementById('workerPhone').value = '';
            document.getElementById('workerHourlyRate').value = '';
            document.getElementById('workerSkills').value = '';
            document.getElementById('workerHireDate').value = '';
            document.getElementById('workerStatus').value = 'active';
        }
        
        // Goals Management Functions
        function showManageGoalsModal() {
            populateWorkerDropdown('goalWorker');
            loadGoalsList();
            document.getElementById('manageGoalsModal').style.display = 'flex';
        }
        
        function closeManageGoalsModal() {
            document.getElementById('manageGoalsModal').style.display = 'none';
            hideAddGoalForm();
        }
        
        function showAddGoalForm() {
            document.getElementById('addGoalForm').style.display = 'block';
        }
        
        function hideAddGoalForm() {
            document.getElementById('addGoalForm').style.display = 'none';
            clearGoalForm();
        }
        
        function saveNewGoal() {
            const title = document.getElementById('goalTitle').value.trim();
            const workerId = document.getElementById('goalWorker').value;
            const type = document.getElementById('goalType').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const period = document.getElementById('goalPeriod').value;
            
            if (!title || !target) {
                alert('Please enter a goal title and target amount');
                return;
            }
            
            const goals = db.load('workerGoals');
            const newGoal = {
                id: Date.now(),
                title: title,
                workerId: workerId ? parseInt(workerId) : null,
                type: type,
                target: target,
                current: 0,
                period: period,
                startDate: new Date().toISOString(),
                endDate: calculateEndDate(period),
                active: true,
                createdAt: new Date().toISOString()
            };
            
            goals.push(newGoal);
            db.save('workerGoals', goals);
            
            hideAddGoalForm();
            loadGoalsList();
            loadGoalsProgress();
            showSuccess('Goal created successfully!');
        }
        
        function calculateEndDate(period) {
            const now = new Date();
            switch (period) {
                case 'weekly':
                    return new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                case 'monthly':
                    return new Date(now.getFullYear(), now.getMonth() + 1, now.getDate()).toISOString();
                case 'quarterly':
                    return new Date(now.getFullYear(), now.getMonth() + 3, now.getDate()).toISOString();
                case 'yearly':
                    return new Date(now.getFullYear() + 1, now.getMonth(), now.getDate()).toISOString();
                default:
                    return new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();
            }
        }
        
        function loadGoalsList() {
            const goals = db.load('workerGoals');
            const workers = db.load('workers');
            const container = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #98bfa7;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ðŸŽ¯</div>
                        <h3 style="color: #19a974; margin-bottom: 10px;">No Goals Set</h3>
                        <p>Create your first goal to start tracking progress!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = goals.map(goal => {
                const worker = goal.workerId ? workers.find(w => w.id === goal.workerId) : null;
                const percentage = Math.min((goal.current / goal.target) * 100, 100);
                const isOverTarget = goal.current > goal.target;
                
                return `
                    <div class="job-card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div class="job-title">${goal.title}</div>
                                <div style="color: #98bfa7; font-size: 14px;">
                                    ${worker ? `Assigned to: ${worker.name}` : 'Company-wide goal'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <span class="job-status ${goal.active ? 'status-in-progress' : 'status-completed'}">
                                    ${goal.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="goal-progress" style="margin-bottom: 15px;">
                            <div class="goal-header">
                                <div style="color: #98bfa7;">Progress: ${percentage.toFixed(1)}%</div>
                                <div style="color: #98bfa7;">${goal.current} / ${goal.target} ${goal.type === 'revenue' ? '$' : goal.type === 'hours' ? 'hrs' : ''}</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%; ${isOverTarget ? 'background: linear-gradient(90deg, #28a745, #20c997);' : ''}"></div>
                            </div>
                            <div class="goal-details">
                                <span>${goal.type.charAt(0).toUpperCase() + goal.type.slice(1)} Goal</span>
                                <span>${goal.period} period</span>
                            </div>
                            ${isOverTarget ? '<div style="color: #28a745; font-size: 12px; margin-top: 5px;">ðŸŽ‰ Goal exceeded!</div>' : ''}
                        </div>
                        
                        <div class="job-actions">
                            <button onclick="toggleGoalStatus(${goal.id})" class="button button-secondary">
                                ${goal.active ? 'â¸ï¸ Deactivate' : 'â–¶ï¸ Activate'}
                            </button>
                            <button onclick="deleteGoal(${goal.id})" class="button button-danger">ðŸ—‘ï¸ Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleGoalStatus(goalId) {
            const goals = db.load('workerGoals');
            const goalIndex = goals.findIndex(g => g.id === goalId);
            
            if (goalIndex !== -1) {
                goals[goalIndex].active = !goals[goalIndex].active;
                db.save('workerGoals', goals);
                loadGoalsList();
                loadGoalsProgress();
                showSuccess(`Goal ${goals[goalIndex].active ? 'activated' : 'deactivated'}!`);
            }
        }
        
        function deleteGoal(goalId) {
            if (!confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
                return;
            }
            
            const goals = db.load('workerGoals');
            const filteredGoals = goals.filter(g => g.id !== goalId);
            
            db.save('workerGoals', filteredGoals);
            loadGoalsList();
            loadGoalsProgress();
            showSuccess('Goal deleted successfully!');
        }
        
        function clearGoalForm() {
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalWorker').value = '';
            document.getElementById('goalType').value = 'revenue';
            document.getElementById('goalTarget').value = '';
            document.getElementById('goalPeriod').value = 'monthly';
        }
        
        // Utility Functions
        function populateClientDropdown(selectId) {
            const clients = db.load('clients');
            const select = document.getElementById(selectId);
            
            if (select) {
                select.innerHTML = '<option value="">Select a client</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
            }
        }
        
        function populateWorkerDropdown(selectId) {
            const workers = db.load('workers');
            const select = document.getElementById(selectId);
            
            if (select) {
                select.innerHTML = '<option value="">Company-wide goal</option>';
                workers.forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = worker.name;
                    select.appendChild(option);
                });
            }
        }

        // ===== CLOUD SETUP FUNCTIONS =====
        
        function showCloudSetupModal() {
            console.log('â˜ï¸ Opening cloud setup modal...');
            
            // Load existing config if available
            loadExistingFirebaseConfig();
            
            // Update cloud status
            updateCloudStatus();
            
            document.getElementById('cloudSetupModal').style.display = 'flex';
        }
        
        function closeCloudSetupModal() {
            document.getElementById('cloudSetupModal').style.display = 'none';
        }
        
        function loadExistingFirebaseConfig() {
            try {
                const saved = localStorage.getItem('firebaseConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    
                    document.getElementById('firebaseApiKey').value = config.apiKey || '';
                    document.getElementById('firebaseAuthDomain').value = config.authDomain || '';
                    document.getElementById('firebaseProjectId').value = config.projectId || '';
                    document.getElementById('firebaseStorageBucket').value = config.storageBucket || '';
                    document.getElementById('firebaseMessagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('firebaseAppId').value = config.appId || '';
                    
                    console.log('âœ… Loaded existing Firebase configuration');
                }
            } catch (error) {
                console.error('âŒ Failed to load existing config:', error);
            }
        }
        
        function updateCloudStatus() {
            const statusDiv = document.getElementById('cloudStatus');
            const saved = localStorage.getItem('firebaseConfig');
            
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    if (config.apiKey && config.projectId && config.apiKey !== 'your-api-key-here') {
                        statusDiv.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 5px;">âœ… Cloud Storage: Enabled</div>
                            <div style="font-size: 14px;">Connected to Firebase project: ${config.projectId}</div>
                        `;
                        statusDiv.style.background = '#28a745';
                        return;
                    }
                } catch (error) {
                    console.error('âŒ Invalid saved config:', error);
                }
            }
            
            statusDiv.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">âŒ Cloud Storage: Disabled</div>
                <div style="font-size: 14px;">Currently using local storage only. Set up Firebase to enable cloud sync.</div>
            `;
            statusDiv.style.background = '#dc3545';
        }
        
        function testFirebaseConnection() {
            console.log('ðŸ§ª Testing Firebase connection...');
            
            const config = getFirebaseConfigFromForm();
            if (!config) return;
            
            const testDiv = document.getElementById('connectionTest');
            testDiv.style.display = 'block';
            testDiv.innerHTML = `
                <div style="background: #ffc107; color: #000; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">ðŸ§ª Testing Connection...</div>
                    <div style="font-size: 14px;">Attempting to connect to Firebase...</div>
                </div>
            `;
            
            // Simulate connection test (in real implementation, this would use Firebase SDK)
            setTimeout(() => {
                if (config.apiKey && config.projectId && config.authDomain && config.appId) {
                    testDiv.innerHTML = `
                        <div style="background: #28a745; color: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">âœ… Connection Successful!</div>
                            <div style="font-size: 14px;">
                                Successfully connected to Firebase project: <strong>${config.projectId}</strong><br>
                                Ready to enable cloud sync!
                            </div>
                        </div>
                    `;
                    console.log('âœ… Firebase connection test passed');
                } else {
                    testDiv.innerHTML = `
                        <div style="background: #dc3545; color: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 5px;">âŒ Connection Failed</div>
                            <div style="font-size: 14px;">
                                Please check your configuration. Required fields: API Key, Project ID, Auth Domain, and App ID.
                            </div>
                        </div>
                    `;
                    console.log('âŒ Firebase connection test failed - missing required fields');
                }
            }, 2000);
        }
        
        function saveFirebaseConfig() {
            console.log('ðŸ’¾ Saving Firebase configuration...');
            
            const config = getFirebaseConfigFromForm();
            if (!config) return;
            
            if (!config.apiKey || !config.projectId || !config.authDomain || !config.appId) {
                alert('Please fill in all required fields (API Key, Auth Domain, Project ID, and App ID)');
                return;
            }
            
            try {
                // Save configuration
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // Update status
                updateCloudStatus();
                
                // Show success message
                showSuccess('Firebase configuration saved! Cloud sync is now enabled.');
                
                // Update database status indicator
                const dbStatus = document.getElementById('dbStatus');
                if (dbStatus) {
                    dbStatus.textContent = 'â˜ï¸ Cloud Enabled';
                    dbStatus.className = 'db-status';
                    dbStatus.style.display = 'block';
                }
                
                console.log('âœ… Firebase configuration saved successfully');
                
                // Close modal after short delay
                setTimeout(() => {
                    closeCloudSetupModal();
                }, 2000);
                
            } catch (error) {
                console.error('âŒ Failed to save Firebase config:', error);
                alert('Failed to save configuration. Please try again.');
            }
        }
        
        function getFirebaseConfigFromForm() {
            const apiKey = document.getElementById('firebaseApiKey').value.trim();
            const authDomain = document.getElementById('firebaseAuthDomain').value.trim();
            const projectId = document.getElementById('firebaseProjectId').value.trim();
            const storageBucket = document.getElementById('firebaseStorageBucket').value.trim();
            const messagingSenderId = document.getElementById('firebaseMessagingSenderId').value.trim();
            const appId = document.getElementById('firebaseAppId').value.trim();
            
            return {
                apiKey: apiKey,
                authDomain: authDomain,
                projectId: projectId,
                storageBucket: storageBucket,
                messagingSenderId: messagingSenderId,
                appId: appId
            };
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'971d10dc43c17ee9',t:'MTc1NTY0MjMxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<!-- ADMIN GUARD -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  const auth = getAuth();
  const btn = document.getElementById("roleMgrFab");
  if (btn) btn.classList.add("hidden"); // default hidden

  async function showIfAdmin(user){
    if (!btn) return;
    if (!user){ btn.classList.add("hidden"); return; }
    try {
      const tok = await user.getIdTokenResult(true);
      const isAdmin = tok?.claims?.role === "admin";
      btn.classList.toggle("hidden", !isAdmin);
    } catch(e){ btn.classList.add("hidden"); }
  }

  onAuthStateChanged(auth, showIfAdmin);
</script>

<div id="safeBottomSpacer"></div>

<!-- ADMIN GUARD: show role bar only for admins -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  const auth = getAuth();
  const bar = document.getElementById('roleBar');
  const btn = document.getElementById('roleMgrFab');
  function hide(){ bar && bar.classList.add('hidden'); }
  onAuthStateChanged(auth, async (user) => {
    if (!user) return hide();
    try {
      const tok = await user.getIdTokenResult(true);
      const isAdmin = tok?.claims?.role === 'admin';
      if (bar) bar.classList.toggle('hidden', !isAdmin);
    } catch(e){ hide(); }
  });
</script>


<!-- SAFE-AREA FALLBACK JS -->
<script>
(function(){
  const root = document.documentElement;
  function applyInsets(){
    const vv = window.visualViewport;
    if (!vv) return;
    const topInset = Math.max(0, Math.round(vv.offsetTop||0));
    const bottomGap = Math.max(0, Math.round((vv.height + vv.offsetTop) - window.innerHeight));
    const maxGap = Math.max(topInset, bottomGap, 0);
    root.style.setProperty('--fallback-gap', (24 + maxGap) + 'px');
  }
  applyInsets();
  if (window.visualViewport) { visualViewport.addEventListener('resize', applyInsets); }
  window.addEventListener('orientationchange', applyInsets);
})();
</script>

<script type="module" src="role-manager.js"></script>
<!-- CLIENTLOCK GUARD -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  const auth = getAuth();

  // Known admin-only and client-only sections by ID/attr
  const ADMIN_IDS = ["adminTab","adminPanel","manageRolesButton","roleBar","roleMgrFab"];
  const CLIENT_IDS = ["clientPanel","clientTab"];
  const ROLE_SWITCH_SELECTORS = ["#viewSwitch","#roleSwitcher","#tabsBar",".view-switch",".role-switcher",".view-selector","#chooseView","#viewChooser"];

  function setHiddenByIds(ids, hide){
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("hidden", hide);
    });
  }
  function setHiddenBySelectors(sels, hide){
    sels.forEach(sel => {
      document.querySelectorAll(sel).forEach(el => el.classList.toggle("hidden", hide));
    });
  }
  function hideAll(){
    setHiddenByIds(ADMIN_IDS, true);
    setHiddenByIds(CLIENT_IDS, true);
    setHiddenBySelectors(ROLE_SWITCH_SELECTORS, true);
    document.querySelectorAll("[data-admin-only]").forEach(el => el.classList.add("hidden"));
    document.querySelectorAll("[data-client-only]").forEach(el => el.classList.add("hidden"));
    document.body?.classList.remove("is-admin","is-client");
  }
  async function getRole(user){
    if (!user) return null;
    try{
      const tok = await user.getIdTokenResult(true); // refresh to get fresh claims
      return tok?.claims?.role || "client";
    }catch(e){ return "client"; }
  }

  onAuthStateChanged(auth, async (user) => {
    hideAll();
    if (!user) return;
    const role = await getRole(user);
    if (role === "admin"){
      // Admin can see admin UI; show role switcher if you have one
      setHiddenByIds(ADMIN_IDS, false);
      setHiddenBySelectors(ROLE_SWITCH_SELECTORS, false);
      // Show client as well if you want admin to preview client UX:
      setHiddenByIds(CLIENT_IDS, false);
      document.querySelectorAll("[data-admin-only]").forEach(el => el.classList.remove("hidden"));
      document.body?.classList.add("is-admin");
    } else {
      // Default: lock to client view only
      setHiddenByIds(CLIENT_IDS, false);
      setHiddenBySelectors(ROLE_SWITCH_SELECTORS, true);
      document.querySelectorAll("[data-client-only]").forEach(el => el.classList.remove("hidden"));
      // Ensure admin-only stays hidden
      document.querySelectorAll("[data-admin-only]").forEach(el => el.classList.add("hidden"));
      document.body?.classList.add("is-client");
      // Optional: auto-scroll to client panel
      const cp = document.getElementById("clientPanel");
      cp && cp.scrollIntoView({behavior:"auto", block:"start"});
    }
    console.log("[clientlock] role =", role);
  });
</script>
<!-- CLIENTLOCK SAFE-AREA FALLBACK -->
<script>
(function(){
  const root = document.documentElement;
  function applyInsets(){
    try{
      const vv = window.visualViewport;
      if (!vv) return;
      const topInset = Math.max(0, Math.round(vv.offsetTop||0));
      const bottomGap = Math.max(0, Math.round((vv.height + vv.offsetTop) - window.innerHeight));
      const bump = Math.max(topInset, bottomGap, 0);
      root.style.setProperty('--fallback-gap', (28 + bump) + 'px');
    }catch(e){}
  }
  applyInsets();
  if (window.visualViewport){ visualViewport.addEventListener('resize', applyInsets); }
  window.addEventListener('orientationchange', applyInsets);
})();
</script>
</body>
</html>



<!-- ================= APP SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
// Import messaging functions for Firebase Cloud Messaging (FCM)
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDgto5b14cf1FATduNMWUn01qxySlD8YiE",
  authDomain: "handyman-c1eee.firebaseapp.com",
  projectId: "handyman-c1eee",
  storageBucket: "handyman-c1eee.firebasestorage.app",
  messagingSenderId: "26293725527",
  appId: "1:26293725527:web:31d81e346d5b1f2dc83612",
  measurementId: "G-5H02SSPNKL"
  // Add your Web Push certificate key pair (VAPID key) here.  This value
  // is required to retrieve FCM tokens for web notifications.  Replace
  // with your own key from the Firebase console under Project Settings > Cloud Messaging.
  , messagingVapidKey: "BGaR2Au9uNoF11BJlRoXm02DjO64gGgTXjfqcKZzzHeML89Di2adOqNMhgRqwOfDMaU90SczrIUX-PuKnf1_01U"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
// Use a distinct variable name for the Firestore instance to avoid
// colliding with the local database helper `db` used elsewhere in
// the application.  This prevents bugs where chat and local
// storage functions accidentally call Firestore methods.
const fsDB = getFirestore(app);

// Initialize Firebase Cloud Messaging.  We use FCM to deliver push
// notifications when jobs are updated or new chat messages arrive.
// The messaging object must be created after the app is initialized.
const messaging = getMessaging(app);

// Expose Firestore helpers on the window object so that non-module scripts
// (like the registration modal handlers) can access them.  Without this,
// functions defined outside of the module cannot reference imported
// variables like `doc` and `setDoc`.
window.fsDB = fsDB;
window.fsDoc = doc;
window.fsSetDoc = setDoc;
window.fsCreateUser = createUserWithEmailAndPassword;
window.fsAuth = auth;

// Register the service worker for handling background notifications.  This
// should be done as soon as possible after the app is initialized.  The
// service worker file (`firebase-messaging-sw.js`) must exist at the root of
// your web server.  If registration fails (e.g. running from file://), the
// promise will reject and no background notifications will be received.
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('firebase-messaging-sw.js')
    .then((registration) => {
      console.log('Service worker registered for FCM with scope:', registration.scope);
    })
    .catch((err) => {
      console.warn('Service worker registration failed:', err);
    });
}

let currentUser = null;

// ====== NOTIFICATION PERMISSION & FCM TOKEN ======
/**
 * Requests permission from the browser to send notifications.  If granted,
 * obtains an FCM registration token for the current device and stores it
 * in the user's Firestore document.  Failures are caught and logged.
 */
async function requestNotificationPermission() {
  try {
    // Ask the user for permission to send browser notifications
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.warn('Notification permission not granted');
      return;
    }
    // Attempt to obtain an FCM token.  A VAPID key may be required; if
    // provided, insert it here.  Without a VAPID key, Firebase will
    // still attempt to generate a token but may fail in some browsers.
    const fcmToken = await getToken(messaging, { vapidKey: firebaseConfig.messagingVapidKey || undefined });
    if (!fcmToken) {
      console.warn('Failed to retrieve FCM token');
      return;
    }
    console.log('FCM Token', fcmToken);
    // Persist the token to the logged in user's Firestore document so it can
    // be used to send targeted notifications from Cloud Functions.  Only
    // attempt this if an authenticated user is available.
    const user = auth.currentUser;
    if (user) {
      await setDoc(doc(fsDB, 'users', user.uid), { fcmToken: fcmToken }, { merge: true });
    }
  } catch (error) {
    console.error('Error obtaining notification permission or FCM token:', error);
  }
}

// Listen for foreground messages.  When a push notification arrives and the
// page is in focus, this handler will run.  You can customize how
// notifications are displayed inside the app here.  The payload will
// typically contain a `notification` object with title and body fields.
onMessage(messaging, (payload) => {
  console.log('Message received in foreground:', payload);
  const notification = payload.notification;
  if (notification && notification.title) {
    // Use the existing toast mechanism to show the notification to the user.
    showSuccess(`${notification.title}: ${notification.body || ''}`);
  }
});

// ====== LOGIN ======
document.getElementById("loginBtn").addEventListener("click", async () => {
  const email = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;
    const userDoc = await getDoc(doc(fsDB, "users", uid));
    if (userDoc.exists()) {
      currentUser = userDoc.data();
      document.getElementById("userName").textContent = currentUser.email;
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      updateDashboard();
    }
  } catch (err) {
    document.getElementById("loginError").style.display = "block";
    document.getElementById("loginError").textContent = err.message;
  }
});

// ====== SIGNUP - NEW CLIENT ======
// Override the old prompt-based sign-up handler.  Instead of using
// prompts, open the registration modal defined in the non-module script.
document.getElementById("showRegisterBtn").addEventListener("click", () => {
  if (typeof window.showRegisterModal === 'function') {
    window.showRegisterModal();
  } else {
    alert('Registration modal is not available. Please contact support.');
  }
});

// ====== SIGNUP - EXISTING CLIENT FIRST LOGIN ======
document.getElementById("showNewClientLoginBtn").addEventListener("click", async () => {
  const email = prompt("Enter your existing email:");
  const password = prompt("Create a password:");
  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(fsDB, "users", userCredential.user.uid), {
      email,
      role: "client",
      firstLogin: true,
      createdAt: new Date().toISOString()
    });
    alert("Existing client account created! You can now log in.");
  } catch (err) {
    alert("Error: " + err.message);
  }
});

// ====== LOGOUT ======
document.getElementById("logoutBtn").addEventListener("click", () => {
  auth.signOut();
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginForm").style.display = "block";
});

// ====== AUTH STATE PERSISTENCE ======
onAuthStateChanged(auth, async (user) => {
  if (user) {
    const userDoc = await getDoc(doc(fsDB, "users", user.uid));
    if (userDoc.exists()) {
      currentUser = userDoc.data();
      // Set UID on currentUser for convenience when storing tokens
      currentUser.uid = user.uid;
      document.getElementById("userName").textContent = currentUser.email;
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      updateDashboard();
      // Request notification permission and register FCM token for this user
      requestNotificationPermission();
    }
  } else {
    document.getElementById("mainApp").style.display = "none";
    document.getElementById("loginForm").style.display = "block";
  }
});

// ====== DASHBOARD UPDATE PLACEHOLDER ======
function updateDashboard() {
  // For now, just show placeholder counts
  document.getElementById("totalJobs").textContent = "0";
  document.getElementById("activeJobs").textContent = "0";
  document.getElementById("completedJobs").textContent = "0";
  document.getElementById("totalEarnings").textContent = "$0.00";
}

        // ===== JOB CHAT FUNCTIONS =====
        let currentChatJobId = null;

        /**
         * Opens the chat modal for a specific job. If the modal does not exist yet, it will be created.
         * @param {number} jobId - The ID of the job for which to show chat
         */
        function showJobChatModal(jobId) {
            // Set the current chat job id before creating or showing the modal
            currentChatJobId = jobId;
            let modal = document.getElementById('jobChatModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'jobChatModal';
                modal.className = 'modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.innerHTML = `
                    <div id="jobChatModalContent" style="background: #0c1a0c; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; color: #e6ffee; position: relative;">
                        <!-- Close button triggers global close function -->
                        <span id="jobChatModalClose" onclick="window.closeJobChatModal()" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px;">&times;</span>
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #19a974;">ðŸ’¬ Job Comments</h3>
                        <div id="jobChatMessages" style="max-height: 300px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #334; padding: 10px; border-radius: 4px; background: #152415; pointer-events: none;"></div>
                        <textarea id="jobChatInput" rows="3" placeholder="Type a message..." style="width: 100%; margin-bottom: 10px; background: #1f2a1f; color: #e6ffee; border: 1px solid #334; border-radius: 4px;"></textarea>
                        <!-- Send button triggers global send function.  Using inline onclick ensures the handler is available -->
                        <button id="jobChatSendBtn" class="button" onclick="window.sendJobChatMessage()" style="width: 100%; background: #19a974;">Send</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'flex';
            }
            // Load existing messages for this job
            renderJobChatMessages();
        }

        /**
         * Renders messages for the current chat job into the chat modal.
         */
        function renderJobChatMessages() {
            const messagesDiv = document.getElementById('jobChatMessages');
            if (!messagesDiv || currentChatJobId === null) return;
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === currentChatJobId);
            if (!job) return;
            if (!job.chat) job.chat = [];
            // Build HTML for messages
            messagesDiv.innerHTML = job.chat.map(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleString();
                return `<div style="margin-bottom: 8px;"><strong style="color: #19a974;">${msg.user}</strong> <span style="color:#6fa07b; font-size: 0.75rem;">${timestamp}</span><br><span style="color:#e6ffee;">${msg.message}</span></div>`;
            }).join('');
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        /**
         * Sends a chat message for the current job and updates the messages view.
         */
        function sendJobChatMessage() {
            const input = document.getElementById('jobChatInput');
            if (!input || currentChatJobId === null) return;
            const text = input.value.trim();
            if (!text) {
                return;
            }
            // Append message to job chat
            const jobs = db.load('jobs');
            const job = jobs.find(j => j.id === currentChatJobId);
            if (!job) return;
            if (!job.chat) job.chat = [];
            job.chat.push({
                user: currentUser && currentUser.name ? currentUser.name : 'Unknown',
                message: text,
                timestamp: new Date().toISOString()
            });
            db.save('jobs', jobs);
            // Clear input and re-render messages
            input.value = '';
            renderJobChatMessages();
        }

        /**
         * Closes the job chat modal.
         */
        function closeJobChatModal() {
            const modal = document.getElementById('jobChatModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Expose chat modal helpers globally so inline onclick handlers can access them.
        // Without assigning these functions to the window object, inline events
        // like `onclick="showJobChatModal(...)"` may not find them, depending
        // on how the script is scoped. Attaching them to the window ensures
        // they are available in the global namespace.
        window.showJobChatModal = showJobChatModal;
        window.renderJobChatMessages = renderJobChatMessages;
        window.sendJobChatMessage = sendJobChatMessage;
        window.closeJobChatModal = closeJobChatModal;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("loading").style.display = "none";
  document.getElementById("loginForm").style.display = "block";
});

// Removed overrides for legacy sign-up buttons.  Event handlers are now set
// directly on the buttons when the registration modal script loads.
</script>



